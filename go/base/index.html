<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Go 语言第一课 | 月落 - Personal Notes</title>
    <meta name="description" content="Web Developer & JS Fancier">
    <link rel="preload stylesheet" href="/notes/assets/style.a3be3ed3.css" as="style">
    
    <script type="module" src="/notes/assets/app.aa7b1128.js"></script>
    <link rel="preload" href="/notes/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/notes/assets/chunks/framework.88002d8f.js">
    <link rel="modulepreload" href="/notes/assets/chunks/theme.df4dcf07.js">
    <link rel="modulepreload" href="/notes/assets/go_base_index.md.a38ba4ed.lean.js">
    <link rel="icon" href="/favicon.ico">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-5a346dfe><!--[--><!--]--><!--[--><span tabindex="-1" data-v-0f60ec36></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-0f60ec36> Skip to content </a><!--]--><!----><header class="VPNav" data-v-5a346dfe data-v-ae24b3ad><div class="VPNavBar has-sidebar" data-v-ae24b3ad data-v-a0fd61f4><div class="container" data-v-a0fd61f4><div class="title" data-v-a0fd61f4><div class="VPNavBarTitle has-sidebar" data-v-a0fd61f4 data-v-86d1bed8><a class="title" href="/notes/" data-v-86d1bed8><!--[--><!--]--><!----><!--[-->Personal Notes<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-a0fd61f4><div class="curtain" data-v-a0fd61f4></div><div class="content-body" data-v-a0fd61f4><!--[--><!--]--><div class="VPNavBarSearch search" data-v-a0fd61f4><!----></div><!----><!----><div class="VPNavBarAppearance appearance" data-v-a0fd61f4 data-v-e6aabb21><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-e6aabb21 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-a0fd61f4 data-v-0394ad82 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/yzqzy" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-a0fd61f4 data-v-40855f84 data-v-9c007e85><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-9c007e85><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-9c007e85><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-9c007e85><div class="VPMenu" data-v-9c007e85 data-v-e7ea1737><!----><!--[--><!--[--><!----><div class="group" data-v-40855f84><div class="item appearance" data-v-40855f84><p class="label" data-v-40855f84>Appearance</p><div class="appearance-action" data-v-40855f84><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-40855f84 data-v-ce54a7d1 data-v-b1685198><span class="check" data-v-b1685198><span class="icon" data-v-b1685198><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-ce54a7d1><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-ce54a7d1><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><div class="group" data-v-40855f84><div class="item social-links" data-v-40855f84><div class="VPSocialLinks social-links-list" data-v-40855f84 data-v-7bc22406><!--[--><a class="VPSocialLink no-icon" href="https://github.com/yzqzy" aria-label="github" target="_blank" rel="noopener" data-v-7bc22406 data-v-f80f8133><svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-a0fd61f4 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-5a346dfe data-v-79c8c1df><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-79c8c1df><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-79c8c1df><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-79c8c1df>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-79c8c1df data-v-1c15a60a><button data-v-1c15a60a>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-5a346dfe data-v-b00e2fdd><div class="curtain" data-v-b00e2fdd></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-b00e2fdd><span class="visually-hidden" id="sidebar-aria-label" data-v-b00e2fdd> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>alg</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/alg/algorithm/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>algorithm</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/alg/algorithm_google/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>algorithm_google</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/alg/javascript/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>javascript</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/alg/leetcode75/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>leetcode75</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/alg/review/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>review</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/alg/training/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>training</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/amo/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>amo</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/amo/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>amo</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>arch</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/arch/design/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>design</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/arch/docker/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>docker</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/arch/domain/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>domain</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/arch/node/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>node</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/arch/pattern/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>pattern</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/arch/typescript/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>typescript</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/bom/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>bom</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/bom/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>bom</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>books</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><section class="VPSidebarItem level-1" data-v-e31bd47b data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h3 class="text" data-v-e31bd47b>MDN</h3><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-2 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/books/MDN/Array/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Array</p><!--]--></a><!----></div><!----></div><!--]--></div></section><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/books/Nodejs/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Nodejs</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/books/%E5%9B%BE%E8%A7%A3HTTP/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>图解HTTP</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/books/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>浏览器工作原理与实践</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>crawler</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/crawler/night_team/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>night_team</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/crawler/tuling/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>tuling</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/css3/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>css3</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/css3/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>css3</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/doc/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>doc</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/doc/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>doc</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/dom/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>dom</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/dom/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>dom</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>ecma_script</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/Built_in_objects/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Built_in_objects</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/closure/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>closure</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/es6/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>es6</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/es_module/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>es_module</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/front_end_optimize/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>front_end_optimize</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/functional/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>functional</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/loss_of_precision/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>loss_of_precision</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/optimize/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>optimize</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/optimize_design_patterns/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>optimize_design_patterns</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/ecma_script/promise/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>promise</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>electron</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/electron/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/electron/combat/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>combat</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/engineering/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>engineering</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/engineering/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>engineering</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1" data-v-e31bd47b data-v-e31bd47b><div class="item" role="button" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><p class="text" data-v-e31bd47b>gulp</p><!----></div><!----></div><div class="VPSidebarItem level-1" data-v-e31bd47b data-v-e31bd47b><div class="item" role="button" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><p class="text" data-v-e31bd47b>yeoman</p><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/eslint/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>eslint</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/eslint/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>eslint</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/fragment/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>fragment</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/fragment/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>fragment</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/fragment/case/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>case</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/git/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>git</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/git/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>git</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 has-active" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>go</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/go/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/go/plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>plus</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/hand_writing/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>hand_writing</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/hand_writing/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>hand_writing</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/hand_writing/vue_source/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_source</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>html5</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/html5/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/html5/canvas/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>canvas</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/html5/interview/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>interview</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/interview/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>interview</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/interview/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>interview</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>jenkins</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/jenkins/jenkins2.x/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>jenkins2.x</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/jenkins/practice/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>practice</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/jest/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>jest</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/jest/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>jest</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>micro_frontends</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/micro_frontends/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/micro_frontends/module_federation/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>module_federation</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/micro_frontends/module_federation_example/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>module_federation_example</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/micro_frontends/source/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>source</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>mysql</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/mysql/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/mysql/plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>plus</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>network</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/network/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/network/plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>plus</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/nginx/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>nginx</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/nginx/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>nginx</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>node</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/node/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/node/core_module/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>core_module</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/node/expand/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>expand</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/node/koa/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>koa</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/node/native-module/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>native-module</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/node/plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>plus</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/node/tars/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>tars</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>npm</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/npm/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/npm/repos/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>repos</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>openai</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/openai/langchain/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>langchain</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/openai/proxy/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>proxy</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>react</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/Fiber/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>Fiber</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/chakra_ui/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>chakra_ui</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/css_in_js/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>css_in_js</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/form_optimize/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>form_optimize</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/formik/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>formik</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/mobx/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>mobx</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/optimize/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>optimize</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/react_base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>react_base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/react_hooks/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>react_hooks</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/react_hooks_plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>react_hooks_plus</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/react_source/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>react_source</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/redux/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>redux</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/react/virtual_dom/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>virtual_dom</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>reg</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/reg/learn/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>learn</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>solid</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/solid/learn/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>learn</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/solid/source_analysis/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>source_analysis</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/superset/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>superset</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/superset/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>superset</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/test/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>test</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/test/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>test</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>typescript</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/typescript/base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/typescript/challenges/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>challenges</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/typescript/declaration/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>declaration</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/typescript/examples/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>examples</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/typescript/plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>plus</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/typescript/review/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>review</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vite/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>vite</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vite/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vite</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vite/vite_source/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vite_source</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0 is-link" data-v-b00e2fdd data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vscode/index.html" data-v-e31bd47b><!--[--><h2 class="text" data-v-e31bd47b>vscode</h2><!--]--></a><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vscode/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vscode</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>vue</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue3/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue3</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue3_diff/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue3_diff</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue3_renderer/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue3_renderer</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue3_source_design/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue3_source_design</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_base/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_base</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_cli/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_cli</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_inteview/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_inteview</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_router/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_router</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_router_plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_router_plus</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_source/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_source</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_source_design/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_source_design</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_source_plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_source_plus</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_ssr/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_ssr</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vue_vite/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vue_vite</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/vue/vuex/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>vuex</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-b00e2fdd><section class="VPSidebarItem level-0" data-v-b00e2fdd data-v-e31bd47b><div class="item" role="button" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><h2 class="text" data-v-e31bd47b>webpack</h2><!----></div><div class="items" data-v-e31bd47b><!--[--><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/webpack/webpack/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>webpack</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/webpack/webpack_5/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>webpack_5</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1" data-v-e31bd47b data-v-e31bd47b><div class="item" role="button" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><p class="text" data-v-e31bd47b>webpack_npm_source</p><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/webpack/webpack_tencent/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>webpack_tencent</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/webpack/webpack_write/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>webpack_write</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-e31bd47b data-v-e31bd47b><div class="item" tabindex="0" data-v-e31bd47b><div class="indicator" data-v-e31bd47b></div><a class="VPLink link link" href="/notes/webpack/webpack_write_plus/index.html" data-v-e31bd47b><!--[--><p class="text" data-v-e31bd47b>webpack_write_plus</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-5a346dfe data-v-669faec9><div class="VPDoc has-sidebar has-aside" data-v-669faec9 data-v-6b87e69f><!--[--><!--]--><div class="container" data-v-6b87e69f><div class="aside" data-v-6b87e69f><div class="aside-curtain" data-v-6b87e69f></div><div class="aside-container" data-v-6b87e69f><div class="aside-content" data-v-6b87e69f><div class="VPDocAside" data-v-6b87e69f data-v-3f215769><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-3f215769 data-v-d330b1bb><div class="content" data-v-d330b1bb><div class="outline-marker" data-v-d330b1bb></div><div class="outline-title" role="heading" aria-level="2" data-v-d330b1bb>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-d330b1bb><span class="visually-hidden" id="doc-outline-aria-label" data-v-d330b1bb> Table of Contents for current page </span><ul class="root" data-v-d330b1bb data-v-d0ee3533><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-6b87e69f><div class="content-container" data-v-6b87e69f><!--[--><!--]--><!----><main class="main" data-v-6b87e69f><div style="position:relative;" class="vp-doc _notes_go_base_" data-v-6b87e69f><div><h1 id="go-语言第一课" tabindex="-1">Go 语言第一课 <a class="header-anchor" href="#go-语言第一课" aria-label="Permalink to &quot;Go 语言第一课&quot;">​</a></h1><h2 id="推荐入坑理由" tabindex="-1">推荐入坑理由 <a class="header-anchor" href="#推荐入坑理由" aria-label="Permalink to &quot;推荐入坑理由&quot;">​</a></h2><ul><li>对初学者足够友好，能够快速上手 <ul><li>语法简单，可以快速学习语法，编写简单、实用应用</li><li>设计者在发布 Go 1.0 版本和兼容性规范后，主要精力还是打磨 Go 实现，改进周边工具链</li></ul></li><li>生产力与性能的最佳组合 <ul><li>创建最初目的，就是构建流行的、高性能的服务端编程语言</li><li>性能也有明显优势，与不带 GC 的静态编程语言（C/C++）之间也没有数量级的差距</li><li>对于动态语言用户友好，并且和动态语言相比，可以在保持生产力的同时，大幅度提高性能</li><li>在云原生基础设施、中间件与云服务领域大放异彩</li><li>可以应用在 DevOps/SRE、区块链、命令行交互程序（CLI）、Web 服务，数据处理方面</li></ul></li><li>快乐且具有前景 <ul><li>相对于 C/C++、Java，Go 在开发体验上有很多提升，包括简单的语法、得心应手的工具链、丰富和健壮的标准库，生产力与性能的完美结合，免除内存管理的心智负担，对并发设计的原生支持等等</li><li>可以使用 Go 体现自身价值，有非常广泛的应用场景</li></ul></li></ul><h2 id="_01、go-历史与现状" tabindex="-1">01、GO 历史与现状 <a class="header-anchor" href="#_01、go-历史与现状" aria-label="Permalink to &quot;01、GO 历史与现状&quot;">​</a></h2><h3 id="go-语言是怎样诞生的" tabindex="-1">Go 语言是怎样诞生的 <a class="header-anchor" href="#go-语言是怎样诞生的" aria-label="Permalink to &quot;Go 语言是怎样诞生的&quot;">​</a></h3><p>Go 语言的创始人有三位，分别是图灵奖获得者、C 语言联合发明人、Unix 之父肯·汤普森（Ken Thompson ），Plan 9 操作系统领导者、UTF - 8 编码的最初设计者罗伯·派克（Rob Pike），以及 Java 的 HotSpot 虚拟机和 Chrome 浏览器的 JavaScript V8 引擎的设计者之一罗伯特·格瑞史莫（Robert Griesemer）。</p><p>他们三个人在 2007 年 9 月 20 日下午的一次普通讨论，成了计算机编程语言领域的一次著名历史事件，开启了一个新编程语言的历史。</p><p>在谷歌山景城总部的办公室里，罗伯 · 派克启动了一个 C++ 工程的构建，根据以往的经验，这次构建大约需要一个小时。利用这段时间，罗伯·派克和罗伯特·格瑞史莫、肯·汤普森坐在一起，交换了关于设计一门新编程语言的想法。</p><p>之所以产生这种想法，是因为当时谷歌内部主要适用 C++ 语言构建各种系统，但 C++ 的巨大复杂性，编译构建速度慢以及在编写服务端程序时对并发支持的不足，让三位大佬觉得非常不便，于是他们就想着设计一门新的语言。在他们的初步构想中，这门新语言应该是能够给程序员带来快乐、匹配未来硬件发展趋势并适合用来开发谷歌大规模网络服务程序的。</p><p>在一天的简短讨论后，第二天三位大佬具体讨论了这门新语言的设计。会后罗伯特·格瑞史发出电邮，对这门新编程语言的功能特性做了初步归纳总结。主要思路是，在 C 语言的基础上，修正一些明显的缺陷，删除一些被诟病较多的特性，增加一些缺失的功能。例如，使用 import 替代 include、去掉宏、增加垃圾回收、支持接口等。这封电邮成为这门新语言的第一版特性设计稿，三位大佬在这门语言的一些基础语法特性上达成初步一致。</p><p>9 月 25 日，罗伯·派克在一封回复电邮中把这门新编程语言命名为 “go”。在罗伯 · 派克的心目中，“go” 这个单词短小、容易输入并且在组合其他字母后便可以用来命名 Go 相关的工具，比如编译器（goc）、汇编器（goa）、链接器（gol）等。</p><blockquote><p>go 早期版本曾如此命名 go 工具链，但后续版本撤销了这种命名方式，仅保留 go 这一统一的工具链名称。</p></blockquote><p>另外，很多 Go 语言初学者经常称这门语言为 Golang，其实这是不对的：“Golang” 仅应用于命名 Go 语言官网网站，没有使用 go.com 纯粹是因为这个域名被占用了而已。</p><h3 id="三人行-到-众人拾柴" tabindex="-1">“三人行” 到 ”众人拾柴“ <a class="header-anchor" href="#三人行-到-众人拾柴" aria-label="Permalink to &quot;“三人行” 到 ”众人拾柴“&quot;">​</a></h3><p>经过早期讨论，Go 语言的三位作者在语言设计达成初步一致后，便开启了 Go 语言迭代设计和实现的过程。</p><p>2008 年初，Unix 之父肯·汤普森实现了第一版 Go 编译器，用于验证之前的设计。这个编译器先将 Go 代码转换为 C 代码，再由 C 编译器编译成二进制文件。</p><p>2008 年年中，Go 的第一版设计就基本结束了。这是，同样在谷歌工作的伊恩·泰勒（Ian Lance Taylor）为 Go 语言实现了一个 gcc 的前端，这也是 Go 语言的第二个编译器。伊恩·泰勒的成本不仅仅是一种鼓励，也证明了 Go 这一新语言的可行性。随后，伊恩·泰勒以团队第四位成员的身份正式加入 Go 语言开发团队，后面也成了 Go 语言，以及其工具设计和实现的核心人物之一。</p><blockquote><p>一个编译器的完整编译过程包括：词法分析、语法分析、类型检查、中间代码生成、代码优化、目标代码生成、目标代码优化等几个阶段。从词法分析到中间代码生成，这就是编译器前端所要负责的事情。代码优化和目标代码生成，则是编译器后端的职责。</p><p>上面所说的实现 gcc 的前端，就是实现一个程序，这个程序可以读取 go 源码并通过词法分析、语法分析、类型检查，最终生成中间代码，而这个中间代码可以被 gcc 后端所识别并生成最终目标代码。</p></blockquote><p>罗斯·考克斯（Russ Cox）是 Go 核心开发团队的第五位成员，也是在 2008 年加入。随后，罗斯·考克斯利用函数是 “一等公民”，并且它也可以拥有自己的方法这一特性设计出了 http 包的 HandlerFunc 类型。这样，我们通过显式转型就可以让一个普通函数称为满足 http.Handler 接口的类型。</p><blockquote><p>在 Go 中，如果一个变量的类型为 int，如果我们要将其与另一个 int 64 类型的变量进行加法运算，我们不能直接将它们相加，我们必须将它们显示的转换为同一类型后才能想家，这里的转换过程就简称为显式转型。</p></blockquote><p>不仅如此，罗斯·考克斯还在当时设计的基础上提出一些更泛化的想法，比如 io.Reader 和 io.Writer 接口，这就奠定了 Go 语言的 I/O 结构模型。后来，罗斯·考克斯成为 Go 核心技术团队的负责人，推动 Go 语言的持续演化。</p><p>至此，Go 语言最初的核心团队形成，Go 语言迈上稳定演化的道路。</p><p>2009 年 10 月 30 日，罗伯·派克在 Google Techtalk 上做了一次有关 Go 语言的演讲，“The Go Programming Language”，这是 Go 语言第一次公之于众。十天后，2009 年 11 月 10 日，谷歌官方宣布 Go 语言项目开源，之后这一天也被 Go 官方确定为 Go 语言的诞生日。</p><p>在 Go 语言项目开源后，Go 语言也迎来了自己的 “吉祥物”，是一只由罗伯·派克夫人芮妮·弗伦奇（Renee French）设计的地鼠，从此地鼠（gopher）也就成为了世界各地 Go 程序员的象征，Go 程序员也被昵称为 Gopher。</p><img src="/notes/assets/go.7cb387fd.png"><p>Go 语言项目的开源吸引了全世界开发者的目光，再加上 Go 三位作者在业界的影响力以及谷歌这座大树的加持，更多有才华的程序员加入到 Go 核心开发团队中，更多贡献者开始为 Go 语言项目添砖加瓦。于是，Go 在宣布开源的当年，就成为了著名编程排行榜 TIOBE 的年度编程语言。</p><p>2012 年 3 月 28 日，Go 1.0 版本正式发布，同时 Go 官方发布了 “Go 1 兼容性” 承诺：只要符合 Go 1 语言规范的源代码，Go 编译器将保证向后兼容（backwards compatible），也就是说我们使用新版编译器也可以正确编译用老版本语法编写的代码。</p><p>从正式开源到现在，Go 语言发布了多个大版本更新，逐渐成熟。下面梳理了迄今为止 Go 语言的重大版本更新，希望可以帮助你快速了解 Go 语言的演化历史。</p><img src="/notes/assets/go_history.2f92e14f.png"><p>经过十余年的打磨与优化，如何的 Go 语言已经逐渐成为云计算时代基础设施的编程语言。你能想到的现代云计算基础设施软件的大部分流行和可靠的作品，都是用 Go 编写的，比如：Docker、Kubernetes、Prometheus、Ethereum（以太坊）、lstio、CockroachDB、InfluxDB、Terraform、Etcd、Consul 等等，可以看 Go 语言的影响力已经十分强大。</p><h3 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>一门编程语言的历史和现状，可以给你带来学习的 “安全感”，相信它可以提升你的个人价值，也会让你获得丰富的回报。你也会更加清楚地认识到：自己为什么要学习它？它未来的发展趋势又是怎样的？当这门语言的现状能给予你极大 “安全感” 的时候，我们才会 “死心塌地” 地学习和钻研这门技术，不会有太多的后顾之忧。</p><p>从 Go 本身的发展来看，和多数编程语言一样，Go 语言在诞生后，度过了一个较长 “技术萌芽期”。然后，实现了自举，发布对 GC 延迟进行大幅优化的 Go 1.5 版本，成为 Go 语言演化过程中的第一个 “引爆点”，推动 Go 语言进入 “技术膨胀期”。</p><p>也正是在这段时间内，Go 语言推出了以 Docker、Kubernetes 为典型代表的 “杀手级应用”，充分展示了实力，在世界范围收获了百万粉丝，迸发出极高的潜力和持续的活力。</p><h2 id="_02、go-语言的设计哲学" tabindex="-1">02、Go 语言的设计哲学 <a class="header-anchor" href="#_02、go-语言的设计哲学" aria-label="Permalink to &quot;02、Go 语言的设计哲学&quot;">​</a></h2><p>很多编程语言的初学者在学习初期，可能都会遇到这样的问题：最初兴致勃勃地开始学习一门编程语言，学着学着就发现很多 “别扭” 的地方，比如想要的语言特性缺失、语法风格偏避与主流语言差异大、语言的不同版本之间无法兼容、语言的语法特性过多导致学习曲线陡峭、语言的工具链支持较差，等等。</p><p>以上的这些问题，本质上都与语言设计者的设计哲学有关。所谓编程语言的设计哲学，就是指决定这门语言演化进程的高级原则和依据。</p><p>设计哲学之余编程语言，就好比一个人的价值观之余这个人的行为。如果不认同这个人的价值观，那你就很难与之持续交往下去。同理，如果你不认同一门编程语言的设计哲学，那么大概率你会在后续的语言学习中，就会遇到上面提到的问题，而且可能会让你失去继续学习的精神动力。</p><p>因此，在正式学习 Go 语法和编码之前，我们还需要先来了解一下 Go 语言的设计哲学。</p><h3 id="设计哲学" tabindex="-1">设计哲学 <a class="header-anchor" href="#设计哲学" aria-label="Permalink to &quot;设计哲学&quot;">​</a></h3><p>Go 语言的设计哲学可以总结为五点：简单、显式、组合、并发和面向工程。</p><h4 id="简单" tabindex="-1">简单 <a class="header-anchor" href="#简单" aria-label="Permalink to &quot;简单&quot;">​</a></h4><p>Go 语言的设计者们在语言设计之初，就拒绝走语言特性融合的道路，选择 “做减法” 并致力于打造一门简单的编程语言。</p><p>这也就意味着 Go 不会像 C++、Java 那样将其他编程语言的新特性兼蓄并收，所以你在 Go 语言中看不到传统的面向对象的类、构造函数与继承，看不到结构化的异常处理，也看不到本属于函数编程范式的语法元素。</p><p>不过，Go 语也没它看起来那么简单，自身实现起来也并不容易，但这些复杂性都被 Go 语言的设计者们 “隐藏” 了，所以 Go 语法层面上呈现这样的状态：</p><ul><li>仅有 25 个关键字，主流编程语言很少；</li><li>内置垃圾收集，降低开发人员内存管理的心智负担；</li><li>首字母大小写决定可见性，无需通过额外关键字修饰；</li><li>变量初始为类型零值，避免以随机值作为初值的问题；</li><li>内置数组边界检查，极大减少越界访问带来的安全隐患；</li><li>内置并发支持，简化并发程序设计；</li><li>内置接口类型，为组合的设计哲学奠定基础；</li><li>原生提供完善的工具链，开箱即用；</li><li>... ...</li></ul><p>我们可以看到 Go 设计者选择的 “简单”，其实是站在巨人肩膀上，去除或优化了以往语言中，已经被开发者证明为体验不好或难以驾驭的语法元素和语言机制，并提出自己的一些创新性的设计。比如，首字母大小写决定可见性、变量初始为类型零值、内置以 go 关键字实现的并发支持等。</p><p>简单意味着可以使用更少的代码实现相同的功能，简单意味着代码具有更好的可读性，可读性好的代码通常意味着更好的可维护性以及可靠性。</p><p>简单的设计哲学是 Go 生产力的源泉。</p><h4 id="显式" tabindex="-1">显式 <a class="header-anchor" href="#显式" aria-label="Permalink to &quot;显式&quot;">​</a></h4><p>首先，我们先来看一段 C 程序，看下 “隐式” 代码的行为特性。</p><p>在 C 语言中，下面这段代码可以正常编译并输出正确结果：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">#include</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">short</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">long</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> b;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">%ld\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, c);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">#include</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&lt;stdio.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">short</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">long</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> b;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">%ld\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, c);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>在上面这段代码中，变量 a、b 和 c 的类型均不相同，C 语言编译器在编译 c = a + b 这一行时，会自动将短整型变量 a 和整型变量 b，先转换成 long 类型然后相加，并将所有结果存储在 long 类型变量 c 中。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">fmt</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">int16</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">int64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> b</span></span>
<span class="line"><span style="color:#E1E4E8;">    fmt.</span><span style="color:#79B8FF;">Printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">%d\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, c)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">fmt</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">int16</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">var</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">var</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">int64</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> b</span></span>
<span class="line"><span style="color:#24292E;">    fmt.</span><span style="color:#005CC5;">Printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">%d\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, c)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们将上面的 C 程序转换为等价的 Go 代码，当编译程序时，会得到这样的编译器错误：“invalid operation：a + b（mismatched types int16 and in）”。我们能看到 Go 与 C 语言的隐式自动类型转换不同，Go 不允许不同类型的整型变量进行混合计算，它同样也不会对其进行隐式的自动转换。</p><p>因此，如果要使这段代码通过编译，我们就需要对变量 a 和 b 进行显式转型，就像下面这段代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int64</span><span style="color:#E1E4E8;">(a) </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int64</span><span style="color:#E1E4E8;">(b)</span></span>
<span class="line"><span style="color:#E1E4E8;">fmt.</span><span style="color:#79B8FF;">Printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">%d\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, c)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int64</span><span style="color:#24292E;">(a) </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int64</span><span style="color:#24292E;">(b)</span></span>
<span class="line"><span style="color:#24292E;">fmt.</span><span style="color:#005CC5;">Printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">%d\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, c)</span></span></code></pre></div><p>这其实就是 Go 语言显式设计哲学的体现。</p><p>在 Go 语言中，不同类型变量是不能在一起进行混合计算的，这是因为 Go 希望开发人员明确知道自己在做什么，你需要以显式的方式通过转型统一参与计算各个变量的类型。</p><p>初次之外，Go 设计者所崇尚的显式哲学还直接决定了 Go 语言错误处理的形态：Go 语言采用显式的基于值的错误处理方案，函数/方法中的错误都会通过 return 语句显式地返回，并且通常调用者不能忽略对返回的错误进行处理。</p><h4 id="组合" tabindex="-1">组合 <a class="header-anchor" href="#组合" aria-label="Permalink to &quot;组合&quot;">​</a></h4><p>这个设计哲学和我们的各个程序之间的耦合有关，Go 语言不像 C++、Java 等主流面向对象语言，我们在 Go 中见不到经典的面向对象语法元素、类型体系和继承机制，Go 崇尚的是组合的设计哲学。</p><p>在 Go 语言设计层面，Go 设计者为开发者们提供正交的语法元素，以供后续组合使用，包括：</p><ul><li>Go 语言无类型层次体系，各类型之间是相互独立的，没有子类型的概念；</li><li>每个类型都可以有自己的方法集合，类型定义与方法实现是正交独立的；</li><li>实现某个接口时，无需像 Java 那样采用特定关键字修饰；</li><li>包之间是相互独立的，没有子包的概念。</li></ul><blockquote><p>正交指相互独立，不可替代，并且组合起来可实现其它功能。</p></blockquote><p>无论是包、接口还是具体类型定义，GO 语言其实为我们呈现这样的一幅图景：一座座没有关联的 “孤岛”，但每个岛内又很精彩。Go 采用组合的方式在这些孤岛之间建立关联，形成一个整体。</p><p>Go 语言为支撑组合的设计提供了类型嵌入（Type Embedding）。通过类型嵌入，我们可以将已实现的功能嵌入到新类型中，以快速满足新类型的功能需求，这种方式有点类似面向对象语言中的 “继承” 机制，但在原理上完全不同，这是一种 Go 设计者们精心设计的 “语法糖”。</p><p>被嵌入的类型和新类型两者之间没有任何关系，甚至相互完全不知道对方的存在，没有面向对象语言中的那种父类、子类的关系，以及向上、向下转型（Type Casting）。通过新类型实例调用方法时，方法的匹配主要取决于方法名字，而不是类型。这种组合方式，可以称之为垂直组合，即通过类型嵌入，快速让一个新类型 “复用” 其他类型已经实现的能力，实现功能的垂直扩展。</p><p>下面是 Go 标准库中的一段使用类型嵌入组合方式的代码段：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// $GOROOT/src/sync/pool.go</span></span>
<span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">poolLocal</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    private </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;">{}   </span></span>
<span class="line"><span style="color:#E1E4E8;">    shared  []</span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;">{}</span></span>
<span class="line"><span style="color:#E1E4E8;">    Mutex               </span></span>
<span class="line"><span style="color:#E1E4E8;">    pad     [</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">]</span><span style="color:#F97583;">byte</span><span style="color:#E1E4E8;">  </span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// $GOROOT/src/sync/pool.go</span></span>
<span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">poolLocal</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    private </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;">{}   </span></span>
<span class="line"><span style="color:#24292E;">    shared  []</span><span style="color:#D73A49;">interface</span><span style="color:#24292E;">{}</span></span>
<span class="line"><span style="color:#24292E;">    Mutex               </span></span>
<span class="line"><span style="color:#24292E;">    pad     [</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">]</span><span style="color:#D73A49;">byte</span><span style="color:#24292E;">  </span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>在代码段中，我们在 poolLocal 这个结构体类型中嵌入类型 Mutex，这使得 poolLocal 这个类型具有互斥同步的能力，我们可以通过 poolLocal 类型的变量，直接调用 Mutex 类型的方法 Lock 或 Unlock。</p><p>另外，我们在标准库中还会看到类似如下定义接口类型的代码段：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// $GOROOT/src/io/io.go</span></span>
<span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadWriter</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">    Reader</span></span>
<span class="line"><span style="color:#E1E4E8;">    Writer</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// $GOROOT/src/io/io.go</span></span>
<span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadWriter</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    Reader</span></span>
<span class="line"><span style="color:#24292E;">    Writer</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这里，标准库通过嵌入接口类型的方式来实现接口行为的聚合，组成大接口，这种方式在标准库中尤为常用，并且已经成为 Go 语言的一种惯用法。</p><p>垂直组合本质上是一种 “能力继承”，采用嵌入方式定义的新类型继承嵌入类型的能力。Go 还有一种常见的组合方式，叫水平组合。和垂直组合的能力继承不同，水平组合是一种能力委托（Delegate），我们通常使用接口类型来实现水平组合。</p><p>Go 语言中的接口是一个创建设计，它知识方法集合，并且它与实现者之间的关系无需通过显式关键字修饰，它让程序内部各部分之间的耦合降至最低，同时它也是连接程序各个部分之间的 “纽带”。</p><p>水平组合的模式有很多，比如一种常见方法就是，通过接受接口类型参数的普通函数进行组合，如以下代码所示：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// $GOROOT/src/io/ioutil/ioutil.go</span></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ReadAll</span><span style="color:#E1E4E8;">(r io.Reader)([]</span><span style="color:#F97583;">byte</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// $GOROOT/src/io/io.go</span></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Copy</span><span style="color:#E1E4E8;">(dst Writer, src Reader)(written </span><span style="color:#F97583;">int64</span><span style="color:#E1E4E8;">, err </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// $GOROOT/src/io/ioutil/ioutil.go</span></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ReadAll</span><span style="color:#24292E;">(r io.Reader)([]</span><span style="color:#D73A49;">byte</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// $GOROOT/src/io/io.go</span></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Copy</span><span style="color:#24292E;">(dst Writer, src Reader)(written </span><span style="color:#D73A49;">int64</span><span style="color:#24292E;">, err </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">)</span></span></code></pre></div><p>函数 ReadAll 通过 io.Reader 这个接口，将 io.Reader 的实现与 ReadAll 所在的包低耦合地水平组合在一起，从而达到从任意实现 io.Reader 的数据源读取所有数据的目的。类似的水平组合 “模式” 还有点缀器、中间件等。</p><p>此外，我们还可以将 Go 语言内置的并发能力进行灵活组合以实现，比如，通过 goroutine + channel 的组合，可以实现类似 Unix Pipe 的能力。</p><p>总之，组合原则的应用实质上是塑造 Go 程序的骨架结构。类型嵌入为类型提供了垂直扩展能力，而接口是水平组合的关键，它好比程序肌体上的 “关节”，给予连接 “关节” 的两个部分各自 “自由活动” 的能力，而整体上又实现某种功能。并且，组合也让遵循 “简单” 原则的 Go 语言，在表现力上丝毫不逊色于其他复杂的主流编程语言。</p><h4 id="并发" tabindex="-1">并发 <a class="header-anchor" href="#并发" aria-label="Permalink to &quot;并发&quot;">​</a></h4><p>“并发” 这个设计哲学的出现也有有它的背景，CPU 都是靠提高主频来改进性能的，但是这个做法已经遇到瓶颈。主频提高导致 CPU 的功耗和发热量剧增，反过来制约 CPU 性能的进一步提高。2007 年开始，处理器厂商的竞争焦点从主频转向了多核。</p><p>在这种大背景下，Go 的设计者在决定创建一门新语言的时候，果断将面向多核、原生支持并发作为新语言的设计原则之一。并且，Go 放弃了传统的基于操作系统线程的并发模型，采用用户层轻量级线程，Go 将之称之为 goroutine。</p><p>goroutine 占用的资源非常小，Go 运行时默认为每个 goroutine 分配的占空间仅 2 KB。goroutine 调度的切换也不用陷入（trap）操作系统内核层完成，代价很低。因此，一个 Go 程序中可以创建成千上万个并发的 goroutine。而且，所有的 Go 代码都在 goroutine 中执行，哪怕是 go 运行时的代码也不例外。</p><p>在提供了开销较低的 goroutine 的同时，Go 还在语言层面上内置了辅助并发设计的原语：channel 和 select。开发者可以通过语言内置的 channel 传递消息或实现同步，并通过 select 实现多路 channel 的并发控制。相较于传统复杂的线程并发模型，Go 与并发的原生支持将大大降低开发人员在开发并发程序时的心智负担。</p><p>此外，并发的设计哲学不仅仅让 Go 在语法层面提供了并发原语支持，对 Go 应用程序设计的影响更为重要。并发是一种程序结构设计的方法，使得并行成为可能。</p><p>采用并发方案设计的程序在单核处理器也是可以正常运行的，也许在单核上的处理性能可能不如非并发方案。但随着处理器核数的增多，并发方案可以自然地提高处理性能。</p><p>而且，并发与组合的哲学是一脉相承的，并发是一个更大的组合概念，它在程序设计的全局层面对程序进行拆解组合，再映射到程序执行层面上：goroutines 各自执行特定的工作，通过 channel + select 将 goroutines 组合连接起来。并发的存在鼓励程序员在程序设计时进行独立计算的分解，而对并发的原生支持让 Go 语言更适合现代计算环境。</p><h4 id="面向工程" tabindex="-1">面向工程 <a class="header-anchor" href="#面向工程" aria-label="Permalink to &quot;面向工程&quot;">​</a></h4><p>Go 语言设计的初衷，就是面向解决真实世界中 Google 内部大规模软件开发中存在的各种问题，为这些问题提供答案，例如：程序构建慢、依赖管理失控、代码难于理解、跨语言构建难等。</p><p>Go语言最初设计阶段就将解决工程问题作为 Go 的设计原则之一，去考虑 Go 语法、工具链与标准库的设计，这也是 Go 与其他偏学院派、偏研究型的编程语言在设计思路上的一个重要差异。</p><p>语法是编程语言的用户接口，它直接影响开发人员对这门语言的使用体验。在面向工程设计哲学的驱使下，Go 在语法设计细节上做了精心打磨。</p><ul><li>重新设计编译单元和目标文件格式，实现 Go 源码快速构建，使大工程的构建时间缩短到类似动态语言的交互式解释的编译速度；</li><li>如果源文件导入它不使用的包，程序将无法编译。这可以充分保证任何 Go 程序的依赖树是精确的，也可以保证构建程序时不会编译额外的代码，从而最大限度地缩短编译时间；</li><li>去除包的循环依赖，循环依赖会在大规模的代码中引发问题，因为它们要求编译器同时处理更大的源文件集，这会减慢增量构建；</li><li>包路径是唯一的，包名不必唯一。导入路径必须唯一标识要导入的包，名称只是包的使用者如何引用其内容的约定。“包名称不必是唯一的” 这个约定，可以大大降低开发人员给包起唯一名字的心智负担；</li><li>不支持默认函数参数。因为在规模工程中，很多开发者利用默认函数参数机制，向函数添加过多的参数以弥补函数 API 的设计缺陷，这会导致函数拥有太多的参数，降低清晰度和可读性；</li><li>增加类型别名（type alias），支持大规模代码库重构。</li></ul><p>在标准库方面，Go 语言标准库功能丰富，多数功能不需要依赖外部的第三方包或库。Go 在标准库中提供了各种高质量且性能优良的功能包，其中 net/http、crypto、encoding 等包充分迎合了云原生时代的关于 API/RPC Web 服务器的构建需求，Go 开发者可以直接基于标准库提供的包实现一个满足生产要求的 API 服务，从而减少对外部第三方包或库的依赖，降低工程代码依赖管理的复杂性，降低开发人员学习第三方库的心理负担。</p><p>除此之外，Go 语言还提供了完善的工具链支持，涵盖了编译构建、代码格式化、包依赖管理、静态代码检查、测试、文档生成与查看、性能剖析、语言服务器、运行时程序跟踪等方方面面。</p><p>值得重点介绍的是 gofmt，它可以统一 Go 语言的代码风格，使开发者可以更加专注于业务。同时，相同的代码风格可以让开发者的代码阅读、理解和评审工作变得更加容易。Go 的这种统一代码风格思路也开始影响后续新编程语言的设计，并且一些现有的主流编程语言也在借鉴 Go 的一些设计。</p><p>在提供丰富工具链的同时，Go 在标准库中还提供了官方的词法分析器、语法解析器和类型检查器相关包，开发者可以基于这些包快速构建并扩展 Go 工具链。</p><h3 id="总结-1" tabindex="-1">总结 <a class="header-anchor" href="#总结-1" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>这篇文章我们了解了 Go 语言的设计哲学：简单、显式、组合、并发和面向工程。</p><ul><li>简单是指 Go 语言特性始终保持在少且足够的水平，不走语言特性融合的道路，但又不缺乏生产力。简单是 Go 生产力的源泉，也是 Go 对开发者的最大吸引力；</li><li>显式是指任何代码行为都需要开发者明确知晓，不存在因隐式转型导致可维护性降低和不安全的结果；</li><li>组合是构建 Go 程序骨架的主要方式，它可以大幅度降低程序元素间的耦合，提高程序的可扩展性和灵活性；</li><li>并发是 Go 把握 CPU 向多核方向发展趋势的产物，可以让那个开发人员更容易写出充分利用系统资源、支持性能随 CPU 核数增加而自然提升的应用程序；</li><li>面向过程是 Go 语言在语言设计上的一个重大创新，它将语言要解决的问题域扩展到那些原本并不是由编程语言去解决的领域，从而覆盖更多开发者在开发过程中的 “痛点”，为开发者提供更好的使用体验。</li></ul><h3 id="技术拓展" tabindex="-1">技术拓展 <a class="header-anchor" href="#技术拓展" aria-label="Permalink to &quot;技术拓展&quot;">​</a></h3><p><strong>关于 “类型别名” 的渐进式代码修复（Gradual code repair）</strong></p><p><a href="https://github.com/golang/proposal/blob/master/design/18130-type-alias.md" target="_blank" rel="noreferrer">https://github.com/golang/proposal/blob/master/design/18130-type-alias.md</a></p><p>它也是 Go 面向工程设计哲学的体现，另外 type alias 对基于现有实现进行扩展并做出新的封装方面也有 “奇效”。</p><h2 id="_03、环境配置" tabindex="-1">03、环境配置 <a class="header-anchor" href="#_03、环境配置" aria-label="Permalink to &quot;03、环境配置&quot;">​</a></h2><p>这一篇文章主要介绍如何安装和配置 Go 语言开发环境。</p><h3 id="选择-go-版本" tabindex="-1">选择 Go 版本 <a class="header-anchor" href="#选择-go-版本" aria-label="Permalink to &quot;选择 Go 版本&quot;">​</a></h3><p>挑选版本之前，我们先来看看 Go 语言的版本发布策略。</p><p>Go 团队目前已经将版本发布节奏稳定在每年发布两次大版本，通常是二月份和八月份。Go 团队承诺对最新的两个 Go 稳定大版本提供支持，比如目前的最新的大版本是 Go 1.19，那么 Go 团队就会为 Go 1.19 和 Go 1.18 版本提供支持。如果 Go 1.20 版本发布，那支持的版本将编程 Go 1.20 和 Go 1.19。支持的范围主要包括修复版本中存在的重要问题、文档变更以及安全问题更新等。</p><p>基于这样的版本发布策略，我们在选择版本时可以参考这几种思路：</p><p>一般情况下，建议使用最新版本。因为 Go 团队发布的 Go 语言稳定版本的平均质量一直是很高的，很少有影响使用的重大 bug。我们也不必担心新版本的支持问题，Google 的自有产品，比如 Google App Engine 支持都会很快，一般在 Go 新版本发布不久后，GAE 便会支持最新版本的 Go。</p><p>你还可以根据不同实际项目需要或开源社区的情况使用不同版本。</p><p>有的开源项目采纳 Go 团队建议，在 Go 最新版本发布不久就将当前项目的 Go 编译器升级到最新版，例如 kubernets 项目；有的开源项目，例如 docker 则比较谨慎，这些项目可能会使用两个发布周期之前的版本。多数项目处于两者之间，也就是使用次新版，即最新版本之前的那个版本。</p><p>因为我们是 Go 语言学习，所以推荐直接使用 Go 最新发布版。这样我们可以体验到 Go 的最新语言特性，应用到标准库的最新 API 以及 Go 工具链的最新功能。</p><p>选定 Go 版本后，接下来我们就来看看几种常见的 Go 安装方法。</p><h3 id="安装-go" tabindex="-1">安装 Go <a class="header-anchor" href="#安装-go" aria-label="Permalink to &quot;安装 Go&quot;">​</a></h3><p>在 Mac 上我们可以在图形界面的引导下进行 Go 的<a href="https://go.dev/dl/" target="_blank" rel="noreferrer">安装</a>。</p><p>首先我们需要下载适用于 Mac 的 Go 安装包（这里以 arm 为例）：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">wget -c https://go.dev/dl/go1.19.4.darwin-arm64.pkg</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">wget -c https://go.dev/dl/go1.19.4.darwin-arm64.pkg</span></span></code></pre></div><p>安装包下载完毕后，双击安装包，就可以打开标准的 Mac 软件安装界面，如下图所示：</p><img src="/notes/assets/install.c62b8cf8.png"><p>按照软件安装向导提示，一路点击 “继续”，我们便可以完成 Go 在 Mac 上的安装。</p><p>Mac 上的 Go 安装包默认也会将 Go 安装到 /usr/local/go 路径下面。因此，如果要在任意路径下使用 Go，我们也需将这个路径加入到用户的环境变量 PATH 中。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">export PATH=$PATH:/usr/local/go/bin</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">export PATH=$PATH:/usr/local/go/bin</span></span></code></pre></div><p>最后，我们同样可以通过 go version 命令验证这次安装是否成功。除此之外，我们还可以使用 brew 安装 Go。</p><h3 id="配置-go" tabindex="-1">配置 Go <a class="header-anchor" href="#配置-go" aria-label="Permalink to &quot;配置 Go&quot;">​</a></h3><p>Go 在安装后是开箱即用的，这也意味着我们在使用 Go 之前无需做任何配置。但为了更好地了解和学习 Go，我们还是要认识一些 Go 自带的常用配置项。Go 的配置项是以环境变量的形式存在的，我们可以通过下面这个命令查看 Go 的这些配置项：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go env</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go env</span></span></code></pre></div><p>下面总结了一些常用配置项：</p><table><thead><tr><th>名称</th><th>作用</th><th>值</th></tr></thead><tbody><tr><td>GOARCH</td><td>用于指示 Go 编译器生成代码所针对的平台 CPU 架构</td><td>主要值是 AMD64、Arm 等，默认值是本机的 CPU 架构</td></tr><tr><td>GOOS</td><td>用于指示 Go 编译器生成代码所针对的操作系统</td><td>主要值是 Linux、Darwin、Windows 等，默认值是本机的操作系统</td></tr><tr><td>GO111MODULE</td><td>它的值决定当前使用的构建模式是传统的 GOPATH 模式还是新引入的 GO Module 模式</td><td>在 Go 1.16 版本 Go Module 构建模式默认开启，该变量值默认为 on，测试 Go 1.19 版本默认为 “”</td></tr><tr><td>GOCACHE</td><td>用于指示存储构建结果缓存的路径，这些缓存可能会被后续的构建所使用</td><td>在不同的操作系统中，GOCACHE 有不同的默认值。以 Mac 为例，我们使用 go env GOCACHE 查看其值为：$HOME/Library/Caches/go-build</td></tr><tr><td>GOMODCACHE</td><td>用于指示存放 Go Module 的路径</td><td>在不同的操作系统上，GOMODCACHE 有不同的默认值。以 Mac 为例，我们使用 go env GOOMODCACHE 查看其值为：$HOME/go/pkg/mod</td></tr><tr><td>GOPROXY</td><td>用来配置 Go Module proxy 服务</td><td>默认值为 “<a href="https://proxy.golang.org" target="_blank" rel="noreferrer">https://proxy.golang.org</a>,direct”。中国大陆地区，可以设置为大陆地区提供的 module proxy 服务以加速 Go Module 的获取速度，值为 “<a href="https://goproxy.cn" target="_blank" rel="noreferrer">https://goproxy.cn</a>,direct”。</td></tr><tr><td>GOPATH</td><td>在传统的 GOPATH 构建模式下，用于指示 Go 包搜索路径的环境变量，在 Go module 机制启用之前是 Go 核心配置项。Go 1.8 版本之前需要手动配置，Go 1.8 版本引入了默认的 GOPATH（$HOME/go）。在 Go Module 模式正式上位后，很可能会被移除。</td><td></td></tr><tr><td>GOROOT</td><td>指示 Go 安装路径。Go 1.10 版本引入默认 GOROOT，开发者无需显式设置，Go 程序会自动根据自己所在路径推导出 GOROOT 的路径。</td><td></td></tr></tbody></table><p>如果你还想了解更多关于 Go 配置项的说明，可以通过 go help environment 命令查看。</p><h3 id="总结-2" tabindex="-1">总结 <a class="header-anchor" href="#总结-2" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>在这篇文章中，我们讲解三种 Go 版本的选择策略：</p><ul><li>第一种，也是比较推荐的一种，那就是使用 Go 最新版本，这样就可以体验到 Go 的最新语言特性，应用到标准库的最新 API 以及 Go 工具链的最新功能，并且很多老版本中的 bug 在最新版本中都会得到及时修复；</li><li>如果你对最新版本的稳定性存在顾虑，你也可以选择使用此新版；</li><li>最后，如果你要考虑现存生产项目或开源项目，只需要于选择项目保持一致就可以。</li></ul><p>确认完 Go 版本后，我们介绍了如果安装 Go。最后，我们讲解了 Go 的一些常用配置项。</p><p>有了 Go 开发环境，接下来我们就开始学习如何编写 Go 代码。</p><h2 id="_04、go-程序的结构" tabindex="-1">04、Go 程序的结构 <a class="header-anchor" href="#_04、go-程序的结构" aria-label="Permalink to &quot;04、Go 程序的结构&quot;">​</a></h2><p>正式开始之前，首先说明一下，这节课对于开发 Go 程序所使用的编辑器工具没有任何要求。</p><p>如果你喜欢使用某个集成开发环境（Integrated Development Environment，IDE），那么就用你喜欢的 IDE 就好。</p><p>在这里只推荐两款好用的 IDE，GoLand 或 Visual Studio Code（简称 VS Code）。GoLand 是知名 IDE 出品公司 JetBrains 准对 Go 语言推出的 IDE 产品，也是目前市面上最好用的 Go IDE；VS Code 则是微软开源的跨语言源码编辑器，通过集成语言插件（Go 开发者可以使用 Go 官网维护的 vscode-go 插件），可以让它变成类 IDE 的工具。</p><p>如果你有黑客情怀，喜欢优雅高效地使用命令行，那么像 Vim、Emacs 这样的基于终端的编辑器同样可以用于编写 Go 源码。以 Vim 为例，结合 vim-go、coc.nvim（代码补全）以及 Go 官方维护的 gopls 语言服务器，在编写 Go 代码时也可以体会到 “飞一般” 的感觉。</p><h3 id="hello-world" tabindex="-1">“hello world” <a class="header-anchor" href="#hello-world" aria-label="Permalink to &quot;“hello world”&quot;">​</a></h3><p>新建一个 helloworld 文件夹。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">mkdir helloworld</span></span>
<span class="line"><span style="color:#e1e4e8;">cd helloworld</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">mkdir helloworld</span></span>
<span class="line"><span style="color:#24292e;">cd helloworld</span></span></code></pre></div><p>首先，我们需要创建一个名为 main.go 的源文件。</p><p>这里说下 Go 的命名规则。Go 源文件总是以全小写字母形式的短小单词命名，并且以 .go 扩展名结尾。</p><p>现在，我们打开刚才创建的 main.go 文件，编写下面这段代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">fmt</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, world&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">fmt</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, world&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>编写完成后，我们就可以通过以下命令编译和运行这个文件。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go build main.go</span></span>
<span class="line"><span style="color:#e1e4e8;">./main</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go build main.go</span></span>
<span class="line"><span style="color:#24292e;">./main</span></span></code></pre></div><p>到这里你应该可以看到终端输出 “hello, world” 字符串。</p><p>现在，让我们来分析下这段代码。首先值得注意的部分是这个：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span></code></pre></div><p>这一行代码定义了 Go 中的一个包 package。包是 Go 语言的基本组成单元，通常使用单个的小写单词命名，一个 Go 程序本质上就是一组包的集合。所有 Go 代码都有自己隶属的包，这里我们的 “hello, world” 示例的所有代码都在一个名为 main 的包中。main 包在 Go 中是一个特殊的包，整个 Go 程序中仅允许存储一个名为 main 的包。</p><p>main 包中的主要代码是一个名为 main 的函数：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, world&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, world&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这里的 main 函数也比较特殊：当你运行一个可执行的 Go 程序的时候，所有的带啊吗都会从这个入口函数开始运行。这段代码的第一行声明了一个名为 main 的、没有任何参数和返回值的函数。如果你想给函数声明参数，必须放到括号中。</p><p>另外，花括号 {} 用来标记函数体，Go 要求所有的函数体都要被花括号包裹起来。我们推荐把左花括号与函数声明置于同一行并以空格分割。Go 语言内置了一套 Go 社区约定俗成的代码风格，并随安装包提供了一个名为 Gofmt 的工具，这个工具可以帮助你将代码自动格式化为约定的风格。</p><p>Gofmt 是 Go 语言在解决规模化（scale）问题上的一个最佳实践，并成了 Go 语言吸引其他语法开发者的一大卖点。很多其他主流语言也在效仿 Go 语言推出自己的 format 工具，例如：Java formatter、Clang formatter、Dartfmt 等。因此，作为 Go 开发人员，在提交你的代码前要使用 Gpfmt 格式化你的 Go 源码。</p><p>我们再来看一看 main 函数体中的代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, world&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, world&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>这一行代码已经完成整个示例程序的所有工作：将字符串输出到终端的标准输出（stdout）上。这里有几个细节需要注意：</p><p><strong>标准 Go 代码风格使用 Tab 而不是空格使用缩进，代码风格格式化工作也可以交由 gofmt 完成。</strong></p><p><strong>我们调用一个名为 Println 的函数，这个函数位于 Go 标准库的 fmt 包中。输出 “hello, world” 做了两部操作。</strong></p><p>第一步是在源文件的开始处通过 import 声明导入 fmt 包的包路径。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">fmt</span><span style="color:#9ECBFF;">&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">fmt</span><span style="color:#032F62;">&quot;</span></span></code></pre></div><p>第二步则是在 main 函数体内，通过 fmt 这个操作符（Qualified Identifier）调用 PrintIn 函数。虽然两处都使用了 “fmt” 这个字面值，但在这两处 “fmt” 字面值所代表的含义是一样的。</p><ul><li>import “fmt” 一行中的 “fmt” 代表的是包的导入路径（Import），它代表的是标准库下的 fmt 目录，整个 import 声明语句的含义就是导入标准库 fmt 目录下的包；</li><li>fmt.PrintIn 函数调用一行中给的 “fmt” 代表的则是包名。</li></ul><p>通常导入路径的最后一个分段名与包名是相同的，这也很容易让人误解 import 声明语句中的 “fmt” 指的是包名。</p><p>main 函数体中之所以可以调用 fmt 包中的 PrintIn 函数，还有最后一个原因，那就是 PrintIn 函数的首字母是大写的。在 Go 语言中，只有首字母为大写的标识符才是导出的（Exported），才能对包外的代码可见；如果首字母是小写的，那么就说明这个标识符仅限于在声明它的包内可见。</p><p>另外，在 Go 语言中，main 包是不可以像标准库 fmt 包那样导入的，如果导入 main 包，在代码编译阶段就会收到 Go 编译器错误：import &quot;xx/main&quot; is a program, not an importable package。</p><p>最后，在整个示例程序源码中，我们都没有使用分号来表示语句结束。不过，其实 Go 语言的正式语法规范是使用分号 “;” 来做结尾标识符的。因为大多数分号都是可选的，常常被省略，不过在源码编译时，Go 编译器会自动插入这些被省略的分号。</p><h3 id="程序如何编译" tabindex="-1">程序如何编译 <a class="header-anchor" href="#程序如何编译" aria-label="Permalink to &quot;程序如何编译&quot;">​</a></h3><p>刚刚我们在运行 “hello world” 程序之前，使用了 go build 命令，还有它附带的源文件名参数来编译它：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go build main.go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go build main.go</span></span></code></pre></div><p>假设你有 C/C++ 语言的开发背景，你就会发现这个步骤与 gcc 或 clang 编译十分相似。一旦编译成功，我们就会获得一个二进制的可执行文件。在 Linux 系统、MacOS 系统，以及 Windows 系统的 PowerShell 中，我们可以通过输入下面这个 ls 命令看到刚刚生成的可执行文件。</p><p>如果之前你更熟悉类似于 Ruby、Python 或 JavaScript 之类的动态语言，你可能还不太习惯在运行之前需要先进行编译的情况。Go 是一种编译型语言，这意味着只有编译完 Go 程序之后，才可以将生成的可执行文件交付给其他人，并可以运行在没有安装 Go 的环境中。</p><p>而如果你交付给其他人的是一份 .rb、.py 或 .js 的动态语言的源文件，那么目标环境中就必须要拥有对应的 Ruby、Python 或 JavaScript 环境才能解释执行这些源文件。</p><p>当然，Go 也借鉴了动态语言一些对开发者体验比较好的特性，比如基于源码文件的直接执行，Go 提供了 run 命令可以直接运行 Go 源码文件，比如我们也可以使用下面命令直接基于 main.go 运行。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go run main.go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go run main.go</span></span></code></pre></div><p>不过像 go run 这类命令更多应用于开发调试阶段，实际交付成功还是需要使用 go build 命令进行构建。</p><p>在我们的生产环境里，Go 程序的编译往往不会像我们前面，基于单个 Go 源文件构建这么简单。越贴近真实环境，也就意味着项目规模越大、协同人员越多，项目的依赖和依赖的版本都会变得复杂。</p><h3 id="复杂项目编译" tabindex="-1">复杂项目编译 <a class="header-anchor" href="#复杂项目编译" aria-label="Permalink to &quot;复杂项目编译&quot;">​</a></h3><p>现在我们创建一个新项目 “hellomodule”，在新项目中我们使用两个第三方库，zap 和 fasthttp。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">mddir hellomodule</span></span>
<span class="line"><span style="color:#e1e4e8;">cd hellomodule</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">mddir hellomodule</span></span>
<span class="line"><span style="color:#24292e;">cd hellomodule</span></span></code></pre></div><p>接下来编写源码文件：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/valyala/fasthttp</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">go.uber.org/zap</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> logger </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">zap.Logger</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	logger, _ </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> zap.</span><span style="color:#79B8FF;">NewProduction</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">fastHttpHandler</span><span style="color:#E1E4E8;">(ctx </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">fasthttp.RequestCtx) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	logger.</span><span style="color:#79B8FF;">Info</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, go module&quot;</span><span style="color:#E1E4E8;">, zap.</span><span style="color:#79B8FF;">ByteString</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;uri&quot;</span><span style="color:#E1E4E8;">, ctx.</span><span style="color:#79B8FF;">RequestURI</span><span style="color:#E1E4E8;">()))</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	fasthttp.</span><span style="color:#79B8FF;">ListenAndServe</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;:8081&quot;</span><span style="color:#E1E4E8;">, fastHttpHandler)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/valyala/fasthttp</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">go.uber.org/zap</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> logger </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">zap.Logger</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	logger, _ </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> zap.</span><span style="color:#005CC5;">NewProduction</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">fastHttpHandler</span><span style="color:#24292E;">(ctx </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">fasthttp.RequestCtx) {</span></span>
<span class="line"><span style="color:#24292E;">	logger.</span><span style="color:#005CC5;">Info</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, go module&quot;</span><span style="color:#24292E;">, zap.</span><span style="color:#005CC5;">ByteString</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;uri&quot;</span><span style="color:#24292E;">, ctx.</span><span style="color:#005CC5;">RequestURI</span><span style="color:#24292E;">()))</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	fasthttp.</span><span style="color:#005CC5;">ListenAndServe</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;:8081&quot;</span><span style="color:#24292E;">, fastHttpHandler)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这个示例用于创建一个在 8081 端口监听的 http 服务，当我们向它发起请求后，这个服务会在终端输出一段访问日志。</p><p>不过，当我们尝试编译这个源文件，go 编译器的输出结果是这样的：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">main.go:4:2: no required module provides package github.com/valyala/fasthttp: go.mod file not found in current directory or any parent directory; see &#39;go help modules&#39;</span></span>
<span class="line"><span style="color:#e1e4e8;">main.go:5:2: no required module provides package go.uber.org/zap: go.mod file not found in current directory or any parent directory; see &#39;go help modules&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">main.go:4:2: no required module provides package github.com/valyala/fasthttp: go.mod file not found in current directory or any parent directory; see &#39;go help modules&#39;</span></span>
<span class="line"><span style="color:#24292e;">main.go:5:2: no required module provides package go.uber.org/zap: go.mod file not found in current directory or any parent directory; see &#39;go help modules&#39;</span></span></code></pre></div><p>可以看到，main.go 文件编译失败了。从编译器来看，go build 需要找 go.mod 的文件，来解决程序对第三方包的依赖决策问题。</p><p>go.mod 文件是 Go Module 的核心文件，在这个文件中存储了这个 module 对第三方依赖的全部信息。</p><blockquote><p>Go Module 构建模式是在 Go 1.11 版本正式引入的，目的是彻底解决 Go 项目复杂版本依赖的问题，在 Go 1.16 版本中，Go Module 已经成为 Go 默认的包依赖管理机制和 Go 源码构建机制。</p></blockquote><p>接下来我们通过下面命令为这个示例程序添加 go.mod 文件。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go mod init github.com/bigwhite/hellomodule</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go mod init github.com/bigwhite/hellomodule</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go: creating new go.mod: module github.com/bigwhite/hellomodule</span></span>
<span class="line"><span style="color:#e1e4e8;">go: to add module requirements and sums:</span></span>
<span class="line"><span style="color:#e1e4e8;">	go mod tidy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go: creating new go.mod: module github.com/bigwhite/hellomodule</span></span>
<span class="line"><span style="color:#24292e;">go: to add module requirements and sums:</span></span>
<span class="line"><span style="color:#24292e;">	go mod tidy</span></span></code></pre></div><p>现在你应该可以看到，go mod init 命令的执行结果是在当前目录下生成一个 go.mod 文件：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">cat go.mod</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">cat go.mod</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">module github.com/bigwhite/hellomodule</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go 1.19</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">module github.com/bigwhite/hellomodule</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go 1.19</span></span></code></pre></div><p>其实，一个 module 就是一个包的集合，这些包和 module 一起打版本、发布和分发。go.mod 所在目录即 module 根目录。</p><p>现在我们的 go.mod 文件内容还比较简单，第一行内容是用于声明 module 路径（module path）的。而且，module 隐含了一个命名空间的概念，module 下每个包的导入路径都是有 module path 和包所在子目录的名字结合在一起构成。</p><p>另外，go.mod 的最后一行是一个 Go 版本指示符，用于表示这个 module 是在某个特定 Go 版本的 module 语义基础上编写的。</p><p>要想我们的程序正常运行，还需要在 go.mod 中添加 fasthttp 和 zap 这两个包的版本信息，我们可以手动添加，也可以使用 go mod tidy 命令，让 Go 工具自动添加：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go mod tidy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go mod tidy</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go: finding module for package go.uber.org/zap</span></span>
<span class="line"><span style="color:#e1e4e8;">go: finding module for package github.com/valyala/fasthttp</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/valyala/fasthttp v1.43.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading go.uber.org/zap v1.24.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: found github.com/valyala/fasthttp in github.com/valyala/fasthttp v1.43.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: found go.uber.org/zap in go.uber.org/zap v1.24.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading go.uber.org/atomic v1.7.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading go.uber.org/multierr v1.6.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/pkg/errors v0.8.1</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/stretchr/testify v1.8.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/klauspost/compress v1.15.9</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/andybalholm/brotli v1.0.4</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/valyala/bytebufferpool v1.0.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading go.uber.org/goleak v1.1.11</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading gopkg.in/yaml.v3 v3.0.1</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/davecgh/go-spew v1.1.1</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/pmezard/go-difflib v1.0.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/benbjohnson/clock v1.1.0</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#24292e;">go: finding module for package go.uber.org/zap</span></span>
<span class="line"><span style="color:#24292e;">go: finding module for package github.com/valyala/fasthttp</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/valyala/fasthttp v1.43.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading go.uber.org/zap v1.24.0</span></span>
<span class="line"><span style="color:#24292e;">go: found github.com/valyala/fasthttp in github.com/valyala/fasthttp v1.43.0</span></span>
<span class="line"><span style="color:#24292e;">go: found go.uber.org/zap in go.uber.org/zap v1.24.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading go.uber.org/atomic v1.7.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading go.uber.org/multierr v1.6.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/pkg/errors v0.8.1</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/stretchr/testify v1.8.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/klauspost/compress v1.15.9</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/andybalholm/brotli v1.0.4</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/valyala/bytebufferpool v1.0.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading go.uber.org/goleak v1.1.11</span></span>
<span class="line"><span style="color:#24292e;">go: downloading gopkg.in/yaml.v3 v3.0.1</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/davecgh/go-spew v1.1.1</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/pmezard/go-difflib v1.0.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/benbjohnson/clock v1.1.0</span></span></code></pre></div><p>丛输出结果中，可以看到 Go 工具不仅下载并添加了 hellomodule 直接依赖的 zap 和 fasthttp 包信息，还下载了这两个包的依赖包。</p><p>go mod tidy 执行完毕后，我们 go.mod 最新内容如下：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">module github.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bigwhite</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">hellomodule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.19</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">require (</span></span>
<span class="line"><span style="color:#E1E4E8;">	github.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">valyala</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">fasthttp v1.</span><span style="color:#79B8FF;">43.0</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">go</span><span style="color:#E1E4E8;">.uber.org</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">zap v1.</span><span style="color:#79B8FF;">24.0</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">require (</span></span>
<span class="line"><span style="color:#E1E4E8;">	github.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">andybalholm</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">brotli v1.</span><span style="color:#79B8FF;">0.4</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#E1E4E8;">	github.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">klauspost</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">compress v1.</span><span style="color:#79B8FF;">15.9</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#E1E4E8;">	github.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">valyala</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">bytebufferpool v1.</span><span style="color:#79B8FF;">0.0</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">go</span><span style="color:#E1E4E8;">.uber.org</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">atomic v1.</span><span style="color:#79B8FF;">7.0</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">go</span><span style="color:#E1E4E8;">.uber.org</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">multierr v1.</span><span style="color:#79B8FF;">6.0</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">module github.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bigwhite</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">hellomodule</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">go</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.19</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">require (</span></span>
<span class="line"><span style="color:#24292E;">	github.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">valyala</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">fasthttp v1.</span><span style="color:#005CC5;">43.0</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">go</span><span style="color:#24292E;">.uber.org</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">zap v1.</span><span style="color:#005CC5;">24.0</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">require (</span></span>
<span class="line"><span style="color:#24292E;">	github.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">andybalholm</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">brotli v1.</span><span style="color:#005CC5;">0.4</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#24292E;">	github.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">klauspost</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">compress v1.</span><span style="color:#005CC5;">15.9</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#24292E;">	github.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">valyala</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">bytebufferpool v1.</span><span style="color:#005CC5;">0.0</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">go</span><span style="color:#24292E;">.uber.org</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">atomic v1.</span><span style="color:#005CC5;">7.0</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">go</span><span style="color:#24292E;">.uber.org</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">multierr v1.</span><span style="color:#005CC5;">6.0</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// indirect</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre></div><p>这个时候，go.mod 已经记录了 hellomodule 直接依赖的包信息。不仅如此，hellomodule 目录下还多了一个名为 go.sum 的文件，这个文件记录了 hellomodule 的直接依赖和间接依赖的相关版本的 hash 值，用来校验本地宝的真实性。在构建的时候，如果本地依赖包的 hash 值与 go.sum 文件中记录的不一致，就会被拒绝构建。</p><p>有了 go.mod 以及 hellomodule 依赖的包版本信息后，我们再来执行构建：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go build main.go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go build main.go</span></span></code></pre></div><p>这次我们就可以成功构建出可执行文件 main，运行这个文件，新建一个终端端口，在新窗口中使用 curl 命令访问该服务，我们就可以看到服务端输出如下日志。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curl localhost:8081/foo/bar</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curl localhost:8081/foo/bar</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1672627109.641545,&quot;caller&quot;:&quot;hellomodule/main.go:15&quot;,&quot;msg&quot;:&quot;hello, go module&quot;,&quot;uri&quot;:&quot;/foo/bar&quot;}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">{&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:1672627109.641545,&quot;caller&quot;:&quot;hellomodule/main.go:15&quot;,&quot;msg&quot;:&quot;hello, go module&quot;,&quot;uri&quot;:&quot;/foo/bar&quot;}</span></span></code></pre></div><p>现在我们的 “hello module” 程序就已经创建成功。我们也可以看到使用 Go Module 的构建模式，go build 完全可以承担起构建规模较大、依赖复杂的 Go 项目的重任。</p><h3 id="总结-3" tabindex="-1">总结 <a class="header-anchor" href="#总结-3" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>本篇文章，我们通过 helloworld 示例程序，了解了一个 Go 程序的源码结果与代码风格自动化格式的约定。</p><ul><li>Go 包是 Go 语言的基本组成单元。一个 Go 程序就是一组包的集合，所有 Go 代码都位于包中；</li><li>Go 源码可以导入其他 Go 包，并使用其中的导出语法元素，包括类型、变量、函数、方法等，而且，main 函数是整个 Go 应用的入口函数；</li><li>Go 语言需要先编译，然后再分发和运行。如果是单 Go 源文件的情况，我们可以使用 go build 命令和 Go 源文件名的方式进行编译。不过，对于复杂的 Go 项目，我们需要在 Go Module 的帮助下完成项目构建。</li></ul><p>最后，我们集合 hellomodule 示例，初步歇息了如何构建更大规模的 Go 程序，并介绍了 Go Module 涉及的相关概念。</p><h3 id="技术拓展-1" tabindex="-1">技术拓展 <a class="header-anchor" href="#技术拓展-1" aria-label="Permalink to &quot;技术拓展&quot;">​</a></h3><p><strong>go 引入其他包，是将引用包都编译进去，还是会引用动态连接库？</strong></p><p>go 默认是开启 CGO_ENABLED 的，将 CGO_ENABLED=1。但编译出来的二进制程序究竟有无动态连接，取决于你的程序使用了什么包。如果只是一个简单的 hello world，那么编译出来的将是一个纯静态程序。</p><p>如果你依赖了网络包或一些系统包，那么编译出来的二进制程序中将会是一个包含动态链接的库。</p><p>原因就是在目前的 go 标准库中，某些功能具有两份实现，一份是 c 语言实现的，一份是 go 语言实现的。在 CGO_ENABLE 开启的情况下，go 链接器会链接 c 语言的版本，于是就有了动态连接库的情况。如果将 CGO_ENABLED 置为 0 ，再重新编译链接，那么 go 链接器会使用 go 版本的实现，这样就会得到一个没有动态链接的纯静态二进制程序。</p><h2 id="_05、go-项目的布局标准" tabindex="-1">05、Go 项目的布局标准 <a class="header-anchor" href="#_05、go-项目的布局标准" aria-label="Permalink to &quot;05、Go 项目的布局标准&quot;">​</a></h2><p>在前面的讲解中，我们编写的 Go 程序都是简单程序，一般由一个或几个 Go 源码文件组成，而且所有源码文件都在同一个目录中。但是生产环境中运行的实用程序并不会这么简单，通常它们都有复杂的项目结构布局。所以，弄清楚一个实用 Go 项目的项目布局标准是 Go 开发者走向编写复杂 Go 程序的第一步，也是必经的一步。</p><p>但是，Go 官方到目前为止也没有给出一个关于 Go 项目布局标准的正式定义。在这样的情况下，Go 社区是否有我们可以遵循的参考布局，或者事实标准？</p><p>答案是肯定的，在本节课中，我们就来学习一下 Go 社区广泛采用的 Go 项目布局是什么样子的。</p><p>要想了解 Go 项目的结构布局以及演化历史，全世界第一个 Go 语言项目是一个最好的切入点。所以，我们就先来看一下 Go 语言 “创世项目” 的结构布局是什么样子。</p><h3 id="创世项目-结构" tabindex="-1">“创世项目” 结构 <a class="header-anchor" href="#创世项目-结构" aria-label="Permalink to &quot;“创世项目” 结构&quot;">​</a></h3><p>所谓 “Go 语言的创世项目”，其实就是 Go 语言项目自身，它是全世界第一个 Go 语言项目。不过这么说也不够精确，因为 Go 语言项目起初混杂着多种语言，以 C 和 Go 代码为主，Go 语言的早期版本 C 代码的比例还不小。</p><p>我们可以使用 <a href="https://gitlab.com/esr/loccount" target="_blank" rel="noreferrer">loccount 工具</a> 对 Go 语言发布的第一个 <a href="https://github.com/golang/go/releases/tag/go1" target="_blank" rel="noreferrer">Go 1.0 版本</a> 分析：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">locccount .</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">locccount .</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">all          SLOC=460992  (100.00%)  LLOC=193045  in 2746 files</span></span>
<span class="line"><span style="color:#e1e4e8;">Go           SLOC=256321  (55.60%)  LLOC=109763  in 1983 files</span></span>
<span class="line"><span style="color:#e1e4e8;">C            SLOC=148001  (32.10%)  LLOC=73458   in 368 files</span></span>
<span class="line"><span style="color:#e1e4e8;">HTML         SLOC=25080   (5.44%)  LLOC=0       in 57 files</span></span>
<span class="line"><span style="color:#e1e4e8;">asm          SLOC=10109   (2.19%)  LLOC=0       in 133 files</span></span>
<span class="line"><span style="color:#e1e4e8;">... ...</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">all          SLOC=460992  (100.00%)  LLOC=193045  in 2746 files</span></span>
<span class="line"><span style="color:#24292e;">Go           SLOC=256321  (55.60%)  LLOC=109763  in 1983 files</span></span>
<span class="line"><span style="color:#24292e;">C            SLOC=148001  (32.10%)  LLOC=73458   in 368 files</span></span>
<span class="line"><span style="color:#24292e;">HTML         SLOC=25080   (5.44%)  LLOC=0       in 57 files</span></span>
<span class="line"><span style="color:#24292e;">asm          SLOC=10109   (2.19%)  LLOC=0       in 133 files</span></span>
<span class="line"><span style="color:#24292e;">... ...</span></span></code></pre></div><p>你会发现，在 1.0 版本中，Go 代码行数占据一半以上比例，但是 C 语言代码行数也占据 32.10% 的份额。并且在后续 Go 版本演进过程中，Go 语言代码行数占比还在逐步提升，直到 Go 1.5 版本实现自举后，Go 语言代码行数占比近 90%，C 语言比例下降为不到 1%，这一比例一直持续至今。</p><p>虽然 C 代码比例下降，Go 代码比例上升，但 Go 语言项目的布局结构却整体保留下来，十多年间虽然也有一些小范围变动，但整体没有本质变化。作为 Go 语言的 “创世项目”，它的结构布局对后续 Go 社区的项目具有重要的参考价值，尤其是 Go 项目早期 src 目录下面的结构。</p><p>为了方便查看，我们可以下载 Go 语言项目源码：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">git clone https://github.com/golang/go.git</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">git clone https://github.com/golang/go.git</span></span></code></pre></div><p>以 Go 1.3 版本为例，结果是这样的：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">cd go // 进入Go语言项目根目录</span></span>
<span class="line"><span style="color:#e1e4e8;">git checkout go1.3 // 切换到go 1.3版本</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">tree -LF 1 ./src // 查看src目录下的结构布局</span></span>
<span class="line"><span style="color:#e1e4e8;">./src</span></span>
<span class="line"><span style="color:#e1e4e8;">├── all.bash*</span></span>
<span class="line"><span style="color:#e1e4e8;">├── clean.bash*</span></span>
<span class="line"><span style="color:#e1e4e8;">├── cmd/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── make.bash*</span></span>
<span class="line"><span style="color:#e1e4e8;">├── Make.dist</span></span>
<span class="line"><span style="color:#e1e4e8;">├── pkg/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── race.bash*</span></span>
<span class="line"><span style="color:#e1e4e8;">├── run.bash*</span></span>
<span class="line"><span style="color:#e1e4e8;">... ...</span></span>
<span class="line"><span style="color:#e1e4e8;">└── sudo.bash*</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">cd go // 进入Go语言项目根目录</span></span>
<span class="line"><span style="color:#24292e;">git checkout go1.3 // 切换到go 1.3版本</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">tree -LF 1 ./src // 查看src目录下的结构布局</span></span>
<span class="line"><span style="color:#24292e;">./src</span></span>
<span class="line"><span style="color:#24292e;">├── all.bash*</span></span>
<span class="line"><span style="color:#24292e;">├── clean.bash*</span></span>
<span class="line"><span style="color:#24292e;">├── cmd/</span></span>
<span class="line"><span style="color:#24292e;">├── make.bash*</span></span>
<span class="line"><span style="color:#24292e;">├── Make.dist</span></span>
<span class="line"><span style="color:#24292e;">├── pkg/</span></span>
<span class="line"><span style="color:#24292e;">├── race.bash*</span></span>
<span class="line"><span style="color:#24292e;">├── run.bash*</span></span>
<span class="line"><span style="color:#24292e;">... ...</span></span>
<span class="line"><span style="color:#24292e;">└── sudo.bash*</span></span></code></pre></div><p>从上面的结果来看，src 目录下结构有三个特点。</p><p>首先，你可以看到，以 all.bash 为代表的代码构建的脚本源文件放在 src 下面的顶层目录。</p><p>其次，src 下的二级目录 cmd 下面存放 Go 相关可执行文件的相关目录，我们可以继续深入查看 cmd 目录下的结构：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree -LF 1 ./cmd</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">./cmd</span></span>
<span class="line"><span style="color:#e1e4e8;">... ...</span></span>
<span class="line"><span style="color:#e1e4e8;">├── 6a/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── 6c/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── 6g/</span></span>
<span class="line"><span style="color:#e1e4e8;">... ...</span></span>
<span class="line"><span style="color:#e1e4e8;">├── cc/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── cgo/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── dist/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── fix/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── gc/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── gofmt/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── ld/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── nm/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── objdump/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── pack/</span></span>
<span class="line"><span style="color:#e1e4e8;">└── yacc/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree -LF 1 ./cmd</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">./cmd</span></span>
<span class="line"><span style="color:#24292e;">... ...</span></span>
<span class="line"><span style="color:#24292e;">├── 6a/</span></span>
<span class="line"><span style="color:#24292e;">├── 6c/</span></span>
<span class="line"><span style="color:#24292e;">├── 6g/</span></span>
<span class="line"><span style="color:#24292e;">... ...</span></span>
<span class="line"><span style="color:#24292e;">├── cc/</span></span>
<span class="line"><span style="color:#24292e;">├── cgo/</span></span>
<span class="line"><span style="color:#24292e;">├── dist/</span></span>
<span class="line"><span style="color:#24292e;">├── fix/</span></span>
<span class="line"><span style="color:#24292e;">├── gc/</span></span>
<span class="line"><span style="color:#24292e;">├── go/</span></span>
<span class="line"><span style="color:#24292e;">├── gofmt/</span></span>
<span class="line"><span style="color:#24292e;">├── ld/</span></span>
<span class="line"><span style="color:#24292e;">├── nm/</span></span>
<span class="line"><span style="color:#24292e;">├── objdump/</span></span>
<span class="line"><span style="color:#24292e;">├── pack/</span></span>
<span class="line"><span style="color:#24292e;">└── yacc/</span></span></code></pre></div><p>我们可以看到，这里的每个子目录都是一个 Go 工具链命令子命令对应的可执行文件。其中，6a、6c、6g 等是早期 Go 版本针对特定平台的汇编器、编译器等的特殊命名方式。</p><p>最后，你会看到 src 下的二级目录 pkg 下面存放着运行时实现、标准库包实现，这些包即可以被上面 cmd 下各程序所导入，也可以被 Go 语言项目之外的 Go 程序依赖并导入。下面是我们通过 tree 命令查看 pkg 下面结构的输出结果：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree -LF 1 ./pkg</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">./pkg</span></span>
<span class="line"><span style="color:#e1e4e8;">... ...</span></span>
<span class="line"><span style="color:#e1e4e8;">├── flag/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── fmt/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── hash/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── html/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── image/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── index/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── io/</span></span>
<span class="line"><span style="color:#e1e4e8;">... ...</span></span>
<span class="line"><span style="color:#e1e4e8;">├── net/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── os/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── path/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── reflect/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── regexp/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── runtime/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── sort/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── strconv/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── strings/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── sync/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── syscall/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── testing/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── text/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── time/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── unicode/</span></span>
<span class="line"><span style="color:#e1e4e8;">└── unsafe/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree -LF 1 ./pkg</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">./pkg</span></span>
<span class="line"><span style="color:#24292e;">... ...</span></span>
<span class="line"><span style="color:#24292e;">├── flag/</span></span>
<span class="line"><span style="color:#24292e;">├── fmt/</span></span>
<span class="line"><span style="color:#24292e;">├── go/</span></span>
<span class="line"><span style="color:#24292e;">├── hash/</span></span>
<span class="line"><span style="color:#24292e;">├── html/</span></span>
<span class="line"><span style="color:#24292e;">├── image/</span></span>
<span class="line"><span style="color:#24292e;">├── index/</span></span>
<span class="line"><span style="color:#24292e;">├── io/</span></span>
<span class="line"><span style="color:#24292e;">... ...</span></span>
<span class="line"><span style="color:#24292e;">├── net/</span></span>
<span class="line"><span style="color:#24292e;">├── os/</span></span>
<span class="line"><span style="color:#24292e;">├── path/</span></span>
<span class="line"><span style="color:#24292e;">├── reflect/</span></span>
<span class="line"><span style="color:#24292e;">├── regexp/</span></span>
<span class="line"><span style="color:#24292e;">├── runtime/</span></span>
<span class="line"><span style="color:#24292e;">├── sort/</span></span>
<span class="line"><span style="color:#24292e;">├── strconv/</span></span>
<span class="line"><span style="color:#24292e;">├── strings/</span></span>
<span class="line"><span style="color:#24292e;">├── sync/</span></span>
<span class="line"><span style="color:#24292e;">├── syscall/</span></span>
<span class="line"><span style="color:#24292e;">├── testing/</span></span>
<span class="line"><span style="color:#24292e;">├── text/</span></span>
<span class="line"><span style="color:#24292e;">├── time/</span></span>
<span class="line"><span style="color:#24292e;">├── unicode/</span></span>
<span class="line"><span style="color:#24292e;">└── unsafe/</span></span></code></pre></div><p>虽然 Go 语言的创世项目的 src 目录下的布局结构，距离现在已经比较久远，但是这样的布局特点依然对后续很多 Go 项目的布局产生比较大的影响，尤其是那些 Go 语言早期采纳者建立的 Go 项目。比如，Go 调试器项目 Delve、开启云原生时代的 Go 项目 Docker，以及云原生时代的 “操作系统” 项目 Kubernetes 等，它们的项目布局，至今都还保持与 Go 创世项目早期相同的风格。</p><p>当然，这些早期的布局结构一直在不断地演化，简单来说可以归纳为下面三个比较重要的演进。</p><p><strong>演进一：Go 1.4 版本删除 pkg 这一中间层目录并引入 internal 目录</strong></p><p>出于简化源码树层次原因，Go 语言项目的 Go 1.4 版本对它原来的 src 目录下的布局做了两处调整。第一处是删除了 Go 源码中 “src/pkg/xxx” 中 pkg 这一层级目录而直接使用 src/xxx。这样一来，Go 语言项目的源码树深度减少一层，更便于 Go 开发者阅读和探索 Go 项目源码。</p><p>另外一处就是 Go 1.4 引入 internal 包机制，增加了internal 目录。这个 internal 机制其实是所有 Go 项目都可以用的，Go 语言项目自身也是自 Go 1.4 版本起，就使用 internal 机制。根据 internal 机制定义，一个 Go 项目里的 internal 目录下的 Go 包，只可以被本项目内部的包导入。项目外部是无法导入这个 internal 目录下面的包的。可以说，internal 目录的引入，让一个 Go 项目中 Go 包的分类与用途变得更加清晰。</p><p><strong>演进二：Go 1.6 版本增加 vendor 目录</strong></p><p>第二次演进，其实是为了解决 Go 包依赖版本管理的问题，Go 核心团队在 Go 1.5 版本中做了第一次改进。增加了 vendor 构建机制，也就是 Go 源码的编译可以不在 GOPATH 环境变量下搜索依赖包的路径，而在 vendor 目录下查找对应的依赖包。</p><p>Go 语言项目自身也在 Go 1.6 版本中增加了 vendor 目录以支持 vendor 构建，但 vendor 目录并没有实质性缓存任何第三方包。直到 Go 1.7 版本，Go 才真正在 vendor 下缓存其依赖的外部包。这些依赖包主要是 golang.org/x 下面的包，这些包同样是由 Go 核心团队维护的，并且其更新速度不受 Go 版本发布周期影响。</p><p>vendor 机制与目录的引入，让 Go 项目第一次具有可重现构建（Reproducible Build）的能力。</p><blockquote><p>可重现构建，就是针对同一份 go module 源码进行构建，不同人，在不同机器（同一架构），相同 os 上，在不同时间点都能得到相同的二进制文件。</p></blockquote><p><strong>演进三：Go 1.13 版本引入 go.mod 和 go.sum</strong></p><p>第三次演进，还是为了解决 Go 包依赖版本管理的问题。在 Go 1.11 版本中，Go 核心团队做出了第二次改进尝试：引入 Go Module 构建机制，也就是在项目引入 go.mod 以及在 go.mod 中明确项目所依赖的第三方包和版本，项目的构建就将摆脱 GOPATH 的束缚，实现精准的可重现构建。</p><p>Go 语言项目自身在 Go 1.13 版本中引入 go.mod 和 go.sum 以支持 Go Module 构建机制，下面是 Go 1.13 版本的 go.mod 文件内容：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">module std</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go 1.13</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">require (</span></span>
<span class="line"><span style="color:#e1e4e8;">  golang.org/x/crypto v0.0.0-20190611184440-5c40567a22f8</span></span>
<span class="line"><span style="color:#e1e4e8;">  golang.org/x/net v0.0.0-20190813141303-74dc4d7220e7</span></span>
<span class="line"><span style="color:#e1e4e8;">  golang.org/x/sys v0.0.0-20190529130038-5219a1e1c5f8 // indirect</span></span>
<span class="line"><span style="color:#e1e4e8;">  golang.org/x/text v0.3.2 // indirect</span></span>
<span class="line"><span style="color:#e1e4e8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">module std</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go 1.13</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">require (</span></span>
<span class="line"><span style="color:#24292e;">  golang.org/x/crypto v0.0.0-20190611184440-5c40567a22f8</span></span>
<span class="line"><span style="color:#24292e;">  golang.org/x/net v0.0.0-20190813141303-74dc4d7220e7</span></span>
<span class="line"><span style="color:#24292e;">  golang.org/x/sys v0.0.0-20190529130038-5219a1e1c5f8 // indirect</span></span>
<span class="line"><span style="color:#24292e;">  golang.org/x/text v0.3.2 // indirect</span></span>
<span class="line"><span style="color:#24292e;">)</span></span></code></pre></div><p>可以看到，Go 语言项目自身所依赖的包在 go.mod 中都有对应的信息，而原本这些依赖包是缓存在 vendor 目录下的。</p><p>总的来说，这三次演进主要体现在简化结构布局，以及优化包依赖管理方面，起到改善 Go 开发体验的作用。可以说，Go 创世项目的源码布局以及演化对 Go 社区项目的布局具有重要的启发意义，以至于在多年的 Go 社区实践后，Go 社区逐渐形成公认的 Go 项目的典型结构布局。</p><h3 id="典型结构布局" tabindex="-1">典型结构布局 <a class="header-anchor" href="#典型结构布局" aria-label="Permalink to &quot;典型结构布局&quot;">​</a></h3><p>一个 Go 项目通常分为可执行程序项目和库项目，现在我们就来分析一下这两类 Go 项目的典型结构布局分别是怎样的。</p><h4 id="go-可执行程序" tabindex="-1">Go 可执行程序 <a class="header-anchor" href="#go-可执行程序" aria-label="Permalink to &quot;Go 可执行程序&quot;">​</a></h4><p>首先来看一下 Go 可执行程序项目的典型结构布局。</p><p>可执行程序项目是以构建可执行程序为目的项目，Go 社区针对这类 Go 项目所形成的典型结构布局是这样的：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree -F exe-layout </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">exe-layout</span></span>
<span class="line"><span style="color:#e1e4e8;">├── cmd/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── app1/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   │   └── main.go</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── app2/</span></span>
<span class="line"><span style="color:#e1e4e8;">│       └── main.go</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go.mod</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go.sum</span></span>
<span class="line"><span style="color:#e1e4e8;">├── internal/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── pkga/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   │   └── pkg_a.go</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── pkgb/</span></span>
<span class="line"><span style="color:#e1e4e8;">│       └── pkg_b.go</span></span>
<span class="line"><span style="color:#e1e4e8;">├── pkg1/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── pkg1.go</span></span>
<span class="line"><span style="color:#e1e4e8;">├── pkg2/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── pkg2.go</span></span>
<span class="line"><span style="color:#e1e4e8;">└── vendor/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree -F exe-layout </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">exe-layout</span></span>
<span class="line"><span style="color:#24292e;">├── cmd/</span></span>
<span class="line"><span style="color:#24292e;">│   ├── app1/</span></span>
<span class="line"><span style="color:#24292e;">│   │   └── main.go</span></span>
<span class="line"><span style="color:#24292e;">│   └── app2/</span></span>
<span class="line"><span style="color:#24292e;">│       └── main.go</span></span>
<span class="line"><span style="color:#24292e;">├── go.mod</span></span>
<span class="line"><span style="color:#24292e;">├── go.sum</span></span>
<span class="line"><span style="color:#24292e;">├── internal/</span></span>
<span class="line"><span style="color:#24292e;">│   ├── pkga/</span></span>
<span class="line"><span style="color:#24292e;">│   │   └── pkg_a.go</span></span>
<span class="line"><span style="color:#24292e;">│   └── pkgb/</span></span>
<span class="line"><span style="color:#24292e;">│       └── pkg_b.go</span></span>
<span class="line"><span style="color:#24292e;">├── pkg1/</span></span>
<span class="line"><span style="color:#24292e;">│   └── pkg1.go</span></span>
<span class="line"><span style="color:#24292e;">├── pkg2/</span></span>
<span class="line"><span style="color:#24292e;">│   └── pkg2.go</span></span>
<span class="line"><span style="color:#24292e;">└── vendor/</span></span></code></pre></div><p>上面这样的一个 Go 项目典型布局就是 “脱胎” 于 Go 创世项目的最新结构布局。下面我们就来解释一下这里面的几个要点。</p><p>我们从上往下按顺序来，首先来看 cmd 目录。cmd 目录存放项目要编译的可执行文件对应的 main 包的源文件。如果你的项目中有多个可执行文件需要构建，每个可执行文件的 main 包需要单独放在一个子目录中。比如图中的 app1、app2，cmd 目录下的各 app 的 main 将整个项目的依赖连接在一起。</p><p>通常来说，main 包应该很简洁。我们在 main 包中会做一些命令行参数解析、资源初始化、日志设施初始化、数据库连接初始化等工作，之后就会将程序的执行权限交给更高级的执行控制对象。另外，也有一些 Go 项目会将 cmd 这个名字改为 app 或其他名字，但它的功能并没有变。</p><p>接下来看 pkg* 目录，这是一个存放项目自身要使用，同样也是可执行文件对应 main 包所依赖的库文件，同时这些目录下的包还可以被外部项目引用。</p><p>然后是 go.mod 和 go.sum ，它们是 Go 语言包依赖管理使用的配置文件。我们之前说过，Go 1.11 版本引入了 Go Module 构建机制，建议新项目都基于 Go Module 进行包依赖管理，这是目前 Go 官方推荐的标准构建模式。</p><p>对于还没有使用 Go Module 进行包依赖管理的遗留项目，比如之前采用 dep、glide 等作为包依赖管理功能的，建议尽快迁移到 Go Module 模式。Go 命令支持将 dep 的 Gopkg.toml/Gopkg.lock 或 glide 的 glide.yaml/glide.lock 转换为 go.mod。</p><p>最后我们再来看看 vendor 目录。vendor 是 Go 1.5 版本引入的用于在项目本地缓存特定八本依赖包的机制，在 Go Modules 机制引入前，基于 vendor 可以实现可重现构建，保证基于同一源码构建出的可执行程序是等价的。</p><p>不过，这里可以将 vendor 目录视为一个可选目录。原因在于，Go Modue 本身就支持可再现构建，而无需使用 vendor。当然 Go Module 机制也保留了 vendor 目录（通过 go mod vendor 可以生成 venfor 下的依赖包，通过 go build -mod=vendor 可以实现基于 vendor 的构建）。一般我们仅包里项目根目录下的 vendor 目录，否则会造成不必要的依赖选择的复杂性。</p><p>当然，还有些开发者喜欢借助一些第三方的构建工具辅助构建，比如 make、bazel 等。你可以将这些外部辅助构建工具涉及的诸多脚本文件（比如 Makefile）放置在项目的顶层目录下，就像 Go 创世项目中的 all.bash 那样。</p><p>另外，Go 1.11 引入的 module 是一组同属于一个版本管理单元。的包的集合。并且 Go 支持在一个项目/仓库中存在多个 module，但这种管理方式可能要比一定比例的代码重复引入更多的复杂性。因此，如果项目结构中存在版本管理的 “分歧”，比如：app1 和 app2 的发布版本并不总是同步的，建议你讲项目拆分为多个项目（仓库），每个项目单独作为一个 module 进行单独的版本管理和演进。</p><p>当然如果你非要在一个代码仓库中存放多个 module，新版 Go 命令也提供了很好的支持。比如下面代码仓库 multi-modules 下面有三个 module：mainmodule、module1、module2 ：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree multi-modules</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">multi-modules</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go.mod // mainmodule</span></span>
<span class="line"><span style="color:#e1e4e8;">├── module1</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── go.mod // module1</span></span>
<span class="line"><span style="color:#e1e4e8;">└── module2</span></span>
<span class="line"><span style="color:#e1e4e8;">    └── go.mod // module2</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree multi-modules</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">multi-modules</span></span>
<span class="line"><span style="color:#24292e;">├── go.mod // mainmodule</span></span>
<span class="line"><span style="color:#24292e;">├── module1</span></span>
<span class="line"><span style="color:#24292e;">│   └── go.mod // module1</span></span>
<span class="line"><span style="color:#24292e;">└── module2</span></span>
<span class="line"><span style="color:#24292e;">    └── go.mod // module2</span></span></code></pre></div><p>我们可以通过 git tag 名字来区分不同 module 版本。其中 vX.Y.Z 形式的 tag 名字用于代码仓库下的 mainmodule；而 module1/vX.Y.Z 形式的 tag 名字用于指示 module1 的版本；同理 module2/vX.Y.Z 形式的 tag 名字用于指示 module2 版本。</p><p>如果 Go 可执行程序项目有一个且只有一个可执行程序要构建，我们还可以将上面项目布局进行简化：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree -F -L 1 single-exe-layout</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">single-exe-layout</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go.mod</span></span>
<span class="line"><span style="color:#e1e4e8;">├── internal/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── main.go</span></span>
<span class="line"><span style="color:#e1e4e8;">├── pkg1/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── pkg2/</span></span>
<span class="line"><span style="color:#e1e4e8;">└── vendor/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree -F -L 1 single-exe-layout</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">single-exe-layout</span></span>
<span class="line"><span style="color:#24292e;">├── go.mod</span></span>
<span class="line"><span style="color:#24292e;">├── internal/</span></span>
<span class="line"><span style="color:#24292e;">├── main.go</span></span>
<span class="line"><span style="color:#24292e;">├── pkg1/</span></span>
<span class="line"><span style="color:#24292e;">├── pkg2/</span></span>
<span class="line"><span style="color:#24292e;">└── vendor/</span></span></code></pre></div><p>你可以看到，我们可以删除 cmd 目录，将唯一的可执行程序的 main 包放在项目根目录下，其他布局元素的功能不变。</p><h4 id="go-库项目" tabindex="-1">Go 库项目 <a class="header-anchor" href="#go-库项目" aria-label="Permalink to &quot;Go 库项目&quot;">​</a></h4><p>到现在，我们已经了解 Go 可执行程序项目的典型布局，现在我们再来看下 Go 库项目的典型布局是怎样的。</p><p>Go 库项目仅对外暴露 Go 包，这类项目的典型布局形式是这样的：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree -F lib-layout </span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">lib-layout</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go.mod</span></span>
<span class="line"><span style="color:#e1e4e8;">├── internal/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── pkga/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   │   └── pkg_a.go</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── pkgb/</span></span>
<span class="line"><span style="color:#e1e4e8;">│       └── pkg_b.go</span></span>
<span class="line"><span style="color:#e1e4e8;">├── pkg1/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── pkg1.go</span></span>
<span class="line"><span style="color:#e1e4e8;">└── pkg2/</span></span>
<span class="line"><span style="color:#e1e4e8;">    └── pkg2.go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree -F lib-layout </span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">lib-layout</span></span>
<span class="line"><span style="color:#24292e;">├── go.mod</span></span>
<span class="line"><span style="color:#24292e;">├── internal/</span></span>
<span class="line"><span style="color:#24292e;">│   ├── pkga/</span></span>
<span class="line"><span style="color:#24292e;">│   │   └── pkg_a.go</span></span>
<span class="line"><span style="color:#24292e;">│   └── pkgb/</span></span>
<span class="line"><span style="color:#24292e;">│       └── pkg_b.go</span></span>
<span class="line"><span style="color:#24292e;">├── pkg1/</span></span>
<span class="line"><span style="color:#24292e;">│   └── pkg1.go</span></span>
<span class="line"><span style="color:#24292e;">└── pkg2/</span></span>
<span class="line"><span style="color:#24292e;">    └── pkg2.go</span></span></code></pre></div><p>我们可以看到，库类型项目相比 Go 可执行程序的布局要简单一些。因为这类项目不需要构建可执行程序，所以去除了 cmd 目录。</p><p>并且，在这里，vendor 也不再是可选目录。对于库类型项目而言，我们并不推荐在项目中放置 vendor 目录去缓存库自身的第三方依赖，库项目仅通过 go.mod 文件明确表述出该项目依赖的 modue 或包以及版本要求就可以了。</p><p>Go 库项目的初衷是为了对外部（开源或组织内部公开）暴露 API，对于仅限项目内部使用而不像暴露到外部的包，可以放在项目顶层的 internal 目录下面。在同一项目中，internal 也可以有多个并存在于项目结构中的任意目录层级，关键是项目结构设计人员要明确各级 internal 包的应用层次和范围。</p><p>对于有一个且仅有一个包的 Go 库项目来说，我们也可以将上面的布局做进一步简化：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree -L 1 -F single-pkg-lib-layout</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">single-pkg-lib-layout</span></span>
<span class="line"><span style="color:#e1e4e8;">├── feature1.go</span></span>
<span class="line"><span style="color:#e1e4e8;">├── feature2.go</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go.mod</span></span>
<span class="line"><span style="color:#e1e4e8;">└── internal/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree -L 1 -F single-pkg-lib-layout</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">single-pkg-lib-layout</span></span>
<span class="line"><span style="color:#24292e;">├── feature1.go</span></span>
<span class="line"><span style="color:#24292e;">├── feature2.go</span></span>
<span class="line"><span style="color:#24292e;">├── go.mod</span></span>
<span class="line"><span style="color:#24292e;">└── internal/</span></span></code></pre></div><p>简化后，我们可以将唯一包的所有源文件放置在项目的顶层目录下，其他布局元素位置和功能不变。</p><p>我们已经了解目前 Go 项目的典型结构布局。除此之外，我们还需要注意一下早期 Go 可执行程序项目的经典布局。</p><h3 id="早期-go-可执行程序" tabindex="-1">早期 Go 可执行程序 <a class="header-anchor" href="#早期-go-可执行程序" aria-label="Permalink to &quot;早期 Go 可执行程序&quot;">​</a></h3><p>很多早期接纳 Go 语言的开发者所建立的 Go 可执行程序项目，深受 Go 创世项目 1.4 版本之前的布局影响，这些项目将所有可暴露到外面的 Go 包聚合在 pkg 目录下，就像前面 Go 1.3 版本中的布局那样。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree -L 3 -F early-project-layout</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">early-project-layout</span></span>
<span class="line"><span style="color:#e1e4e8;">└── exe-layout/</span></span>
<span class="line"><span style="color:#e1e4e8;">    ├── cmd/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │   ├── app1/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │   └── app2/</span></span>
<span class="line"><span style="color:#e1e4e8;">    ├── go.mod</span></span>
<span class="line"><span style="color:#e1e4e8;">    ├── internal/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │   ├── pkga/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │   └── pkgb/</span></span>
<span class="line"><span style="color:#e1e4e8;">    ├── pkg/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │   ├── pkg1/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │   └── pkg2/</span></span>
<span class="line"><span style="color:#e1e4e8;">    └── vendor/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree -L 3 -F early-project-layout</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">early-project-layout</span></span>
<span class="line"><span style="color:#24292e;">└── exe-layout/</span></span>
<span class="line"><span style="color:#24292e;">    ├── cmd/</span></span>
<span class="line"><span style="color:#24292e;">    │   ├── app1/</span></span>
<span class="line"><span style="color:#24292e;">    │   └── app2/</span></span>
<span class="line"><span style="color:#24292e;">    ├── go.mod</span></span>
<span class="line"><span style="color:#24292e;">    ├── internal/</span></span>
<span class="line"><span style="color:#24292e;">    │   ├── pkga/</span></span>
<span class="line"><span style="color:#24292e;">    │   └── pkgb/</span></span>
<span class="line"><span style="color:#24292e;">    ├── pkg/</span></span>
<span class="line"><span style="color:#24292e;">    │   ├── pkg1/</span></span>
<span class="line"><span style="color:#24292e;">    │   └── pkg2/</span></span>
<span class="line"><span style="color:#24292e;">    └── vendor/</span></span></code></pre></div><p>我们可以看到，原本放在项目根目录的 pkg1 和 pkg2 公共包被统一聚合到 pkg 目录下。而且，这种早期 Go 可执行程序的典型布局在 Go 社区内部也不缺少受众，很多新建的 Go 项目依然采用这样的项目布局。</p><h3 id="总结-4" tabindex="-1">总结 <a class="header-anchor" href="#总结-4" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>在这篇文章中，我们学习了 Go 创世项目，即 Go 语言项目自身的项目源码布局，以及演进情况。在 Go 创世项目的启发下，Go 社区在多年实践中形成了典型的 Go 项目结构布局形式。</p><p>我们将 Go 项目分为可执行程序项目和 Go 库项目两类进行了详细的项目经典布局讲解。</p><p>首先，对于以生产可执行程序为目的的 Go 项目，它的典型项目结构分为五部分：</p><ul><li>项目顶层的 Go Module 相关文件，包括 go.mod 和 go.sum；</li><li>cmd 目录：存放项目要编译构建的可执行文件所对应的 main 包的源码文件；</li><li>项目包目录：每个项目下的非 main 包都平铺在项目的根目录下，每个目录对应一个 Go 包；</li><li>internal 目录：存在仅项目内部引用的 Go 包，这些包无法被项目之外引用；</li><li>vendor 目录：可选目录，为了兼容 Go 1.5 引入的 vendor 构建模式而存在。这个目录下的内容均由 Go 命令自动维护，不需要手动干预。</li></ul><p>其次，对于以生产可复用库为目的的 Go 项目，它的典型结构简单许多，我们可以直接理解为在 Go 可执行程序项目的基础上去掉 cmd 目录和 vendor 目录。</p><p>最后，早期接纳 Go 语言的开发者所建立的项目布局深受 Go 创世项目 1.4 版本之前布局的影响，将可导出的公共包放入单独的 pkg 目录下，对于这种情况我们了解即可。对于新建项目，还是建议采用前面介绍的标准布局形式。</p><h2 id="_06、构建模式-包依赖管理问题" tabindex="-1">06、构建模式：包依赖管理问题 <a class="header-anchor" href="#_06、构建模式-包依赖管理问题" aria-label="Permalink to &quot;06、构建模式：包依赖管理问题&quot;">​</a></h2><p>我们已经初步了解 Go 程序的结构，以及 Go 项目的典型布局。接下来，我们来系统学习下 Go 应用的构建。</p><p>通过这篇文章，我们可以了解 Go 构建模式演化的前世今生。理解这个发展史后，我们再来重点探讨现在被广泛采用的构建模式，Go Module 的基本概念和应用构建方式。知道怎么做之后，我们会继续分析 Go Module 的工作原理。经过层层深入地分析，你就能彻底、透彻地掌握 Go Module 构建模式。</p><p>我们先来了解一下 Go 构建模式的演化过程，弄清楚 Go 核心开发团队为什么要引入 Go Module 构建模式。</p><h3 id="go-构建模式演化过程" tabindex="-1">Go 构建模式演化过程 <a class="header-anchor" href="#go-构建模式演化过程" aria-label="Permalink to &quot;Go 构建模式演化过程&quot;">​</a></h3><p>Go 程序由 Go 包组合而成，Go 程序的构建过程就是确定包版本、编译包以及编译后得到的目标文件链接在一起的过程。</p><p>Go 语言的构建模式历经了三个迭代和演化过程，分别是初期的 GOPATH、1.5 版本的 Vendor 机制，以及现在的 Go Module。</p><h4 id="gopath" tabindex="-1">GOPATH <a class="header-anchor" href="#gopath" aria-label="Permalink to &quot;GOPATH&quot;">​</a></h4><p>Go 语言在首次开源时，就内置了一种名为 GOOPATH 的构建模式。在这种构建模式下，Go 编译器可以在本地 GOPATh 环境变量配置的路径下，搜寻 Go 程序依赖的第三方包。如果存在，就使用这个本地包进行编译；如果不存在，就会报编译错误。</p><p>这里给出一段在 GOPATH 构建模式下编写的代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/sirupsen/logrus</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">  logrus.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, gopath mode&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/sirupsen/logrus</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">  logrus.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, gopath mode&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>你可以看到，这段代码依赖第三方包 logrus（logrus 是 Go 社区使用最为广泛的第三方 log 包）。</p><p>接下来，这个构建过程演示 Go 编译器在 GOPATH 环境变量所配置的目录下，无法找到程序依赖的 logrus 包而报错的情况：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go build main.go</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">main.go:3:8: cannot find package &quot;github.com/sirupsen/logrus&quot; in any of:</span></span>
<span class="line"><span style="color:#e1e4e8;">  /Users/heora/.bin/go1.10.8/src/github.com/sirupsen/logrus (from $GOROOT)</span></span>
<span class="line"><span style="color:#e1e4e8;">  /Users/heora/Go/src/github.com/sirupsen/logrus (from $GOPATH)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go build main.go</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">main.go:3:8: cannot find package &quot;github.com/sirupsen/logrus&quot; in any of:</span></span>
<span class="line"><span style="color:#24292e;">  /Users/heora/.bin/go1.10.8/src/github.com/sirupsen/logrus (from $GOROOT)</span></span>
<span class="line"><span style="color:#24292e;">  /Users/heora/Go/src/github.com/sirupsen/logrus (from $GOPATH)</span></span></code></pre></div><p>那么 Go 编译器在 GOPATH 构建模式下，是如何搜寻第三方依赖包呢？</p><p>我们先假定 Go 程序导入了 github.com/user/repo 这个包，我们也同时假定当前 GIOPATH 环境变量配置的值为：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">export GOPATH=/usr/local/goprojects:/home/heora/go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">export GOPATH=/usr/local/goprojects:/home/heora/go</span></span></code></pre></div><p>在 GOPATH 构建模式下，Go 编译器在编译 Go 程序时，就会在下面两个路径下搜索第三方依赖包是否存在：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">/usr/local/goprojects/src/github.com/user/repo</span></span>
<span class="line"><span style="color:#e1e4e8;">/home/heora/go/src/github.com/user/repo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">/usr/local/goprojects/src/github.com/user/repo</span></span>
<span class="line"><span style="color:#24292e;">/home/heora/go/src/github.com/user/repo</span></span></code></pre></div><blockquote><p>如果没有显式设置 GOPATH 环境变量，不同操作系统下默认值的路径不同，在 macOS 或 Linux 上，默认值都是 $HOME/go。</p></blockquote><p>言归正传，当遇到上面例子这样，没有在本地找到程序的第三方包的情况，我们该如何解决这个问题？</p><p>这个时候就要用到 go get。</p><p>我们可以通过 go get 命令将本地缺失的第三方依赖包下载到本地，比如：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go get github.com/sirupsen/logrus</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go get github.com/sirupsen/logrus</span></span></code></pre></div><p>这里的 go get 命令，不仅能将 logrus 包下载到 GIOPATH 环境变量配置的目录下，它还会检查 logrus 的依赖包在本地是否存在，如果不存在，go get 也会一并将它们下载到本地。</p><p>不过，go get 下载的包是在那个时刻的最新主线版本，这样会给后续 Go 程序的构建带来一些问题。例如：</p><ul><li>依赖包持续演进，可能会导致不同开发者在不同时间获取和编译同一个 Go 包时，得到不同的结果，不能保证可重现构建（Reproduceable Build）。</li><li>如果依赖包引入不兼容代码，程序将无法通过编译。</li><li>如果依赖包因引入新代码而无法正常通过编译，并且该依赖包作者又没及时修复这个问题，这种错误也会导致程序无法通过编译。</li></ul><h4 id="vendor-机制" tabindex="-1">vendor 机制 <a class="header-anchor" href="#vendor-机制" aria-label="Permalink to &quot;vendor 机制&quot;">​</a></h4><p>在 GOPATH 构建模式下，Go 编译器实质上并没有关注 Go 项目所依赖的第三方包的版本。但 Go 开发者希望自己的 Go 项目所依赖的第三方包版本可以受自己的控制，而不是随意变化。于是 Go 核心开发团队引入 Vendor 机制试图解决上面的问题。</p><p>现在我们就来看看 vendor 机制是如何解决这个问题的。</p><p>Go 在 1.5 版本中引入 vendor 机制。vendor 机制本质上就是在 Go 项目的某个特定目录下，将项目的所有依赖包缓存起来，这个特定目录名就是 vendor。</p><p>Go 编译器会优先感知和使用 vendor 目录下缓存的第三方包版本，而不是 GOPATH 环境变量所配置的路径下的第三方包版本。这样，无论第三方依赖包自己如何变化，无论 GOPATH 环境变量所配置的路径下的第三方包是否存在、版本是什么，都不会影响 Go 程序的构建。</p><p>如果你将 vendor 目录和项目源码一样提交到代码仓库，那么其他开发者下载你的项目后，就可以实现可重现的构建。因此，如果使用 vendor 机制管理第三方依赖包，最佳实践就是将 vendor 一并提交到代码仓库中。</p><p>下面这个目录结构就是添加 vendor 目录后的结果：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">.</span></span>
<span class="line"><span style="color:#e1e4e8;">├── main.go</span></span>
<span class="line"><span style="color:#e1e4e8;">└── vendor/</span></span>
<span class="line"><span style="color:#e1e4e8;">    ├── github.com/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │   └── sirupsen/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │       └── logrus/</span></span>
<span class="line"><span style="color:#e1e4e8;">    └── golang.org/</span></span>
<span class="line"><span style="color:#e1e4e8;">        └── x/</span></span>
<span class="line"><span style="color:#e1e4e8;">            └── sys/</span></span>
<span class="line"><span style="color:#e1e4e8;">                └── unix/</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">.</span></span>
<span class="line"><span style="color:#24292e;">├── main.go</span></span>
<span class="line"><span style="color:#24292e;">└── vendor/</span></span>
<span class="line"><span style="color:#24292e;">    ├── github.com/</span></span>
<span class="line"><span style="color:#24292e;">    │   └── sirupsen/</span></span>
<span class="line"><span style="color:#24292e;">    │       └── logrus/</span></span>
<span class="line"><span style="color:#24292e;">    └── golang.org/</span></span>
<span class="line"><span style="color:#24292e;">        └── x/</span></span>
<span class="line"><span style="color:#24292e;">            └── sys/</span></span>
<span class="line"><span style="color:#24292e;">                └── unix/</span></span></code></pre></div><p>添加完 vendor 后，重新编译 main.go，这个时候 Go 编译器就会在 vendor 目录下搜索程序依赖的 logrus 包以及后者依赖的 go.lang/x/sys/unix 包了。</p><p>这里还要注意一点，要想开启 vendor 机制，你的 Go 项目必须位于 GOPATH 环境变量配置的某个路径的 src 目录下面。如果不满足这一路径要求，那么 Go 编译器是不会查找 Go 项目目录下的 vendor 目录的。</p><p>不过 vendor 机制虽然一定程序解决了 Go 程序可重现构建的问题，但对开发者来说，它的体验却并不友好。一方面，Go 项目必须放在 GOPATH 环境变量配置的路径下，庞大的 vendor 目录需要提交到代码仓库，不仅占用代码仓库空间，减慢仓库下载和更新速度，而且还会干扰代码评审，对实施代码统计等开发者效能工具也有较大影响。</p><p>另外，还需要手动管理 vendor 下面的依赖包，包括项目依赖包的分析、版本的记录、依赖包获取和存放等等。</p><p>为了解决这个问题，Go 核心团队与社区将 Go 构建的重点转移到如何解决包依赖管理上。Go 社区先后开发了诸如 gb、glide、dep 等工具，来帮助 Go 开发者对 vendor 下的第三方包进行自动依赖分析和管理，但这些工具也都有自身的问题。</p><h4 id="gomodule" tabindex="-1">GoModule <a class="header-anchor" href="#gomodule" aria-label="Permalink to &quot;GoModule&quot;">​</a></h4><p>就在 Go 社区为包依赖管理焦虑并抱怨没有官方工具时，Go 核心团队基于社区实践的经验和教训，推出官方解决方案：Go Module。</p><p>从 Go 1.11 版本开始，除了 GOPATH 构建模式之外，Go 又增加了一种 Go Module 构建模式。</p><p>一个 Go Moudle 是一个 Go 包的集合。module 是有版本的，所以 module 下的包也具有版本属性。这个 module 与这些包会组成一个独立的版本单元，它们可以一起打版本、发布和分发。</p><p>在 Go Module 模式下，通常一个代码仓库对应一个 Go Module。一个 Go Module 的顶层目录下会放置一个 go.mod 文件，每个 go.mod 文件会定义唯一一个 module，Go Module 与 go.mod 是一一对应的。</p><p>go.mod 文件所在的顶层目录也被称为 module 的根目录，module 根目录以及它子目录下的所有 Go 包均归属于这个 Go Module，这个 module 也被称为 main module。</p><h3 id="创建-go-module" tabindex="-1">创建 Go Module <a class="header-anchor" href="#创建-go-module" aria-label="Permalink to &quot;创建 Go  Module&quot;">​</a></h3><p>Go Module 的原理和使用方法其实有点复杂，我们先从如何创建一个 Go Module 开始说起。</p><p>基于当前项目创建一个 Go Module，通常有以下几个步骤：</p><ul><li>第一步，通过 go mod init 创建 go.mod 文件，将当前项目变成一个 Go Module；</li><li>第二步，通过 go mod tidy 命令自动更新当前 module 的依赖信息；</li><li>第三步，执行 go build，执行新 module 构建。</li></ul><p>首先我们先建立一个新项目 module-mode 用来演示 Go Module 的创建。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/sirupsen/logrus</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	logrus.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, go module mode&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/sirupsen/logrus</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	logrus.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, go module mode&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这个项目目录下只有 main.go 一个源文件，现在我们就来为这个项目添加 Go Module 支持。</p><p>我们可以通过 go mod init 命令为这个项目创建一个 Go Module。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go mod init github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go: creating new go.mod: module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;">go: to add module requirements and sums:</span></span>
<span class="line"><span style="color:#e1e4e8;">	go mod tidy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go mod init github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go: creating new go.mod: module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#24292e;">go: to add module requirements and sums:</span></span>
<span class="line"><span style="color:#24292e;">	go mod tidy</span></span></code></pre></div><p>go mod init 会在当前项目目录下创建一个 go.mod 文件，这个 go.mod 文件就将当前项目变成一个 Go Module，项目根目录变成 module 根目录。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go 1.19</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go 1.19</span></span></code></pre></div><p>这个 go.mod 现在处于初始状态，它的地一行内容用于声明 module 路径（module path），最后一行是一个 Go 版本指示符，用于表示这个 module 特定的 Go 版本。</p><p>go mod init 命令还输出两行日志，提示我们可以使用 go mod tidy 命令，添加 module 依赖以及校验和。go mod tidy 命令会扫描 Go 源码，并自动找出项目依赖的外部 Go Module 以及版本，并下载这些依赖更新本地的 go.mod 文件。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go mod tidy</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go: finding module for package github.com/sirupsen/logrus</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: found github.com/sirupsen/logrus in github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/stretchr/testify v1.7.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go mod tidy</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go: finding module for package github.com/sirupsen/logrus</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#24292e;">go: found github.com/sirupsen/logrus in github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/stretchr/testify v1.7.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8</span></span>
<span class="line"><span style="color:#24292e;">go: downloading gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c</span></span></code></pre></div><p>对于一个处于初始状态的 module 而言，go mod tidy 分析了当前 main module 的所有源文件，找出当前 main module 的所有第三方依赖，确定第三方依赖版本，还下载了当前 main module 的直接依赖包（比如 logrus），以及相关间接依赖包（直接依赖包的依赖，比如上面的 golang.org/x/sys 等）。</p><p>Go Module 还支持通过 Go Module 代理服务加速第三方依赖的下载。我们之前在讲解 Go 环境安装时，就提到过配置 GOPROXY 环境变量，这个环境变量的默认值是 “<a href="https://proxy.glang.org" target="_blank" rel="noreferrer">https://proxy.glang.org</a>,direct”，我们可以配置适合中国大陆地区的 Go Module 代理服务。</p><p>由 go mod tidy 下载的依赖 module 会被放置在本地的 module 缓存路径下，默认值 $GOPATH[0]/pkg/mod，Go 1.15 及以后版本可以通过 GOMODCACHE 环境变量，自定义本地 module 的缓存路径。</p><p>执行 go mod tidy 后，go.mod 的内容更新如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go 1.19</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">require github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">require golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8 // indirect</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go 1.19</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">require github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">require golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8 // indirect</span></span></code></pre></div><p>可以看到，当前 module 的直接依赖 logrus，还有它的版本信息都会写入到 go.mod 文件的 require 段中。并且，执行完 go mod tidy 后，当前项目除了 go.mod 文件外，还多了一个新文件 go.sum，内容如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/sirupsen/logrus v1.9.0 h1:trlNQbNUG3OdDrDil03MCb1H2o9nJ1x4/5LYw7byDE0=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/sirupsen/logrus v1.9.0/go.mod h1:naHLuLoDiP4jHNo9R0sCBMtWGeIprob74mVsIT4qYEQ=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/stretchr/testify v1.7.0 h1:nwc3DEeHmmLAfoZucVR881uASk0Mfjw8xYJ99tb5CcY=</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=</span></span>
<span class="line"><span style="color:#e1e4e8;">golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8 h1:0A+M6Uqn+Eje4kHMK80dtF3JCXC4ykBgQG4Fe06QRhQ=</span></span>
<span class="line"><span style="color:#e1e4e8;">golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=</span></span>
<span class="line"><span style="color:#e1e4e8;">gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=</span></span>
<span class="line"><span style="color:#e1e4e8;">gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c h1:dUUwHk2QECo/6vqA44rthZ8ie2QXMNeKRTHCNY2nXvo=</span></span>
<span class="line"><span style="color:#e1e4e8;">gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#24292e;">github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=</span></span>
<span class="line"><span style="color:#24292e;">github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=</span></span>
<span class="line"><span style="color:#24292e;">github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=</span></span>
<span class="line"><span style="color:#24292e;">github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=</span></span>
<span class="line"><span style="color:#24292e;">github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=</span></span>
<span class="line"><span style="color:#24292e;">github.com/sirupsen/logrus v1.9.0 h1:trlNQbNUG3OdDrDil03MCb1H2o9nJ1x4/5LYw7byDE0=</span></span>
<span class="line"><span style="color:#24292e;">github.com/sirupsen/logrus v1.9.0/go.mod h1:naHLuLoDiP4jHNo9R0sCBMtWGeIprob74mVsIT4qYEQ=</span></span>
<span class="line"><span style="color:#24292e;">github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=</span></span>
<span class="line"><span style="color:#24292e;">github.com/stretchr/testify v1.7.0 h1:nwc3DEeHmmLAfoZucVR881uASk0Mfjw8xYJ99tb5CcY=</span></span>
<span class="line"><span style="color:#24292e;">github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=</span></span>
<span class="line"><span style="color:#24292e;">golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8 h1:0A+M6Uqn+Eje4kHMK80dtF3JCXC4ykBgQG4Fe06QRhQ=</span></span>
<span class="line"><span style="color:#24292e;">golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=</span></span>
<span class="line"><span style="color:#24292e;">gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=</span></span>
<span class="line"><span style="color:#24292e;">gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c h1:dUUwHk2QECo/6vqA44rthZ8ie2QXMNeKRTHCNY2nXvo=</span></span>
<span class="line"><span style="color:#24292e;">gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=</span></span></code></pre></div><p>这同样是由 go mod 相关命令维护的一个文件，它存放特定版本的 module 内容的哈希值。</p><p>这是 Go Module 的一个安全措施。当将来这里的某个 module 的特定版本被再次下载时，go 命令会使用 go.sum 文件中对应的哈希值，和新下载的内容的哈希值进行比对，只有哈希值比对一致才是合法的，这样就可以保证你的项目所依赖的 module 内容，不会被恶意或意外篡改。因此，我们推荐把 go.mod 和 go.sum 两个文件及源码，一并提交到代码版本控制服务器上。</p><p>接下来，我们只需在当前 module 的根路径下，执行 go build 就可以完成 module 的构建。</p><p>go build 命令会读取 go.mod 中的依赖及版本信息，并在本地 module 缓存路径下找到对应版本的依赖 module，执行编译和链接。如果顺利的话，我们就会在在当前目录下看到一个新生成的可执行文件，执行这个文件我们就可以得到正确结果。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go build</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go build</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">ls</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go.mod		go.sum		main.go		module-mode</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">ls</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go.mod		go.sum		main.go		module-mode</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">./module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">INFO[0000] hello, go module mode</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">./module-mode</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">INFO[0000] hello, go module mode</span></span></code></pre></div><p>到这里，我们已经完成一个具有多个第三方依赖项目的构建。不过，关于 Go Module 的操作远不止这些，随着项目的演进，我们还会在代码中导入新的第三方包，删除一些旧的依赖包，更新一些依赖包版本等。</p><p>Go Module 机制会自动分析项目的依赖包，并选出最适合的版本，但是项目所依赖的包有很多版本，Go Module 是如何选出最适合的那个版本的？</p><h3 id="深入-go-module-构建模式" tabindex="-1">深入 Go Module 构建模式 <a class="header-anchor" href="#深入-go-module-构建模式" aria-label="Permalink to &quot;深入 Go Module 构建模式&quot;">​</a></h3><p>Go 语言设计者在设计 Go Module 构建模式时，进行了几项创新，这其中就包括语义导入版本（Semantic Import Versioning），以及和其他主流语言不通给的最小版本选择（Minimal Version Selection）等机制。只有深入了解这些机制，才能真正掌握 Go Module 构建模式。</p><h4 id="语义导入机制" tabindex="-1">语义导入机制 <a class="header-anchor" href="#语义导入机制" aria-label="Permalink to &quot;语义导入机制&quot;">​</a></h4><p>首先我们看一下 Go Module 的语义导入版本机制。</p><p>在上面的例子中，我们可以看到 go.mod 的 require 段中依赖的版本号，都符合 v X.Y.Z 的格式。在 Go Module 构建模式下，一个符合 Go Module 要求的版本号，由前缀 v 和一个满足 <a href="https://semver.org/" target="_blank" rel="noreferrer">语义版本</a> 规范的版本号组成。</p><img src="/notes/assets/semantic.c4e8e915.png" style="zoom:50%;"><p>在上面这张图中，语义版本号分为 3 部分：主版本号（major）、次版本号（minor）和补丁版本号（patch）。例如上面的 logrus module 的版本号是 v1.8.1，即主版本号为 1，次版本号为 8，补丁版本号为 1。</p><p>Go 命令和 go.mod 文件都使用这种符合语义版本规范的版本号，作为描述 Go Module 版本的标准形式。借助语义版本规范，Go 命令可以确定同一 module 的两个版本发布的先后次序，而且可以确定它们是否兼容。</p><p>按照语义版本规范，主版本号不同的两个版本是相互不兼容的。不过在主版本号相同的情况下，次版本号大都是向后兼容次版本号小的版本。</p><p>Go Module 规定：如果同一个包的新旧版本是兼容的，那么它们的包导入路径应该是相同的。以 logrus 为例，它有很多发布版本，我们从中选出两个版本 v1.7.0 和 v1.8.1。按照上面的语义版本规则，这两个版本的主版本号相同，新版本 v1.8.1 是兼容老版本 v1.7.0 的。那么，我们就可以知道，如果一个项目依赖 logrus，无论它使用的是 v1.7.0 版本还是 v1.8.1 版本，它都可以使用下面的包导入语句导入 logrus 包：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/sirupsen/logrus</span><span style="color:#9ECBFF;">&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/sirupsen/logrus</span><span style="color:#032F62;">&quot;</span></span></code></pre></div><p>如果在未来的每一天，logrus 的作者发布了 logrus v2.0.0 版本。那么根据语义版本规则，该版本的主版本号为 2，已经与 v1.7.0、v1.8.1 的主版本号不同，那么 v2.0.0 与 v1.7.0、v1.8.1 就是不兼容的包版本。然后我们再按照 Go Module 的规定，如果一个项目依赖 logrus v2.0.0 版本，那么它的包导入路径就不能与上面的导入方式相同了。那我们应该使用什么方式导入 logrus v2.0.0 版本呢？</p><p>Go Module 给出一个方法：将包主版本号引入到包导入路径中，我们可以像下面这样导入 logrus v2.0.0 版本依赖包：</p><blockquote><p>升级大版本后代码的 import 都要改，其实挺坑！！</p></blockquote><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/sirupsen/logrus/v2</span><span style="color:#9ECBFF;">&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/sirupsen/logrus/v2</span><span style="color:#032F62;">&quot;</span></span></code></pre></div><p>这就是 Go 的 “语义导入版本” 机制，也就是说通过在包导入路径中引入主版本号的方式，来区别同一个包的不兼容版本，这样一来我们甚至可以同时依赖一个包的两个不兼容版本。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/sirupsen/logrus</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">logv2</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/sirupsen/logrus/v2</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/sirupsen/logrus</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">logv2</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/sirupsen/logrus/v2</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre></div><p>如果我们使用 v0.y.z 版本应该使用哪种导入路径？</p><p>按照语义版本规范的说法，v0.y.z 这样的版本号是用于项目开发阶段的版本号。在这个阶段任何事情都有可能发生，其 API 也不应该被认为是稳定的。Go Module 将这样的版本（v0）与主版本号 v1 做同等对待，也就是采用不带主版本号的包导入路径，这样在一定程度降低了 Go 开发人员使用版本号包时的心智负担。</p><p>Go 语义导入机制是 Go Module 机制的基础规则，也是 Go Module 其他规则的基础。</p><h4 id="最小版本选择机制" tabindex="-1">最小版本选择机制 <a class="header-anchor" href="#最小版本选择机制" aria-label="Permalink to &quot;最小版本选择机制&quot;">​</a></h4><p>接下来，我们再来看一下 Go Module 的最小版本选择原则。</p><p>在前面的例子中，Go 命令都是在项目初始状态分析项目的依赖，并且项目中两个依赖包之间没有共同的依赖，这样的包依赖关系解决起来还是比较容易的。但依赖关系一旦复杂起来，比如像下图展示的这样，Go 又是如何确定依赖包使用哪个版本呢？</p><img src="/notes/assets/multi_version.16b5e0df.png" style="zoom:60%;"><p>在这张图中，myproject 有两个直接依赖 A 和 B，A 和 B 有一个共同的依赖包 C，但 A 依赖 C 的 v1.1.0 版本，而 B 依赖的是 C 的 v1.3.0 版本，并且此时 C 包的最新发布版为 C v1.7.0。这个时候，Go 命令是如何为 myproject 选出间接依赖包 C 的版本呢？</p><p>其实，对于当前存储的主流编程语言，以及 Go Module 出现之前的很多 Go 包依赖管理工具都会选择依赖项的 “最新最大（Latest Greatest）版本”，对应到图中给的例子，这个版本就是 v1.7.0。</p><p>理想情况下，如果语义版本控制被正确应用，并且这种 “社会契约” 也可以得到很好遵守，那么这种选择算法是有道理的，而且也可以正常工作。在这样的情况下，依赖项的 “最新最大版本“ 应该是最稳定和安全的版本，并且应该有向后兼容性。至少在相同的主版本（Major Version）依赖树中是这样的。</p><p>但我们这个问题的答案并不是这样。Go 设计者另辟蹊径，在诸多兼容性版本间，它们不光要考虑最新最大的稳定与安全，还要尊重各个 module 的诉求：A 只要求 C v1.1.0，B 只要求 C v1.3.0。所以 Go 就会在该项目依赖项的所有版本中，选出符合项目整体要求的 “最小版本”。</p><p>在这个例子中，C v1.3.0 是符合项目整体要求的版本集合中的最小版本，于是 Go 会选择 C v1.3.0，而不是 C v1.7.0。并且，Go 团队认为这是为程序实现持久和实现可重现构建的最佳方案。</p><h3 id="各版本构建模式机制和切换" tabindex="-1">各版本构建模式机制和切换 <a class="header-anchor" href="#各版本构建模式机制和切换" aria-label="Permalink to &quot;各版本构建模式机制和切换&quot;">​</a></h3><p>很多 Go 开发人员的起点，并非是默认开启 Go Module 构建模式的 Go 1.16 版本，多数 Go 开发人员使用的环境中都存在多套 Go 版本，有用于体验最新功能特定的 Go 版本，也有某些遗留项目所使用的老版本 Go 编译器。</p><p>它们工作时采用的构建模式是不同的，即便是引入 Go Module 的 Go 1.11 版本，它的 Go Module 机制，和后续进化后的 Go 版本的 Go Module 构建机制在表现行为上也有所不同。因此 Go 开发人员可能需要经常在各个 Go 版本间切换，而明确具体版本下的 Go Module 的实际表现行为对 Go 开发人员是十分必要的。</p><p>在 Go 1.11 版本中，Go 开发团队引入 Go Module 模式。这个时候，GOPATH 构建模式与 Go Modules 构建模式各自独立工作，我们可以通过设置环境变量 GO111MODULE 的值在两种构建模式间切换。随着 Go 语言的逐步演进，直到 Go 1.16 版本，Go Module 构建模式才成为默认模式。</p><p>要分析 Go 各版本的具体构建模式的机制和切换，我们可以对几个代表性版本进行分析。</p><img src="/notes/assets/multi_version02.ccb8d4fc.png" style="zoom:70%;"><p>了解上述内容后，我们就可以在工作中游刃有余的在各个版本间切换，不用再担心切换后的模式变化，导致构建失败。</p><h3 id="总结-5" tabindex="-1">总结 <a class="header-anchor" href="#总结-5" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>在这篇文章中，我们初步了解了 Go 语言构建模式的演化历史。</p><p>Go 语言最初发布时内置的构建模式是 GOPATH 构建模式。在这种构建模式下，所有构建都离不开 GOPATH 环境变量。在这个模式下，Go 编译器并没有关注依赖包版本，开发者也无法控制第三方包依赖的版本，导致开发者无法重新可重现构建。</p><p>为了支持可重现构建，Go 1.5 版本引入 vendor 机制，开发者可以在项目目录下缓存项目的所有依赖，实现可重现构建。但 vendor 机制并不完善，开发者还需要手动管理 vendor 下的依赖包，这就给开发者带来不小的心智负担。</p><p>后来，Go 1.11 版本中，Go 核心团队推出新一代构建模式：Go Module 以及一系列创新机制，包括语义导入版本机制、最小版本选择机制。</p><p>此外，Go 命令还可以通过 GO111MODULE 环境变量进行 Go 构建模式的切换。需要注意的是，从 Go 1.11 到 Go 1.16，不同的 Go 版本在 GO111MODULE 不同值的情况下，开启的构建模式以及具体表现行为也几经变化。</p><p>后续，Go 核心团队已经考虑在后续版本中彻底移除 GOPATH 构建模式，Go Module 构建模式将成为 Go 语言唯一的标准构建模式。</p><h2 id="_07、go-module-常规操作" tabindex="-1">07、Go Module 常规操作 <a class="header-anchor" href="#_07、go-module-常规操作" aria-label="Permalink to &quot;07、Go Module 常规操作&quot;">​</a></h2><p>我们已经掌握了 Go Module 构建模式的基本概念和工作原理，也学会了如何通过 go mod 命令，将一个 Go 项目转变为一个 Go Module，并通过 Go Module 构建模式进行构建。</p><p>当我们有一个 Go Module 项目之后，就需要考虑是如何维护它，即对 Go Module 依赖包的管理。</p><h3 id="添加依赖" tabindex="-1">添加依赖 <a class="header-anchor" href="#添加依赖" aria-label="Permalink to &quot;添加依赖&quot;">​</a></h3><p>在一个项目的初始阶段，我们会经常为项目引入第三方包，并借助这些包完成特定功能。就算项目进入稳定阶段，随着项目演进，我们偶尔也需要在代码中引入新的第三方包。</p><p>那我们应该如何为一个 Go Module 添加一个新的依赖包呢？</p><p>我们还是以之前的 module-mode 项目为例，为这个项目添加一个新依赖：github.com/google/uuid。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/google/uuid</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/sirupsen/logrus</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	logrus.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, go module mode&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	logrus.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(uuid.</span><span style="color:#79B8FF;">NewString</span><span style="color:#E1E4E8;">())</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/google/uuid</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/sirupsen/logrus</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	logrus.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, go module mode&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	logrus.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(uuid.</span><span style="color:#005CC5;">NewString</span><span style="color:#24292E;">())</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>新源码中，我们通过 import 语句导入了 github.com/google/uuid，并在 main 函数中调用 uuid 包的函数 NewString。</p><p>此时如果我们直接构建这个 module，我们会得到一个错误提示：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go build</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">main.go:4:2: no required module provides package github.com/google/uuid; to add it:</span></span>
<span class="line"><span style="color:#e1e4e8;">	go get github.com/google/uuid</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go build</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">main.go:4:2: no required module provides package github.com/google/uuid; to add it:</span></span>
<span class="line"><span style="color:#24292e;">	go get github.com/google/uuid</span></span></code></pre></div><p>Go 编译器提示我们，go.mod 中的 require 段中，并没有提供 gitHub.com/google/uuid 包，我们可以手动执行 go get 命令。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go get github.com/google/uuid</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/google/uuid v1.3.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: added github.com/google/uuid v1.3.0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go get github.com/google/uuid</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/google/uuid v1.3.0</span></span>
<span class="line"><span style="color:#24292e;">go: added github.com/google/uuid v1.3.0</span></span></code></pre></div><p>go get 命令可以将我们新增的依赖包下载到本地的 module 缓存里，并在 go.mod 文件的 require 段中新增一行内容。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go 1.19</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">require github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">require (</span></span>
<span class="line"><span style="color:#e1e4e8;">	github.com/google/uuid v1.3.0 // indirect</span></span>
<span class="line"><span style="color:#e1e4e8;">	golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8 // indirect</span></span>
<span class="line"><span style="color:#e1e4e8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go 1.19</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">require github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">require (</span></span>
<span class="line"><span style="color:#24292e;">	github.com/google/uuid v1.3.0 // indirect</span></span>
<span class="line"><span style="color:#24292e;">	golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8 // indirect</span></span>
<span class="line"><span style="color:#24292e;">)</span></span></code></pre></div><p>我们也可以使用 go mod tidy 命令，再执行构建前自动分析源码中的依赖变化，识别新增依赖项并下载它们。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go mod tidy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go mod tidy</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go 1.19</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">require (</span></span>
<span class="line"><span style="color:#e1e4e8;">	github.com/google/uuid v1.3.0</span></span>
<span class="line"><span style="color:#e1e4e8;">	github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#e1e4e8;">)</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">require golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8 // indirect</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">module github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go 1.19</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">require (</span></span>
<span class="line"><span style="color:#24292e;">	github.com/google/uuid v1.3.0</span></span>
<span class="line"><span style="color:#24292e;">	github.com/sirupsen/logrus v1.9.0</span></span>
<span class="line"><span style="color:#24292e;">)</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">require golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8 // indirect</span></span></code></pre></div><p>对于我们这个例子而言，手动执行 go get 新增依赖项和执行 go mod tidy 自动分析和下载依赖项的最终效果是等价的。对于复杂项目变更而言，逐一手动添加依赖显然很没有效率，go mod tidy 是更佳的选择。</p><h3 id="升级-降级依赖" tabindex="-1">升级/降级依赖 <a class="header-anchor" href="#升级-降级依赖" aria-label="Permalink to &quot;升级/降级依赖&quot;">​</a></h3><p>我们先以对依赖的的版本进行降级为例，进行分析。</p><p>在实际开发工作中，如果我们认为 Go 命令自动帮我们确定的某个依赖的版本存在一些问题，比如引入不必要复杂性导致可靠性降低、性能回退等等。我们可以手动将它降级为之前发布的某个兼容版本。</p><p>我们还是以上面的 logrus 为例，logrus 存在多个发布版本，我们可以通过下面命令进行查询：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go list -m -versions github.com/sirupsen/logrus</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/sirupsen/logrus v0.1.0 v0.1.1 v0.2.0 v0.3.0 v0.4.0 v0.4.1 v0.5.0 v0.5.1 v0.6.0 v0.6.1 v0.6.2 v0.6.3 v0.6.4 v0.6.5 v0.6.6 v0.7.0 v0.7.1 v0.7.2 v0.7.3 v0.8.0 v0.8.1 v0.8.2 v0.8.3 v0.8.4 v0.8.5 v0.8.6 v0.8.7 v0.9.0 v0.10.0 v0.11.0 v0.11.1 v0.11.2 v0.11.3 v0.11.4 v0.11.5 v1.0.0 v1.0.1 v1.0.3 v1.0.4 v1.0.5 v1.0.6 v1.1.0 v1.1.1 v1.2.0 v1.3.0 v1.4.0 v1.4.1 v1.4.2 v1.5.0 v1.6.0 v1.7.0 v1.7.1 v1.8.0 v1.8.1 v1.9.0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go list -m -versions github.com/sirupsen/logrus</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">github.com/sirupsen/logrus v0.1.0 v0.1.1 v0.2.0 v0.3.0 v0.4.0 v0.4.1 v0.5.0 v0.5.1 v0.6.0 v0.6.1 v0.6.2 v0.6.3 v0.6.4 v0.6.5 v0.6.6 v0.7.0 v0.7.1 v0.7.2 v0.7.3 v0.8.0 v0.8.1 v0.8.2 v0.8.3 v0.8.4 v0.8.5 v0.8.6 v0.8.7 v0.9.0 v0.10.0 v0.11.0 v0.11.1 v0.11.2 v0.11.3 v0.11.4 v0.11.5 v1.0.0 v1.0.1 v1.0.3 v1.0.4 v1.0.5 v1.0.6 v1.1.0 v1.1.1 v1.2.0 v1.3.0 v1.4.0 v1.4.1 v1.4.2 v1.5.0 v1.6.0 v1.7.0 v1.7.1 v1.8.0 v1.8.1 v1.9.0</span></span></code></pre></div><p>在我们的例子中，基于初始状态的 go mod tidy 命令，帮我们选择 logrus 的最新发布版本 v1.9.0。如果你觉得这个版本存在某些问题，想将 logrus 版本降至之前发布的兼容版本，比如 v1.8.0，那么我们可以在项目的 module 根目录下，执行带有版本号的 go get 命令：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go get github.com/sirupsen/logrus@v1.8.0</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/sirupsen/logrus v1.8.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/stretchr/testify v1.2.2</span></span>
<span class="line"><span style="color:#e1e4e8;">go: downgraded github.com/sirupsen/logrus v1.9.0 =&gt; v1.8.0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go get github.com/sirupsen/logrus@v1.8.0</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/sirupsen/logrus v1.8.0</span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/stretchr/testify v1.2.2</span></span>
<span class="line"><span style="color:#24292e;">go: downgraded github.com/sirupsen/logrus v1.9.0 =&gt; v1.8.0</span></span></code></pre></div><p>从输出结果我们可以看到，go get 命令下载了 logrus v1.8.0 版本，并将 go.mod 中对 logrus 的依赖版本从 v1.9.0 降至 v1.8.0。</p><p>当然我们也可以使用 go mod tidy 来帮助我们降级，前提是首先要用 go mod edit 命令，明确告知我们要依赖 v1.8.0 版本，而不是 v1.9.0：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go mod edit -require=github.com/sirupsen/logrus@v1.8.0</span></span>
<span class="line"><span style="color:#e1e4e8;">go mod tidy</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/sirupsen/logrus v1.8.0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go mod edit -require=github.com/sirupsen/logrus@v1.8.0</span></span>
<span class="line"><span style="color:#24292e;">go mod tidy</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/sirupsen/logrus v1.8.0</span></span></code></pre></div><p>降级后，我们再假设 logrus v1.8.1 版本是一个安全补丁升级，修复了一个很严重的安全漏洞，并且我们必须要使用这个安全补丁版本，那么我们就需要将 logrus 依赖从 v1.8.0 升级到 v1.8.1。</p><p>我们可以使用与降级同样的步骤来完成。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go get github.com/sirupsen/logrus@v1.8.1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go get github.com/sirupsen/logrus@v1.8.1</span></span></code></pre></div><p>到这里你就学会如何对项目依赖包版本进行升级和降级了。</p><p>但是你可能会发现一个问题，在前面的例子中，Go Module 的依赖主版本号都是 1。根据我们之前学习的语义导入版本的规范，在 Go Module 构建模式下，当依赖的主版本号为 0 或 1 的时候，我们在 Go 源码中导入依赖包，不需要在包的导入路径上增加版本号，也就是：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">import github.com/urer/repo/v0 &lt;=&gt; import github.com/user/repo</span></span>
<span class="line"><span style="color:#e1e4e8;">import github.com/urer/repo/v1 &lt;=&gt; import github.com/user/repo</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">import github.com/urer/repo/v0 &lt;=&gt; import github.com/user/repo</span></span>
<span class="line"><span style="color:#24292e;">import github.com/urer/repo/v1 &lt;=&gt; import github.com/user/repo</span></span></code></pre></div><p>但是，如果我们要依赖的 module 的主版本号大于 1，这又要怎么办呢？</p><p>语义导入版本有一个原则：如果新旧版本的包使用相同的导入路径，那么新包与旧包是兼容的。也就是说，如果新旧两个包不兼容，那么我们就应该使用不同的导入路径。</p><p>按照语义版本规范，如果我们要为项目引入主版本号为 1 的依赖，比如 v2.0.0，那么由于这个版本与 v1、v0 开头的包版本都不兼容，我们在导入 v2.0.0 包时，不能再直接使用 github.com/user/repo，而要使用像下面代码中这样不同的包导入路径。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">import github.com/user/repo/v2/xxx</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">import github.com/user/repo/v2/xxx</span></span></code></pre></div><p>也就是说，如果我们要为 Go 项目添加主版本号大于 1 的依赖，我们就需要使用 “语义导入版本” 机制，在声明它的导入路径的基础上，加上版本信息。</p><p>我们以向 module-mode 项目添加 github.com/go-redis/redis 依赖包的 v7 版本 为例，看下添加步骤。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go get github.com/go-redis/redis/v7</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">go: downloading github.com/go-redis/redis/v7 v7.4.1</span></span>
<span class="line"><span style="color:#e1e4e8;">go: added github.com/go-redis/redis/v7 v7.4.1</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go get github.com/go-redis/redis/v7</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">go: downloading github.com/go-redis/redis/v7 v7.4.1</span></span>
<span class="line"><span style="color:#24292e;">go: added github.com/go-redis/redis/v7 v7.4.1</span></span></code></pre></div><p>我们可以看到，go get 为我们选择了 go-redis v7 版本下的最新版本 v7.4.1。</p><h3 id="移除依赖" tabindex="-1">移除依赖 <a class="header-anchor" href="#移除依赖" aria-label="Permalink to &quot;移除依赖&quot;">​</a></h3><p>我们还是以 go-redis/redis 示例，如果这时我们不再需要 go-redis/redis，应该怎么做？</p><p>首先我们可以通过 go list 命令列出当前 module 的所有依赖。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go list -m all</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/cespare/xxhash/v2 v2.1.2</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/davecgh/go-spew v1.1.1</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/dgryski/go-rendezvous v0.0.0-20200823014737-9f7001d12a5f</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/fsnotify/fsnotify v1.4.9</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/go-redis/redis/v7 v7.4.1</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/go-redis/redis/v8 v8.11.5</span></span>
<span class="line"><span style="color:#e1e4e8;">...</span></span>
<span class="line"><span style="color:#e1e4e8;">gopkg.in/yaml.v2 v2.4.0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go list -m all</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#24292e;">github.com/cespare/xxhash/v2 v2.1.2</span></span>
<span class="line"><span style="color:#24292e;">github.com/davecgh/go-spew v1.1.1</span></span>
<span class="line"><span style="color:#24292e;">github.com/dgryski/go-rendezvous v0.0.0-20200823014737-9f7001d12a5f</span></span>
<span class="line"><span style="color:#24292e;">github.com/fsnotify/fsnotify v1.4.9</span></span>
<span class="line"><span style="color:#24292e;">github.com/go-redis/redis/v7 v7.4.1</span></span>
<span class="line"><span style="color:#24292e;">github.com/go-redis/redis/v8 v8.11.5</span></span>
<span class="line"><span style="color:#24292e;">...</span></span>
<span class="line"><span style="color:#24292e;">gopkg.in/yaml.v2 v2.4.0</span></span></code></pre></div><p>我们可以看到 go-redis/redis/v8 出现在结果中。</p><p>要想移除 go.mod 的依赖项，我们需要从源码中删除对依赖项的导入语句，然后使用 go mod tidy 命令，将这个依赖项彻底从 Go Module 构建上下文中清除掉。go mod tidy 会自动分析源码依赖项，而且将不再使用的依赖从 go.mod 和 go.sum 中移除。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go mod tidy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go mod tidy</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark has-diff vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go list -m all</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/davecgh/go-spew v1.1.1</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/google/uuid v1.3.0</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/pmezard/go-difflib v1.0.0</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/sirupsen/logrus v1.8.1</span></span>
<span class="line"><span style="color:#e1e4e8;">github.com/stretchr/testify v1.2.2</span></span>
<span class="line"><span style="color:#e1e4e8;">golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8</span></span></code></pre><pre class="shiki github-light has-diff vp-code-light"><code><span class="line"><span style="color:#24292e;">go list -m all</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">github.com/bigwhite/module-mode</span></span>
<span class="line"><span style="color:#24292e;">github.com/davecgh/go-spew v1.1.1</span></span>
<span class="line"><span style="color:#24292e;">github.com/google/uuid v1.3.0</span></span>
<span class="line"><span style="color:#24292e;">github.com/pmezard/go-difflib v1.0.0</span></span>
<span class="line"><span style="color:#24292e;">github.com/sirupsen/logrus v1.8.1</span></span>
<span class="line"><span style="color:#24292e;">github.com/stretchr/testify v1.2.2</span></span>
<span class="line"><span style="color:#24292e;">golang.org/x/sys v0.0.0-20220715151400-c0bba94af5f8</span></span></code></pre></div><p>执行完 go mod tidy 命令后，再次执行 go list -m all 命令，可以看到依赖列表中已经没有 redis 依赖。</p><h3 id="特殊情况-使用-vendor" tabindex="-1">特殊情况：使用 vendor <a class="header-anchor" href="#特殊情况-使用-vendor" aria-label="Permalink to &quot;特殊情况：使用 vendor&quot;">​</a></h3><p>你可能会感觉到有点奇怪，为什么 Go Module 的维护，还需要使用 vendor。</p><p>其实，vendor 机制虽然诞生于 GOPATH 构建模式主导的年代，但在 Go Module 构建模式下，它依旧被保留下来，并且成为 Go Module 构建机制的一个很好的补充。特别是在一些不方便访问外部网络，并且对 Go 应用构建性能敏感的环境，比如在一些内部的持续集成或持续交付环境中， 使用 vendor 机制可以实现与 Go Module 等价的构建。</p><p>和 GOPATH 构建模式不同，Go Module 构建模式下，我们无需手动维护 vendor 目录下的依赖包，Go 提供了可以快速建立和更新 vendor 的命令。我们还是以前面的 module-mode 项目为例，通过下面命令为该项目建立 vendor。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go mod vendor</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go mod vendor</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">tree -LF 2 vendor</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">vendor/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── github.com/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── google/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── sirupsen/</span></span>
<span class="line"><span style="color:#e1e4e8;">├── golang.org/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── x/</span></span>
<span class="line"><span style="color:#e1e4e8;">└── modules.txt</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">tree -LF 2 vendor</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">vendor/</span></span>
<span class="line"><span style="color:#24292e;">├── github.com/</span></span>
<span class="line"><span style="color:#24292e;">│   ├── google/</span></span>
<span class="line"><span style="color:#24292e;">│   └── sirupsen/</span></span>
<span class="line"><span style="color:#24292e;">├── golang.org/</span></span>
<span class="line"><span style="color:#24292e;">│   └── x/</span></span>
<span class="line"><span style="color:#24292e;">└── modules.txt</span></span></code></pre></div><p>我们可以看到，go mod vendor 命令在 vendor 目录下，创建了当前项目依赖包的副本，并且通过 vendor/modules.txt. 记录了 vendor 下的 module 以及版本。</p><p>如果我们要基于 vendor 构建，而不是基于本地缓存的 Go Module 构建，我们需要在 go build 后面加上 -mod=vendor 参数。</p><p>在 Go 1.14 及以后版本中，如果 Go 项目的顶层目录下存在 vendor 目录，那么 go build 默认也会优先基于 vendor 构建，除非你给 go build 传递 -mod=mod 参数。</p><h3 id="总结-6" tabindex="-1">总结 <a class="header-anchor" href="#总结-6" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>在通过 go mod init 为当前 Go 项目创建一个新的 module 后，随着项目的演进，我们在日常开发过程中，会遇到多种常见的维护 Go Module 的场景。</p><p>其中最常见的就是为项目添加一个依赖包，我们可以通过 go get 命令手动获取该依赖包的特定版本，更好的方法是通过 go mod tidy 命令让 Go 命令自动取分析新依赖并决定使用新依赖的哪个版本。</p><ul><li>通过 go get 我们可以升级或降级某依赖的版本，如果升级或降级前后的版本不兼容，需要修改导入路径中的版本号，这是 Go 语义导入版本机制的要求。</li><li>通过 go mod tidy，我们可以自动分析 Go 源码的依赖变更，包括依赖的新增、版本变更以及删除，并更新 go.mod 中的依赖信息。</li><li>通过 go mod vendor，我们依旧可以使用 vendor 机制，并且对 vendor 目录下缓存的依赖包进行自动管理。</li></ul><h2 id="_08、入口函数与包初始化" tabindex="-1">08、入口函数与包初始化 <a class="header-anchor" href="#_08、入口函数与包初始化" aria-label="Permalink to &quot;08、入口函数与包初始化&quot;">​</a></h2><p>刚开始学习 Go 语言的时候，我们可能会经常遇到这样一个问题：一个 Go 项目中有数十个 Go 包，每个包又有若干常量、变量、各种函数和方法，那 Go 代码究竟是从哪里开始执行的？后续执行顺序又是什么？</p><p>Go 程序由一系列 Go 包组成，代码的执行也是在各个包之间跳转。首先我们先来看看 Go 应用的入口函数，main 函数。</p><h3 id="main-main-函数" tabindex="-1">main.main 函数 <a class="header-anchor" href="#main-main-函数" aria-label="Permalink to &quot;main.main 函数&quot;">​</a></h3><p>Go 语言中有一个特殊的函数：main 包中的 main 函数，即 main.main，它是所有 Go 可执行程序的用户层执行逻辑的入口函数。Go 程序在用户层面的执行逻辑，会在这个函数内按照它的调用顺序展开。</p><p>main 函数的函数原型是这样的：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {}</span></span></code></pre></div><p>main 函数的函数原型非常简单，没有参数也没有返回值。而且，Go 语言要求：可执行程序的 main 包必须定义 main 函数，否则 Go 编译器会报错。在启动多个 Goroutine（Go 语言的轻量级用户线程）的 Go 应用中，main.main 函数将在 Go 应用的主 Coroutine 中执行。</p><p>在多 Goroutine 的 Go 应用中，相较于 main.main 作为 Go 应用的入口，main.main 函数返回的意义其实更大，main 函数返回就意味着整个 Go 程序的终结，而且你也不用管这个时候是否还有其他子 Goroutine 正在执行。</p><p>另外还需要注意的是，除了 main 包外，其他包也可以拥有自己的名为 main 的函数或方法。但按照 Go 的可见性规则（小写字母开头的标识符为非导出标识符），非 main 包中自定义的 main 函数仅限于包内使用，就像下面代码这样：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">pk1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">fmt</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">main</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">  fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;main func for pk1&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">pk1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">fmt</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">main</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">  fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;main func for pk1&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>你可以看到，这里的 main 函数主要就是在包 pkg1 内部使用的，不能在包外使用。</p><p>对于 main 包的 main 函数来说，虽然他是用户层逻辑的入口函数，但并不意味着它是用户层第一个被执行的函数。</p><h3 id="init-函数" tabindex="-1">init 函数 <a class="header-anchor" href="#init-函数" aria-label="Permalink to &quot;init 函数&quot;">​</a></h3><p>除了上面的 main.main 函数之外，Go 还有一个特殊函数，就是用于进行包初始化的 init 函数。</p><p>和 main.main 函数一样，init 函数也是一个无参数无返回值的函数：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {}</span></span></code></pre></div><p>如果 main 依赖的包中定义了 init 函数，或者 main 包自身定义了 init 函数，那么 Go 程序在这个包初始化的时候，就会自动调用它的 init 函数，因此这些 init 函数的执行就都会发生在 main 函数之前。</p><p>不过对于 init 函数来说，我们还需要注意一点，就是在 Go 程序中我们不能手工显示地调用 init，否则会收到编译错误。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">fmt</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;init invoked&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">init</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">fmt</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;init invoked&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">init</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go run main.go</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;"># command-line-arguments</span></span>
<span class="line"><span style="color:#e1e4e8;">./main.go:10:2: undefined: init</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go run main.go</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;"># command-line-arguments</span></span>
<span class="line"><span style="color:#24292e;">./main.go:10:2: undefined: init</span></span></code></pre></div><p>Go 包可以拥有多个 init 函数，每个组成 Go 包的 Go 源文件中，也可以定义多个 init 函数。</p><p>在初始化 Go 包时，Go 会按照一定的次序，逐一、顺序地调用这个包的 init 函数。一般来说，先传递给 Go 编译器的源文件中的 init 函数，会先被执行；同一个源文件中的多个 init 函数，会按声明顺序依次执行。</p><p>所以，当我们想要在 main.main 函数执行之前，执行一些函数或语句的时候，只需要将它放入 init 函数就可以了。</p><h3 id="go-包的初始化顺序" tabindex="-1">Go 包的初始化顺序 <a class="header-anchor" href="#go-包的初始化顺序" aria-label="Permalink to &quot;Go 包的初始化顺序&quot;">​</a></h3><p>从程序逻辑结构角度来看，Go 包是程序逻辑封装的基本单元，每个包都可以理解为是一个 “自治” 的、封装良好的、对外部暴露有限接口的基本单元。一个 Go 程序就是由一组包组成，程序的初始化就是这些包的初始化。每个 Go 包还会有自己的依赖包、常量、变量、init 函数（main 包有main函数）。</p><p>我们可以通过下面这张流程图，学习下 Go 包的初始化次序：</p><img src="/notes/assets/init.bb117a51.png"><p>首先，main 包依赖 pkg1 和 pkg4 两个包，第一步，Go 会根据包导入的顺序，先初始化第一个依赖包 pkg1。</p><p>Go 在进行包初始化的过程中，会采用 “深度优先” 的原则，递归初始化各个包的依赖包。在上图中，pkg1 包依赖 pkg2 包，pkg2 包依赖 pkg3 包。因为 pkg3 没有依赖包，所以在 pkg3 中 Go 会按照 “常量 -&gt; 变量 -&gt; init 函数” 的顺序先对 pkg3 包进行初始化。</p><p>紧接着，在 pkg3 包初始化完毕后，Go 会回到 pkg2 包对 pkg2 包进行初始化，然后再回到 pkg1 包对 pkg1 包进行初始化。在调用完 pkg1 包的 init 函数后，Go 就完成了 main 包的第一个依赖包 pkg1 的初始化。</p><blockquote><p>根据 Go 语言规范，一个被多个包依赖的包进会初始化一次。</p></blockquote><p>接下来，Go 会初始化 main 包的第二个依赖包 pkg4，pkg4 包饿初始化过程与 pkg1 类似，也是先初始化依赖包 pkg5，然后再初始化自身。</p><p>然后，当 Go 初始化完 pkg4 包后也就完成了对 main 包的所有依赖包的初始化，接下来初始化 main 包自身。</p><p>最后，在 main 包中，Go 同样会按照 “常量 -&gt; 变量 -&gt; init 函数” 的顺序进行初始化，执行完这些初始化工作后才正式进入程序的入口 main 函数。</p><p>简而言之，Go 包的初始化次序并不难，只需要记住下面这三点就可以：</p><ul><li>依赖包按照 “深度优先” 的次序进行初始化；</li><li>每个包内以 “常量 -&gt; 变量 -&gt; init 函数” 的顺序进行初始化；</li><li>包内的多个 init 函数按出现次数进行调用。</li></ul><h3 id="init-函数应用场景" tabindex="-1">init 函数应用场景 <a class="header-anchor" href="#init-函数应用场景" aria-label="Permalink to &quot;init 函数应用场景&quot;">​</a></h3><p>init 的应用场景与 init 函数在 Go 包初始化过程中的次序密不可分。前面我们也讲过，Go 包在初始化时，init 函数的初始化次序在变量之后，这也意味着开发人员在 init 函数中对包级变量进行进一步检查和操作。</p><h4 id="重置包级变量" tabindex="-1">重置包级变量 <a class="header-anchor" href="#重置包级变量" aria-label="Permalink to &quot;重置包级变量&quot;">​</a></h4><p>首先我们来看 init 函数的第一个常用用途：重置包级变量值。</p><p>init 函数可以对包内部以及暴露到外部的包级数据（主要是包级变量）的初始状态进行检查。在 Go 标准库中，我们可以发现很多 init 函数被用于检查包级变量初始状态的例子，例如标准库 flag 包就是其中的一个。</p><p>flag 包定义了一个导出的包级变量 CommandLine，如果用户没有通过 flag.newFlagSet 创建新的代表命令行标志集合的实例，那么 CommandLine 就会作为 flag 导出函数背后的默认值。</p><p>在 flag 包初始化的时候，由于 init 函数初始化次序在包级变量之后，因此包级变量 CommandLine 会在 init 函数之前被初始化。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> CommandLine </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">NewFlagSet</span><span style="color:#E1E4E8;">(os.Args[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">], ExitOnError)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NewFlagSet</span><span style="color:#E1E4E8;">(name </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">, errorHandling ErrorHandling) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">FlagSet {</span></span>
<span class="line"><span style="color:#E1E4E8;">    f </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">FlagSet{</span></span>
<span class="line"><span style="color:#E1E4E8;">        name:          name,</span></span>
<span class="line"><span style="color:#E1E4E8;">        errorHandling: errorHandling,</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    f.Usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> f.defaultUsage</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> f</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> (f </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">FlagSet) </span><span style="color:#B392F0;">defaultUsage</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> f.name </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        fmt.</span><span style="color:#79B8FF;">Fprintf</span><span style="color:#E1E4E8;">(f.</span><span style="color:#79B8FF;">Output</span><span style="color:#E1E4E8;">(), </span><span style="color:#9ECBFF;">&quot;Usage:</span><span style="color:#79B8FF;">\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    } </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        fmt.</span><span style="color:#79B8FF;">Fprintf</span><span style="color:#E1E4E8;">(f.</span><span style="color:#79B8FF;">Output</span><span style="color:#E1E4E8;">(), </span><span style="color:#9ECBFF;">&quot;Usage of </span><span style="color:#79B8FF;">%s</span><span style="color:#9ECBFF;">:</span><span style="color:#79B8FF;">\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, f.name)</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    f.</span><span style="color:#79B8FF;">PrintDefaults</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> CommandLine </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">NewFlagSet</span><span style="color:#24292E;">(os.Args[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">], ExitOnError)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NewFlagSet</span><span style="color:#24292E;">(name </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">, errorHandling ErrorHandling) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">FlagSet {</span></span>
<span class="line"><span style="color:#24292E;">    f </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">FlagSet{</span></span>
<span class="line"><span style="color:#24292E;">        name:          name,</span></span>
<span class="line"><span style="color:#24292E;">        errorHandling: errorHandling,</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    f.Usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> f.defaultUsage</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> f</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> (f </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">FlagSet) </span><span style="color:#6F42C1;">defaultUsage</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> f.name </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        fmt.</span><span style="color:#005CC5;">Fprintf</span><span style="color:#24292E;">(f.</span><span style="color:#005CC5;">Output</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;Usage:</span><span style="color:#005CC5;">\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    } </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        fmt.</span><span style="color:#005CC5;">Fprintf</span><span style="color:#24292E;">(f.</span><span style="color:#005CC5;">Output</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;Usage of </span><span style="color:#005CC5;">%s</span><span style="color:#032F62;">:</span><span style="color:#005CC5;">\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, f.name)</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    f.</span><span style="color:#005CC5;">PrintDefaults</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们可以看到，在通过 NewFlagSet 创建 CommandLine 变量绑定的 FlagSet 类型实例时，CommandLine 的 Usage 字段被赋值为 defaultUsage。如果保持现状，那么使用 flag 包默认 CommandLine 的用户就无法自定义 usage 的输出。于是，flag 包在 init 函数中重置了 CommandLine 的 Usage 字段：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    CommandLine.Usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> commandLineUsage </span><span style="color:#6A737D;">// 重置CommandLine的Usage字段</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">commandLineUsage</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">Usage</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> Usage </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">func</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    fmt.</span><span style="color:#79B8FF;">Fprintf</span><span style="color:#E1E4E8;">(CommandLine.</span><span style="color:#79B8FF;">Output</span><span style="color:#E1E4E8;">(), </span><span style="color:#9ECBFF;">&quot;Usage of </span><span style="color:#79B8FF;">%s</span><span style="color:#9ECBFF;">:</span><span style="color:#79B8FF;">\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, os.Args[</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">])</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">PrintDefaults</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    CommandLine.Usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> commandLineUsage </span><span style="color:#6A737D;">// 重置CommandLine的Usage字段</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">commandLineUsage</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">Usage</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> Usage </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">func</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    fmt.</span><span style="color:#005CC5;">Fprintf</span><span style="color:#24292E;">(CommandLine.</span><span style="color:#005CC5;">Output</span><span style="color:#24292E;">(), </span><span style="color:#032F62;">&quot;Usage of </span><span style="color:#005CC5;">%s</span><span style="color:#032F62;">:</span><span style="color:#005CC5;">\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, os.Args[</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">])</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">PrintDefaults</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>通过上面代码我们可以发现，CommandLine 的 Usage 字段，设置了一个 flag 包内的未导出函数 commandLineUsage，后者使用 flag 包的 Usage 变量。这样，就通过 init 函数，将 CommandLine 与包变量 Usage 关联在一起。</p><p>然后，当用户将自定义的 usage 赋值给 flag.Usage 后，就相当于改变了默认代表命令行标志集合的 CommandLine 变量的 Usage。这样当 flag 包完成初始化后，CommandLine 变量就处于一个合理可用的状态。</p><h4 id="包级变量初始化" tabindex="-1">包级变量初始化 <a class="header-anchor" href="#包级变量初始化" aria-label="Permalink to &quot;包级变量初始化&quot;">​</a></h4><p>有些包级变量需要一个比较复杂的初始化过程，有些时候，使用它的类型零值（每个 Go 类型都具有一个零值定义）或通过简单初始化表达式不能满足业务逻辑要求，这时我们可以通过 init 函数对包级变量进行初始，在 标准库 http 包中就有这样一个示例：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    http2VerboseLogs    </span><span style="color:#F97583;">bool</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 初始化时默认值为 false</span></span>
<span class="line"><span style="color:#E1E4E8;">    http2logFrameWrites </span><span style="color:#F97583;">bool</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 初始化时默认值为 false</span></span>
<span class="line"><span style="color:#E1E4E8;">    http2logFrameReads  </span><span style="color:#F97583;">bool</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 初始化时默认值为 false</span></span>
<span class="line"><span style="color:#E1E4E8;">    http2inTests        </span><span style="color:#F97583;">bool</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 初始化时默认值为 false</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    e </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">Getenv</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;GODEBUG&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> strings.</span><span style="color:#79B8FF;">Contains</span><span style="color:#E1E4E8;">(e, </span><span style="color:#9ECBFF;">&quot;http2debug=1&quot;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        http2VerboseLogs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 在 init 中对 http2VerboseLogs 的值进行重置</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> strings.</span><span style="color:#79B8FF;">Contains</span><span style="color:#E1E4E8;">(e, </span><span style="color:#9ECBFF;">&quot;http2debug=2&quot;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">        http2VerboseLogs </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 在 init中 对 http2VerboseLogs 的值进行重置</span></span>
<span class="line"><span style="color:#E1E4E8;">        http2logFrameWrites </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 在 init 中对 http2logFrameWrites 的值进行重置</span></span>
<span class="line"><span style="color:#E1E4E8;">        http2logFrameReads </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 在i nit中 对 http2logFrameReads 的值进行重置</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    http2VerboseLogs    </span><span style="color:#D73A49;">bool</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 初始化时默认值为 false</span></span>
<span class="line"><span style="color:#24292E;">    http2logFrameWrites </span><span style="color:#D73A49;">bool</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 初始化时默认值为 false</span></span>
<span class="line"><span style="color:#24292E;">    http2logFrameReads  </span><span style="color:#D73A49;">bool</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 初始化时默认值为 false</span></span>
<span class="line"><span style="color:#24292E;">    http2inTests        </span><span style="color:#D73A49;">bool</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 初始化时默认值为 false</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    e </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">Getenv</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;GODEBUG&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> strings.</span><span style="color:#005CC5;">Contains</span><span style="color:#24292E;">(e, </span><span style="color:#032F62;">&quot;http2debug=1&quot;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        http2VerboseLogs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 在 init 中对 http2VerboseLogs 的值进行重置</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> strings.</span><span style="color:#005CC5;">Contains</span><span style="color:#24292E;">(e, </span><span style="color:#032F62;">&quot;http2debug=2&quot;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">        http2VerboseLogs </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 在 init中 对 http2VerboseLogs 的值进行重置</span></span>
<span class="line"><span style="color:#24292E;">        http2logFrameWrites </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 在 init 中对 http2logFrameWrites 的值进行重置</span></span>
<span class="line"><span style="color:#24292E;">        http2logFrameReads </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 在i nit中 对 http2logFrameReads 的值进行重置</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们可以看到，标准库 http 包定义了一系列布尔类型的特性开关变量，它们默认处于关闭状态（即值为 false），但我们可以通过 GODEBUG 环境变量值，开启相关特性开关。然后在 init 函数中，根据环境变量 GODEBUG 的值，对这些包级开关变量进行初始化。</p><h4 id="实现-注册模式" tabindex="-1">实现 “注册模式” <a class="header-anchor" href="#实现-注册模式" aria-label="Permalink to &quot;实现 “注册模式”&quot;">​</a></h4><p>为了便于我们更好理解，我们先来看一段使用 lib/pq 包访问 PostgreSQL 数据库的代码示例：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">database/sql</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">_</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">github.com/lib/pq</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    db, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> sql.</span><span style="color:#79B8FF;">Open</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;user=pqgotest dbname=pqgotest sslmode=verify-full&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        log.</span><span style="color:#79B8FF;">Fatal</span><span style="color:#E1E4E8;">(err)</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span></span>
<span class="line"><span style="color:#E1E4E8;">    age </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">21</span></span>
<span class="line"><span style="color:#E1E4E8;">    rows, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> db.</span><span style="color:#79B8FF;">Query</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;SELECT name FROM users WHERE age = $1&quot;</span><span style="color:#E1E4E8;">, age)</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">database/sql</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">_</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">github.com/lib/pq</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    db, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> sql.</span><span style="color:#005CC5;">Open</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;user=pqgotest dbname=pqgotest sslmode=verify-full&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        log.</span><span style="color:#005CC5;">Fatal</span><span style="color:#24292E;">(err)</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    </span></span>
<span class="line"><span style="color:#24292E;">    age </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">21</span></span>
<span class="line"><span style="color:#24292E;">    rows, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> db.</span><span style="color:#005CC5;">Query</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;SELECT name FROM users WHERE age = $1&quot;</span><span style="color:#24292E;">, age)</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">...</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>示例代码中是以空导入的方式引入 lib/pq 包，main 函数中并没有使用 pq 包的任何变量、函数或方法，这样就实现了对 PostgreSQL 数据库的访问。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    sql.</span><span style="color:#79B8FF;">Register</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;postgres&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">Driver{})</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    sql.</span><span style="color:#005CC5;">Register</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;postgres&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">Driver{})</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>上述效果实现原理其实就是 init 函数，init 函数会在 pq 包初始化的时候得以执行。在 pq 包的 init 函数中，pq 包将自己实现的 sql 驱动注册到 sql 包中。这样主要应用层代码在 Open 数据库的时候，传入驱动的名称（这里是 “postgress”），那么通过 sql.Open 函数，返回的数据库实例句柄对数据库进行的操作，实际上调用的都是 pq 包中相应的驱动实现。</p><p>这种通过在 init 函数中注册自己实现的模式，可以有效降低 Go 包对外的直接暴露，尤其是包级变量的暴露，从而避免外部影响内部状态。</p><p>另外，从标准库 database/sql 包的角度来看，这种 “注册模式” 实质上是一种工厂设计模式的实现，sql.Open 函数就是这个模式中的工厂方法，它根据外部传入的驱动名称 “生产” 出不同类别的数据库实例句柄。</p><p>这种 “注册模式” 在其他标准库中也有广泛应用，例如，使用标准库 image 包获取各种格式图片的宽和高。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">fmt</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">image</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">_</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">image/gif</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 以空导入方式注入 gif 图片格式驱动</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">_</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">image/jpeg</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 以空导入方式注入 jpeg 图片格式驱动</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#B392F0;">_</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">image/png</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 以空导入方式注入 png 图片格式驱动</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">os</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 支持png, jpeg, gif</span></span>
<span class="line"><span style="color:#E1E4E8;">    width, height, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">imageSize</span><span style="color:#E1E4E8;">(os.Args[</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">]) </span><span style="color:#6A737D;">// 获取传入的图片文件的宽与高</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;get image size error:&quot;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">    fmt.</span><span style="color:#79B8FF;">Printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;image size: [</span><span style="color:#79B8FF;">%d</span><span style="color:#9ECBFF;">, </span><span style="color:#79B8FF;">%d</span><span style="color:#9ECBFF;">]</span><span style="color:#79B8FF;">\n</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, width, height)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">imageSize</span><span style="color:#E1E4E8;">(imageFile </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">) (</span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    f, _ </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> os.</span><span style="color:#79B8FF;">Open</span><span style="color:#E1E4E8;">(imageFile) </span><span style="color:#6A737D;">// 打开图文文件</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">defer</span><span style="color:#E1E4E8;"> f.</span><span style="color:#79B8FF;">Close</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    img, _, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> image.</span><span style="color:#79B8FF;">Decode</span><span style="color:#E1E4E8;">(f) </span><span style="color:#6A737D;">// 对文件进行解码，得到图片实例</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, err</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">    b </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> img.</span><span style="color:#79B8FF;">Bounds</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">// 返回图片区域</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> b.Max.X, b.Max.Y, </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">fmt</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">image</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">_</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">image/gif</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 以空导入方式注入 gif 图片格式驱动</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">_</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">image/jpeg</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 以空导入方式注入 jpeg 图片格式驱动</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6F42C1;">_</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">image/png</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 以空导入方式注入 png 图片格式驱动</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">os</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 支持png, jpeg, gif</span></span>
<span class="line"><span style="color:#24292E;">    width, height, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">imageSize</span><span style="color:#24292E;">(os.Args[</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">]) </span><span style="color:#6A737D;">// 获取传入的图片文件的宽与高</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;get image size error:&quot;</span><span style="color:#24292E;">, err)</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">    fmt.</span><span style="color:#005CC5;">Printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;image size: [</span><span style="color:#005CC5;">%d</span><span style="color:#032F62;">, </span><span style="color:#005CC5;">%d</span><span style="color:#032F62;">]</span><span style="color:#005CC5;">\n</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, width, height)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">imageSize</span><span style="color:#24292E;">(imageFile </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">) (</span><span style="color:#D73A49;">int</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">    f, _ </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> os.</span><span style="color:#005CC5;">Open</span><span style="color:#24292E;">(imageFile) </span><span style="color:#6A737D;">// 打开图文文件</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">defer</span><span style="color:#24292E;"> f.</span><span style="color:#005CC5;">Close</span><span style="color:#24292E;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    img, _, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> image.</span><span style="color:#005CC5;">Decode</span><span style="color:#24292E;">(f) </span><span style="color:#6A737D;">// 对文件进行解码，得到图片实例</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, err</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">    b </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> img.</span><span style="color:#005CC5;">Bounds</span><span style="color:#24292E;">() </span><span style="color:#6A737D;">// 返回图片区域</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> b.Max.X, b.Max.Y, </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>上面这个示例程序支持 png、jpeg、gif 三种格式的图片。实现这一效果的原因是，在 image/png、image/jpeg 和 image/gif 包各自的 init 函数中，都将自己 “注册” 到 image 的支持格式列表中。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// $GOROOT/src/image/png/reader.go</span></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    image.</span><span style="color:#79B8FF;">RegisterFormat</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;png&quot;</span><span style="color:#E1E4E8;">, pngHeader, Decode, DecodeConfig)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// $GOROOT/src/image/jpeg/reader.go</span></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    image.</span><span style="color:#79B8FF;">RegisterFormat</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;jpeg&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#79B8FF;">\xff\xd8</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, Decode, DecodeConfig)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// $GOROOT/src/image/gif/reader.go</span></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">    image.</span><span style="color:#79B8FF;">RegisterFormat</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;gif&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;GIF8?a&quot;</span><span style="color:#E1E4E8;">, Decode, DecodeConfig)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// $GOROOT/src/image/png/reader.go</span></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    image.</span><span style="color:#005CC5;">RegisterFormat</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;png&quot;</span><span style="color:#24292E;">, pngHeader, Decode, DecodeConfig)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// $GOROOT/src/image/jpeg/reader.go</span></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    image.</span><span style="color:#005CC5;">RegisterFormat</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;jpeg&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;</span><span style="color:#005CC5;">\xff\xd8</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, Decode, DecodeConfig)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// $GOROOT/src/image/gif/reader.go</span></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">    image.</span><span style="color:#005CC5;">RegisterFormat</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;gif&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;GIF8?a&quot;</span><span style="color:#24292E;">, Decode, DecodeConfig)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="总结-7" tabindex="-1">总结 <a class="header-anchor" href="#总结-7" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>本篇文章中，我们一起了解了 Go 应用的用户层入口函数 main.main、包初始化函数 init，还有 Go 程序包的初始化次序和包内各种语法元素的初始化次序。</p><p>我们需要重点关注 init 函数具备的几种行为特征：</p><ul><li>执行顺序排序包内其他语法元素后面；</li><li>每个 init 函数在整个 Go 程序生命周期内仅会被执行一次；</li><li>init 函数是顺序执行的，只有当 init 函数执行完毕后，才会去执行下一个 init 函数。</li></ul><p>基于上面这些特征，init 函数十分适合做一些包级数据初始化工作以及包级数据初始状态的检查工作。</p><p>最后，我们还需要注意一点，大多 Go 程序都是并发程序，程序会启动多个 Goroutine 并发执行程序逻辑，这里你一定要注意主 Goroutine 的执行状态，需要根据实际情况决定，是否需要等待其他子 goroutine 做完清理收尾工作退出后再执行退出。</p><h2 id="_09、构建-web-服务" tabindex="-1">09、构建 Web 服务 <a class="header-anchor" href="#_09、构建-web-服务" aria-label="Permalink to &quot;09、构建 Web 服务&quot;">​</a></h2><p>根据 <a href="https://go.dev/blog/survey2021-results" target="_blank" rel="noreferrer">Go 官方用户 2021 调查报告</a> ，可以得到 Go 应用最广泛的领域调查结果图。</p><img src="/notes/assets/go_use.0c26d19e.png"><p>我们可以看到，在 Go 应用的前 4 个领域中，有两个都是 Web 服务相关的。一个是排在第一位的 API/RPC 服务，另一个是排在第四位的 Web 服务。</p><h3 id="简易-web-服务" tabindex="-1">简易 Web 服务 <a class="header-anchor" href="#简易-web-服务" aria-label="Permalink to &quot;简易 Web 服务&quot;">​</a></h3><p>Go 具有 “面向工程” 的特性，它提供了完善的工具链和标准库，使得 Go 程序大大减少对第三方包的依赖。我们可以基于 Go 标准库的 net/http 包，轻松构建一个承载 Web 内容传输的 HTTP 服务。</p><p>首先我们建立 simple-http-server 目录，并创建 Go Module：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">mkdir simple-http-server</span></span>
<span class="line"><span style="color:#e1e4e8;">cd simple-http-server</span></span>
<span class="line"><span style="color:#e1e4e8;">go mod init simple-http-server</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">mkdir simple-http-server</span></span>
<span class="line"><span style="color:#24292e;">cd simple-http-server</span></span>
<span class="line"><span style="color:#24292e;">go mod init simple-http-server</span></span></code></pre></div><p>因为这个 HTTP 服务比较简单，我们可以采用最简项目布局，直接在项目根目录下创建 main.go 源文件：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">net/http</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	http.</span><span style="color:#79B8FF;">HandleFunc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">func</span><span style="color:#E1E4E8;">(w http.ResponseWriter, r </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">http.Request) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		w.</span><span style="color:#79B8FF;">Write</span><span style="color:#E1E4E8;">([]</span><span style="color:#79B8FF;">byte</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, world&quot;</span><span style="color:#E1E4E8;">))</span></span>
<span class="line"><span style="color:#E1E4E8;">	})</span></span>
<span class="line"><span style="color:#E1E4E8;">	http.</span><span style="color:#79B8FF;">ListenAndServe</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;:8080&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">net/http</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	http.</span><span style="color:#005CC5;">HandleFunc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">func</span><span style="color:#24292E;">(w http.ResponseWriter, r </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">http.Request) {</span></span>
<span class="line"><span style="color:#24292E;">		w.</span><span style="color:#005CC5;">Write</span><span style="color:#24292E;">([]</span><span style="color:#005CC5;">byte</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, world&quot;</span><span style="color:#24292E;">))</span></span>
<span class="line"><span style="color:#24292E;">	})</span></span>
<span class="line"><span style="color:#24292E;">	http.</span><span style="color:#005CC5;">ListenAndServe</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;:8080&quot;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>以上就是一个最简单的 HTTP 服务实现。在这个实现中，我们只使用 Go 标准库的 http 包。</p><p>这段代码有两个重要的函数，一个是 ListenAndServe，另一个是 HandleFunc。</p><p>我们通过 http 包提供的 ListenAndServe 函数，建立起 HTTP 服务，这个服务监听本地 8080 端口。客户端可以通过这个端口与服务建立链接，发送 HTTP 请求即可得到相应的响应结果。</p><p>在代码中，我们还为 web 服务设置了一个处理函数。这个函数的函数原型如下：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;">(w http.ResponseWriter, r </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">http.Request)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;">(w http.ResponseWriter, r </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">http.Request)</span></span></code></pre></div><p>这个函数里有两个参数，w 和 r。r 代表来自客户端的 HTTP 请求，w 代表返回客户端的应答，基于 http 包实现的 HTTP 服务都应该符合这一原型。</p><p>我们可以编译运行这个程序，并用 curl 命令行工具模拟客户端，向上述服务发送 http 请求：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go build</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">./simple-htt-server</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go build</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">./simple-htt-server</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curl localhost:8080/</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">hello, world</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curl localhost:8080/</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">hello, world</span></span></code></pre></div><p>至此，一个简易的 HTTP 服务就构建成功了。</p><h3 id="图书管理-api-服务" tabindex="-1">图书管理 API 服务 <a class="header-anchor" href="#图书管理-api-服务" aria-label="Permalink to &quot;图书管理 API 服务&quot;">​</a></h3><p>在前面我们建立起一个简易的 HTTP 服务，现在我们再来构建一个实战小项目，一个更接近于真实业务的图书管理 API 服务。</p><p>在这个项目中，我们模拟的是一个书店的图书管理后端服务。这个服务为平台前端以及其他客户端，提供针对图书的 CRUD 的基于 HTTP 协议的 API。</p><p>API 采用 RESTful 风格设计，服务提供的 API 集合如下：</p><table><thead><tr><th>HTTP 方法</th><th>请求路径</th><th>API 作用</th></tr></thead><tbody><tr><td>POST</td><td>/book</td><td>创建图书条目</td></tr><tr><td>POST</td><td>/book/:id</td><td>更新图书条目</td></tr><tr><td>GET</td><td>/book/:id</td><td>返回图书条目信息</td></tr><tr><td>GET</td><td>/book</td><td>返回所有图书条目信息</td></tr><tr><td>DELETE</td><td>/book/:id</td><td>删除图书条目</td></tr></tbody></table><h4 id="布局设计" tabindex="-1">布局设计 <a class="header-anchor" href="#布局设计" aria-label="Permalink to &quot;布局设计&quot;">​</a></h4><p>首先我们需要创建一个名为 bookstore 的 Go 项目并创建对应的 Go Module。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">mkdir bookstore</span></span>
<span class="line"><span style="color:#e1e4e8;">cd bookstore</span></span>
<span class="line"><span style="color:#e1e4e8;">go mod init bookstore</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">mkdir bookstore</span></span>
<span class="line"><span style="color:#24292e;">cd bookstore</span></span>
<span class="line"><span style="color:#24292e;">go mod init bookstore</span></span></code></pre></div><p>我们可以把这个服务拆分为两部分。</p><ul><li>一部分是 HTTP 服务器，用来对外提供 API 服务</li><li>一部分是图书数据存储模块，存储图书数据。</li></ul><p>同时，这是一个构建可执行程序为目的的 Go 项目，我们可以把项目结构布局设计成这样：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">├── cmd/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── bookstore/         // 放置 bookstore main 包源码</span></span>
<span class="line"><span style="color:#e1e4e8;">│       └── main.go</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go.mod                 // module bookstore 的 go.mod</span></span>
<span class="line"><span style="color:#e1e4e8;">├── go.sum</span></span>
<span class="line"><span style="color:#e1e4e8;">├── internal/              // 存放项目内部包的目录</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── store/</span></span>
<span class="line"><span style="color:#e1e4e8;">│       └── memstore.go     </span></span>
<span class="line"><span style="color:#e1e4e8;">├── server/                // HTTP 服务器模块</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├── middleware/</span></span>
<span class="line"><span style="color:#e1e4e8;">│   │   └── middleware.go</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └── server.go          </span></span>
<span class="line"><span style="color:#e1e4e8;">└── store/                 // 图书数据存储模块</span></span>
<span class="line"><span style="color:#e1e4e8;">    ├── factory/</span></span>
<span class="line"><span style="color:#e1e4e8;">    │   └── factory.go</span></span>
<span class="line"><span style="color:#e1e4e8;">    └── store.go</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">├── cmd/</span></span>
<span class="line"><span style="color:#24292e;">│   └── bookstore/         // 放置 bookstore main 包源码</span></span>
<span class="line"><span style="color:#24292e;">│       └── main.go</span></span>
<span class="line"><span style="color:#24292e;">├── go.mod                 // module bookstore 的 go.mod</span></span>
<span class="line"><span style="color:#24292e;">├── go.sum</span></span>
<span class="line"><span style="color:#24292e;">├── internal/              // 存放项目内部包的目录</span></span>
<span class="line"><span style="color:#24292e;">│   └── store/</span></span>
<span class="line"><span style="color:#24292e;">│       └── memstore.go     </span></span>
<span class="line"><span style="color:#24292e;">├── server/                // HTTP 服务器模块</span></span>
<span class="line"><span style="color:#24292e;">│   ├── middleware/</span></span>
<span class="line"><span style="color:#24292e;">│   │   └── middleware.go</span></span>
<span class="line"><span style="color:#24292e;">│   └── server.go          </span></span>
<span class="line"><span style="color:#24292e;">└── store/                 // 图书数据存储模块</span></span>
<span class="line"><span style="color:#24292e;">    ├── factory/</span></span>
<span class="line"><span style="color:#24292e;">    │   └── factory.go</span></span>
<span class="line"><span style="color:#24292e;">    └── store.go</span></span></code></pre></div><h4 id="项目-main-包" tabindex="-1">项目 main 包 <a class="header-anchor" href="#项目-main-包" aria-label="Permalink to &quot;项目 main 包&quot;">​</a></h4><p>main 包是主包，下面是 main 包的逻辑实现图。</p><img src="/notes/assets/store_main.0c3112aa.png"><p>下面是 main 包 main.go 的所有代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">_</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">bookstore/internal/store</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">bookstore/server</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">bookstore/store/factory</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">context</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">log</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">os</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">os/signal</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">syscall</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">time</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	s, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> factory.</span><span style="color:#79B8FF;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;mem&quot;</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 创建图书数据存储模块实例</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">panic</span><span style="color:#E1E4E8;">(err)</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	srv </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> server.</span><span style="color:#79B8FF;">NewBookStoreServer</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;:8080&quot;</span><span style="color:#E1E4E8;">, s) </span><span style="color:#6A737D;">// 创建 http 服务实例</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	errChan, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> srv.</span><span style="color:#79B8FF;">ListenAndServe</span><span style="color:#E1E4E8;">() </span><span style="color:#6A737D;">// 运行 http 服务</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		log.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;web server start failed:&quot;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	log.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;web server start ok&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	c </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">make</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">chan</span><span style="color:#E1E4E8;"> os.Signal, </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	signal.</span><span style="color:#79B8FF;">Notify</span><span style="color:#E1E4E8;">(c, syscall.SIGINT, syscall.SIGTERM)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> { </span><span style="color:#6A737D;">// 监视来自 errChan 以及 c 的事件</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;-</span><span style="color:#E1E4E8;">errChan:</span></span>
<span class="line"><span style="color:#E1E4E8;">		log.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;web server run failed:&quot;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;-</span><span style="color:#E1E4E8;">c:</span></span>
<span class="line"><span style="color:#E1E4E8;">		log.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;bookstore program is exiting...&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">		ctx, cf </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> context.</span><span style="color:#79B8FF;">WithTimeout</span><span style="color:#E1E4E8;">(context.</span><span style="color:#79B8FF;">Background</span><span style="color:#E1E4E8;">(), time.Second)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">defer</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">cf</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">		err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> srv.</span><span style="color:#79B8FF;">Shutdown</span><span style="color:#E1E4E8;">(ctx) </span><span style="color:#6A737D;">// 优雅关闭 http 服务实例</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		log.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;bookstore program exit error:&quot;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	log.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;bookstore program exit ok&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">_</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">bookstore/internal/store</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">bookstore/server</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">bookstore/store/factory</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">context</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">log</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">os</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">os/signal</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">syscall</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">time</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	s, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> factory.</span><span style="color:#005CC5;">New</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;mem&quot;</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 创建图书数据存储模块实例</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">panic</span><span style="color:#24292E;">(err)</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	srv </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> server.</span><span style="color:#005CC5;">NewBookStoreServer</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;:8080&quot;</span><span style="color:#24292E;">, s) </span><span style="color:#6A737D;">// 创建 http 服务实例</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	errChan, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> srv.</span><span style="color:#005CC5;">ListenAndServe</span><span style="color:#24292E;">() </span><span style="color:#6A737D;">// 运行 http 服务</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		log.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;web server start failed:&quot;</span><span style="color:#24292E;">, err)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	log.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;web server start ok&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	c </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">make</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">chan</span><span style="color:#24292E;"> os.Signal, </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	signal.</span><span style="color:#005CC5;">Notify</span><span style="color:#24292E;">(c, syscall.SIGINT, syscall.SIGTERM)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> { </span><span style="color:#6A737D;">// 监视来自 errChan 以及 c 的事件</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;-</span><span style="color:#24292E;">errChan:</span></span>
<span class="line"><span style="color:#24292E;">		log.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;web server run failed:&quot;</span><span style="color:#24292E;">, err)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;-</span><span style="color:#24292E;">c:</span></span>
<span class="line"><span style="color:#24292E;">		log.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;bookstore program is exiting...&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">		ctx, cf </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> context.</span><span style="color:#005CC5;">WithTimeout</span><span style="color:#24292E;">(context.</span><span style="color:#005CC5;">Background</span><span style="color:#24292E;">(), time.Second)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">defer</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">cf</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">		err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> srv.</span><span style="color:#005CC5;">Shutdown</span><span style="color:#24292E;">(ctx) </span><span style="color:#6A737D;">// 优雅关闭 http 服务实例</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		log.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;bookstore program exit error:&quot;</span><span style="color:#24292E;">, err)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	log.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;bookstore program exit ok&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>在 Go 中，main 包不仅包含整个程序入口，还承担程序中主要模块初始化与组合的功能。</p><p>在我们这个程序中，主要模块就是第 16 行的创建图书存储模块实例，以及第 21 行创建 HTTP 服务模块实例。在创建 HTTP 服务模块实例时，我们将图书存储实例 s 作为参数，传递给 NewBookStoreServer 函数。</p><p>我们重点来看 main 函数的后半部分（30行 ～ 42 行），在这里我们通过监视系统信号实现了 http 服务实例的优雅退出。</p><p>所谓优雅退出，指的就是程序有机会等待其他事情处理完再退出。比如尚未完成的事务处理、清理资源（关闭文件描述符、关闭 socket）、保存必要中间状态、内存数据持久化等等。</p><p>我们通过 signal 包的 Notify 捕获了 SIGINT、SIGTERM 这两个系统信号。这样，当这两个信号中的任何一个触发时，我们的 http 服务实例都有机会在退出前做一些清理工作。</p><p>然后，我们再使用 http 服务实例（srv）自身提供的 Shutdown 方法，来实现 http 服务内部的退出清理工作，包括：立即关闭所有 listener、关闭所有空闲连接、等待处于活动状态的连接处理完毕等等。当 http 服务实例的清理工作完成后，我们整个程序就可以正常退出了。</p><h4 id="图书数据存储模块" tabindex="-1">图书数据存储模块 <a class="header-anchor" href="#图书数据存储模块" aria-label="Permalink to &quot;图书数据存储模块&quot;">​</a></h4><p>图书数据存储模块的职责很清晰，就是用来存储整个 bookstore 的图书数据。图书数据存储有多种方式，最简单的方式就是在内存中创建一个 map，以图书 id 作为 key，来保存图书信息。但如果我们在生产环境，数据要进行持久化，那么最实际的方式就是通过 Nosql 数据库甚至是关系型数据库，实现对图书数据的存储与管理。</p><p>考虑到对多种存储实现方式支持，我们可以将图书存储的相关操作，定义在一个接口类型 Store 中。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// store/store.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Book</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	Id      </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">`json:&quot;id&quot;`</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 图书 ISBN ID</span></span>
<span class="line"><span style="color:#E1E4E8;">	Name    </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">`json:&quot;name&quot;`</span><span style="color:#E1E4E8;">    </span><span style="color:#6A737D;">// 图书名称</span></span>
<span class="line"><span style="color:#E1E4E8;">	Authors []</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`json:&quot;authors&quot;`</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 图书作者</span></span>
<span class="line"><span style="color:#E1E4E8;">	Press   </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">`json:&quot;press&quot;`</span><span style="color:#E1E4E8;">   </span><span style="color:#6A737D;">// 出版社</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Store</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">Create</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">Book) </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 创建一个新图书条目</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">Update</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">Book) </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">       </span><span style="color:#6A737D;">// 更新某图书条目</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">Get</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">) (Book, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 获取某图书信息</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">GetAll</span><span style="color:#E1E4E8;">() ([]Book, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">)  </span><span style="color:#6A737D;">// 获取所有图书信息</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">Delete</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">      </span><span style="color:#6A737D;">// 删除某图书条目</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// store/store.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Book</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	Id      </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">   </span><span style="color:#032F62;">`json:&quot;id&quot;`</span><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 图书 ISBN ID</span></span>
<span class="line"><span style="color:#24292E;">	Name    </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">   </span><span style="color:#032F62;">`json:&quot;name&quot;`</span><span style="color:#24292E;">    </span><span style="color:#6A737D;">// 图书名称</span></span>
<span class="line"><span style="color:#24292E;">	Authors []</span><span style="color:#D73A49;">string</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`json:&quot;authors&quot;`</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 图书作者</span></span>
<span class="line"><span style="color:#24292E;">	Press   </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">   </span><span style="color:#032F62;">`json:&quot;press&quot;`</span><span style="color:#24292E;">   </span><span style="color:#6A737D;">// 出版社</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Store</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">Create</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">Book) </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 创建一个新图书条目</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">Update</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">Book) </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">       </span><span style="color:#6A737D;">// 更新某图书条目</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">Get</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">) (Book, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 获取某图书信息</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">GetAll</span><span style="color:#24292E;">() ([]Book, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">)  </span><span style="color:#6A737D;">// 获取所有图书信息</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">Delete</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">      </span><span style="color:#6A737D;">// 删除某图书条目</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们建立了一个对应图书条目的抽象数据类型 Book，以及针对 Book 存储的接口类型 Store。这样，对于想要进行图书数据操作的一方来说，只需要得到一个满足 Store 接口的实例，就可以实现对图书数据的存储操作，不再关心图书数据究竟采用何种存储方式。这就实现了图书存储操作与底层图书数据存储方式的解耦。这也是 Go 组合设计哲学中面向接口编程的一个重要体现。</p><p>我们可以参考《设计模式》提供的多种创建型模式，选择一种 Go 风格的工厂模式（创建型模式的一种）来实现满足 Store 接口实例的创建。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// store/factory/factory.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">	providersMu sync.RWMutex</span></span>
<span class="line"><span style="color:#E1E4E8;">	providers   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">make</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">map</span><span style="color:#E1E4E8;">[</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]store.Store)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Register</span><span style="color:#E1E4E8;">(name </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">, p store.Store) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	providersMu.</span><span style="color:#79B8FF;">Lock</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">defer</span><span style="color:#E1E4E8;"> providersMu.</span><span style="color:#79B8FF;">Unlock</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> p </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">panic</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;store: Register provider is nil&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> _, dup </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> providers[name]; dup {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">panic</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;store: Register called twice for provider &quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">+</span><span style="color:#E1E4E8;"> name)</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	providers[name] </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> p</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">New</span><span style="color:#E1E4E8;">(providerName </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">) (store.Store, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	providersMu.</span><span style="color:#79B8FF;">RLock</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">	p, ok </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> providers[providerName]</span></span>
<span class="line"><span style="color:#E1E4E8;">	providersMu.</span><span style="color:#79B8FF;">RUnlock</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">ok {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;">, fmt.</span><span style="color:#79B8FF;">Errorf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;store: unknown provider </span><span style="color:#79B8FF;">%s</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, providerName)</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> p, </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// store/factory/factory.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">	providersMu sync.RWMutex</span></span>
<span class="line"><span style="color:#24292E;">	providers   </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">make</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">map</span><span style="color:#24292E;">[</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]store.Store)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Register</span><span style="color:#24292E;">(name </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">, p store.Store) {</span></span>
<span class="line"><span style="color:#24292E;">	providersMu.</span><span style="color:#005CC5;">Lock</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">defer</span><span style="color:#24292E;"> providersMu.</span><span style="color:#005CC5;">Unlock</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> p </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">panic</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;store: Register provider is nil&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> _, dup </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> providers[name]; dup {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">panic</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;store: Register called twice for provider &quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">+</span><span style="color:#24292E;"> name)</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	providers[name] </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> p</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">New</span><span style="color:#24292E;">(providerName </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">) (store.Store, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">	providersMu.</span><span style="color:#005CC5;">RLock</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">	p, ok </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> providers[providerName]</span></span>
<span class="line"><span style="color:#24292E;">	providersMu.</span><span style="color:#005CC5;">RUnlock</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">ok {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;">, fmt.</span><span style="color:#005CC5;">Errorf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;store: unknown provider </span><span style="color:#005CC5;">%s</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, providerName)</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> p, </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这段代码模仿 Go 标准库 database/sql 的实现方式。factory 包采用 map 数据类型，满足对 Store 接口的实例类型进行管理。factory 还提供了 Register 函数，让各个实现 Store 接口的类型可以注册到工厂中。</p><p>一旦注册成功，factory 就可以生产出满足 Store 接口的类型实例。依赖 Store 接口的使用方，只需要调用 factory 包的 New 函数，再传入期望使用的图书存储实现的名称，就可以得到对应的类型实例。</p><p>在项目 interal/store 目录下，我们提供了一个基于内存 map 的 Store 接口的实现。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// internal/store/memstore.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">store</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">mystore</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">bookstore/store</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#B392F0;">factory</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">bookstore/store/factory</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">sync</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">init</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	factory.</span><span style="color:#79B8FF;">Register</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;mem&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">MemStore{</span></span>
<span class="line"><span style="color:#E1E4E8;">		books: </span><span style="color:#79B8FF;">make</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">map</span><span style="color:#E1E4E8;">[</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">mystore.Book),</span></span>
<span class="line"><span style="color:#E1E4E8;">	})</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MemStore</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	sync.RWMutex</span></span>
<span class="line"><span style="color:#E1E4E8;">	books </span><span style="color:#F97583;">map</span><span style="color:#E1E4E8;">[</span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">]</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">mystore.Book</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// internal/store/memstore.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">store</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">mystore</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">bookstore/store</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6F42C1;">factory</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">bookstore/store/factory</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">sync</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">init</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	factory.</span><span style="color:#005CC5;">Register</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;mem&quot;</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">MemStore{</span></span>
<span class="line"><span style="color:#24292E;">		books: </span><span style="color:#005CC5;">make</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">map</span><span style="color:#24292E;">[</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">mystore.Book),</span></span>
<span class="line"><span style="color:#24292E;">	})</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MemStore</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	sync.RWMutex</span></span>
<span class="line"><span style="color:#24292E;">	books </span><span style="color:#D73A49;">map</span><span style="color:#24292E;">[</span><span style="color:#D73A49;">string</span><span style="color:#24292E;">]</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">mystore.Book</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>从代码中可以看到，在 init 函数中我们调用 factory 包提供的 Register 函数，将自己的实例以 “mem” 的名称注册到 factory 中。</p><p>这样做还有一个好处，依赖 Store 接口进行图书数据管理的一方，只需要导入 intenal/store 这个包，就可以完成自动注册。</p><h4 id="http-服务模块" tabindex="-1">HTTP 服务模块 <a class="header-anchor" href="#http-服务模块" aria-label="Permalink to &quot;HTTP 服务模块&quot;">​</a></h4><p>HTTP 服务模块的职责就是对外提供 API 服务，处理客户端请求，并通过 Store 接口实例执行对图书数据的相关操作。</p><p>首先，我们抽象处理一个 server 包，这个包中定义了一个 BookStoreServer 类型：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// server/server.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BookStoreServer</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	s   store.Store</span></span>
<span class="line"><span style="color:#E1E4E8;">	srv </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">http.Server</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// server/server.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BookStoreServer</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	s   store.Store</span></span>
<span class="line"><span style="color:#24292E;">	srv </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">http.Server</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这个类型实质上就是一个标准库的 http.Server，并且组合了 store.Store 接口的能力。server 包提供 NewBookStoreServer 函数，用来创建 BookStoreServer 类型实例：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// server/server.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NewBookStoreServer</span><span style="color:#E1E4E8;">(addr </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">, s store.Store) </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">BookStoreServer {</span></span>
<span class="line"><span style="color:#E1E4E8;">	srv </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">BookStoreServer{</span></span>
<span class="line"><span style="color:#E1E4E8;">		s: s,</span></span>
<span class="line"><span style="color:#E1E4E8;">		srv: </span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">http.Server{</span></span>
<span class="line"><span style="color:#E1E4E8;">			Addr: addr,</span></span>
<span class="line"><span style="color:#E1E4E8;">		},</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	router </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> mux.</span><span style="color:#79B8FF;">NewRouter</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">	router.</span><span style="color:#79B8FF;">HandleFunc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/book&quot;</span><span style="color:#E1E4E8;">, srv.createBookHandler).</span><span style="color:#79B8FF;">Methods</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;POST&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	router.</span><span style="color:#79B8FF;">HandleFunc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/book/{id}&quot;</span><span style="color:#E1E4E8;">, srv.updateBookHandler).</span><span style="color:#79B8FF;">Methods</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;POST&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	router.</span><span style="color:#79B8FF;">HandleFunc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/book/{id}&quot;</span><span style="color:#E1E4E8;">, srv.getBookHandler).</span><span style="color:#79B8FF;">Methods</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;GET&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	router.</span><span style="color:#79B8FF;">HandleFunc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/book&quot;</span><span style="color:#E1E4E8;">, srv.getAllBooksHandler).</span><span style="color:#79B8FF;">Methods</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;GET&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	router.</span><span style="color:#79B8FF;">HandleFunc</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;/book/{id}&quot;</span><span style="color:#E1E4E8;">, srv.delBookHandler).</span><span style="color:#79B8FF;">Methods</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;DELETE&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	srv.srv.Handler </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> middleware.</span><span style="color:#79B8FF;">Logging</span><span style="color:#E1E4E8;">(middleware.</span><span style="color:#79B8FF;">Validating</span><span style="color:#E1E4E8;">(router))</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> srv</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// server/server.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NewBookStoreServer</span><span style="color:#24292E;">(addr </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">, s store.Store) </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">BookStoreServer {</span></span>
<span class="line"><span style="color:#24292E;">	srv </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">BookStoreServer{</span></span>
<span class="line"><span style="color:#24292E;">		s: s,</span></span>
<span class="line"><span style="color:#24292E;">		srv: </span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">http.Server{</span></span>
<span class="line"><span style="color:#24292E;">			Addr: addr,</span></span>
<span class="line"><span style="color:#24292E;">		},</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	router </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> mux.</span><span style="color:#005CC5;">NewRouter</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">	router.</span><span style="color:#005CC5;">HandleFunc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/book&quot;</span><span style="color:#24292E;">, srv.createBookHandler).</span><span style="color:#005CC5;">Methods</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;POST&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	router.</span><span style="color:#005CC5;">HandleFunc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/book/{id}&quot;</span><span style="color:#24292E;">, srv.updateBookHandler).</span><span style="color:#005CC5;">Methods</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;POST&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	router.</span><span style="color:#005CC5;">HandleFunc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/book/{id}&quot;</span><span style="color:#24292E;">, srv.getBookHandler).</span><span style="color:#005CC5;">Methods</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;GET&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	router.</span><span style="color:#005CC5;">HandleFunc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/book&quot;</span><span style="color:#24292E;">, srv.getAllBooksHandler).</span><span style="color:#005CC5;">Methods</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;GET&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	router.</span><span style="color:#005CC5;">HandleFunc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;/book/{id}&quot;</span><span style="color:#24292E;">, srv.delBookHandler).</span><span style="color:#005CC5;">Methods</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;DELETE&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	srv.srv.Handler </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> middleware.</span><span style="color:#005CC5;">Logging</span><span style="color:#24292E;">(middleware.</span><span style="color:#005CC5;">Validating</span><span style="color:#24292E;">(router))</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> srv</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们可以看到， 函数 NewBookStoreServer 接受两个参数，一个是 HTTP 服务监听的服务地址，另一个是实现了 store.Store 接口的类型实例。这样函数原型设计是 Go 语言常用的一种设计方法，即接受一个接口类型参数，返回一个具体类型。返回的具体类型组合传入接口类型的能力。</p><p>除此之外，我们还需要为 HTTP 服务器设置请求处理函数。在这里，我们借助第三方包 github.com/gorilla/mux 来实现我们的需求。</p><p>在上面代码的第 11 行到 16 行，我们针对不同 URI 路径模式设置了不同的处理函数。我们以 createBookHandler 和 getBookHandler 为例来看下这些处理函数的实现。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// server/server.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> (bs </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">BookStoreServer) </span><span style="color:#B392F0;">createBookHandler</span><span style="color:#E1E4E8;">(w http.ResponseWriter, req </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">http.Request) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	dec </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> json.</span><span style="color:#79B8FF;">NewDecoder</span><span style="color:#E1E4E8;">(req.Body)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> book store.Book</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> dec.</span><span style="color:#79B8FF;">Decode</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">book); err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		http.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(w, err.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(), http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> bs.s.</span><span style="color:#79B8FF;">Create</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">&amp;</span><span style="color:#E1E4E8;">book); err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		http.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(w, err.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(), http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> (bs </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">BookStoreServer) </span><span style="color:#B392F0;">getBookHandler</span><span style="color:#E1E4E8;">(w http.ResponseWriter, req </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">http.Request) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	id, ok </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> mux.</span><span style="color:#79B8FF;">Vars</span><span style="color:#E1E4E8;">(req)[</span><span style="color:#9ECBFF;">&quot;id&quot;</span><span style="color:#E1E4E8;">]</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">ok {</span></span>
<span class="line"><span style="color:#E1E4E8;">		http.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(w, </span><span style="color:#9ECBFF;">&quot;no id found in request&quot;</span><span style="color:#E1E4E8;">, http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	book, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> bs.s.</span><span style="color:#79B8FF;">Get</span><span style="color:#E1E4E8;">(id)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		http.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(w, err.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(), http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#79B8FF;">response</span><span style="color:#E1E4E8;">(w, book)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">response</span><span style="color:#E1E4E8;">(w http.ResponseWriter, v </span><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;">{}) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	data, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> json.</span><span style="color:#79B8FF;">Marshal</span><span style="color:#E1E4E8;">(v)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		http.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(w, err.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(), http.StatusInternalServerError)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	w.</span><span style="color:#79B8FF;">Header</span><span style="color:#E1E4E8;">().</span><span style="color:#79B8FF;">Set</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Content-Type&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;application/json&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	w.</span><span style="color:#79B8FF;">Write</span><span style="color:#E1E4E8;">(data)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// server/server.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> (bs </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">BookStoreServer) </span><span style="color:#6F42C1;">createBookHandler</span><span style="color:#24292E;">(w http.ResponseWriter, req </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">http.Request) {</span></span>
<span class="line"><span style="color:#24292E;">	dec </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> json.</span><span style="color:#005CC5;">NewDecoder</span><span style="color:#24292E;">(req.Body)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">var</span><span style="color:#24292E;"> book store.Book</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> dec.</span><span style="color:#005CC5;">Decode</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">book); err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		http.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(w, err.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(), http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> bs.s.</span><span style="color:#005CC5;">Create</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">&amp;</span><span style="color:#24292E;">book); err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		http.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(w, err.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(), http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> (bs </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">BookStoreServer) </span><span style="color:#6F42C1;">getBookHandler</span><span style="color:#24292E;">(w http.ResponseWriter, req </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">http.Request) {</span></span>
<span class="line"><span style="color:#24292E;">	id, ok </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> mux.</span><span style="color:#005CC5;">Vars</span><span style="color:#24292E;">(req)[</span><span style="color:#032F62;">&quot;id&quot;</span><span style="color:#24292E;">]</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">!</span><span style="color:#24292E;">ok {</span></span>
<span class="line"><span style="color:#24292E;">		http.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(w, </span><span style="color:#032F62;">&quot;no id found in request&quot;</span><span style="color:#24292E;">, http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	book, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> bs.s.</span><span style="color:#005CC5;">Get</span><span style="color:#24292E;">(id)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		http.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(w, err.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(), http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#005CC5;">response</span><span style="color:#24292E;">(w, book)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">response</span><span style="color:#24292E;">(w http.ResponseWriter, v </span><span style="color:#D73A49;">interface</span><span style="color:#24292E;">{}) {</span></span>
<span class="line"><span style="color:#24292E;">	data, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> json.</span><span style="color:#005CC5;">Marshal</span><span style="color:#24292E;">(v)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		http.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(w, err.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(), http.StatusInternalServerError)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	w.</span><span style="color:#005CC5;">Header</span><span style="color:#24292E;">().</span><span style="color:#005CC5;">Set</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Content-Type&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;application/json&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	w.</span><span style="color:#005CC5;">Write</span><span style="color:#24292E;">(data)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这些处理函数的实现都大同小异，首先获取 http 请求包体数据，然后通过标准库 json 包将这些数据，解码（decode）为我们需要的 store.Book 结构体实例，再通过 Store 接口对图书数据进行存储操作。如果我们是获取图书数据的请求，那么处理函数可以通过 response 函数，将取出的图书数据编码到 http 响应包中，并返回给客户端。</p><p>在 NewBookStoreServer 函数实现的尾部，我门还可以看到这样一段代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">srv.srv.Handler </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> middleware.</span><span style="color:#79B8FF;">Logging</span><span style="color:#E1E4E8;">(middleware.</span><span style="color:#79B8FF;">Validating</span><span style="color:#E1E4E8;">(router))</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">srv.srv.Handler </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> middleware.</span><span style="color:#005CC5;">Logging</span><span style="color:#24292E;">(middleware.</span><span style="color:#005CC5;">Validating</span><span style="color:#24292E;">(router))</span></span></code></pre></div><p>我们在 router 的外围包裹了 middleware，即中间件函数。下面我们再来看下这两个 middleware，即 Logging 与 Validating。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// server/middleware/middleware.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Logging</span><span style="color:#E1E4E8;">(next http.Handler) http.Handler {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> http.</span><span style="color:#79B8FF;">HandlerFunc</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">func</span><span style="color:#E1E4E8;">(w http.ResponseWriter, req </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">http.Request) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		log.</span><span style="color:#79B8FF;">Printf</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;recv a </span><span style="color:#79B8FF;">%s</span><span style="color:#9ECBFF;"> request from </span><span style="color:#79B8FF;">%s</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#E1E4E8;">, req.Method, req.RemoteAddr)</span></span>
<span class="line"><span style="color:#E1E4E8;">		next.</span><span style="color:#79B8FF;">ServeHTTP</span><span style="color:#E1E4E8;">(w, req)</span></span>
<span class="line"><span style="color:#E1E4E8;">	})</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Validating</span><span style="color:#E1E4E8;">(next http.Handler) http.Handler {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> http.</span><span style="color:#79B8FF;">HandlerFunc</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">func</span><span style="color:#E1E4E8;">(w http.ResponseWriter, req </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">http.Request) {</span></span>
<span class="line"><span style="color:#E1E4E8;">		contentType </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> req.Header.</span><span style="color:#79B8FF;">Get</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;Content-Type&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">		mediatype, _, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> mime.</span><span style="color:#79B8FF;">ParseMediaType</span><span style="color:#E1E4E8;">(contentType)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">			http.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(w, err.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(), http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> mediatype </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;application/json&quot;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">			http.</span><span style="color:#79B8FF;">Error</span><span style="color:#E1E4E8;">(w, </span><span style="color:#9ECBFF;">&quot;invalid Content-Type&quot;</span><span style="color:#E1E4E8;">, http.StatusUnsupportedMediaType)</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">		next.</span><span style="color:#79B8FF;">ServeHTTP</span><span style="color:#E1E4E8;">(w, req)</span></span>
<span class="line"><span style="color:#E1E4E8;">	})</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// server/middleware/middleware.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Logging</span><span style="color:#24292E;">(next http.Handler) http.Handler {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> http.</span><span style="color:#005CC5;">HandlerFunc</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">func</span><span style="color:#24292E;">(w http.ResponseWriter, req </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">http.Request) {</span></span>
<span class="line"><span style="color:#24292E;">		log.</span><span style="color:#005CC5;">Printf</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;recv a </span><span style="color:#005CC5;">%s</span><span style="color:#032F62;"> request from </span><span style="color:#005CC5;">%s</span><span style="color:#032F62;">&quot;</span><span style="color:#24292E;">, req.Method, req.RemoteAddr)</span></span>
<span class="line"><span style="color:#24292E;">		next.</span><span style="color:#005CC5;">ServeHTTP</span><span style="color:#24292E;">(w, req)</span></span>
<span class="line"><span style="color:#24292E;">	})</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Validating</span><span style="color:#24292E;">(next http.Handler) http.Handler {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> http.</span><span style="color:#005CC5;">HandlerFunc</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">func</span><span style="color:#24292E;">(w http.ResponseWriter, req </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">http.Request) {</span></span>
<span class="line"><span style="color:#24292E;">		contentType </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> req.Header.</span><span style="color:#005CC5;">Get</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;Content-Type&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">		mediatype, _, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> mime.</span><span style="color:#005CC5;">ParseMediaType</span><span style="color:#24292E;">(contentType)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">			http.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(w, err.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(), http.StatusBadRequest)</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> mediatype </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;application/json&quot;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">			http.</span><span style="color:#005CC5;">Error</span><span style="color:#24292E;">(w, </span><span style="color:#032F62;">&quot;invalid Content-Type&quot;</span><span style="color:#24292E;">, http.StatusUnsupportedMediaType)</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">		next.</span><span style="color:#005CC5;">ServeHTTP</span><span style="color:#24292E;">(w, req)</span></span>
<span class="line"><span style="color:#24292E;">	})</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们可以看到，Loading 函数主要用来输出每个到达的 HTTP 请求的概要信息，Validating 则会对每个 http 请求头部进行检查，检查 Content-Type 头字段所表示的媒体类型是否为 application/json。</p><p>创建完 BookStoreServer 实例后，我们就可以调用其 ListenAndServe 方法运行这个服务了。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// server/server.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> (bs </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">BookStoreServer) </span><span style="color:#B392F0;">ListenAndServe</span><span style="color:#E1E4E8;">() (</span><span style="color:#F97583;">&lt;-chan</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">error</span></span>
<span class="line"><span style="color:#E1E4E8;">	errChan </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">make</span><span style="color:#E1E4E8;">(</span><span style="color:#F97583;">chan</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">go</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">func</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">		err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> bs.srv.</span><span style="color:#79B8FF;">ListenAndServe</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">		errChan </span><span style="color:#F97583;">&lt;-</span><span style="color:#E1E4E8;"> err</span></span>
<span class="line"><span style="color:#E1E4E8;">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">select</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;-</span><span style="color:#E1E4E8;">errChan:</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;">, err</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">&lt;-</span><span style="color:#E1E4E8;">time.</span><span style="color:#79B8FF;">After</span><span style="color:#E1E4E8;">(time.Second):</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> errChan, </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// server/server.go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> (bs </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">BookStoreServer) </span><span style="color:#6F42C1;">ListenAndServe</span><span style="color:#24292E;">() (</span><span style="color:#D73A49;">&lt;-chan</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">var</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">error</span></span>
<span class="line"><span style="color:#24292E;">	errChan </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">make</span><span style="color:#24292E;">(</span><span style="color:#D73A49;">chan</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">go</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">func</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">		err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> bs.srv.</span><span style="color:#005CC5;">ListenAndServe</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">		errChan </span><span style="color:#D73A49;">&lt;-</span><span style="color:#24292E;"> err</span></span>
<span class="line"><span style="color:#24292E;">	}()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">select</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;-</span><span style="color:#24292E;">errChan:</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;">, err</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">&lt;-</span><span style="color:#24292E;">time.</span><span style="color:#005CC5;">After</span><span style="color:#24292E;">(time.Second):</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> errChan, </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们可以看到，这个函数将 BookStore 内部的 http.Serve 放置到一个单独的轻量级线程 Goroutine 中运行。这是因为，httpServer.ListenAndServe 会阻塞代码继续执行，如果不把它放到单独的 Goroutine 中，后面的代码将无法运行。</p><p>为了可以检测到 http.Serve.ListenAndServe 的运行状态，我们再通过一个 channel，在新创建的 Goroutine 与主 Goroutine 之间建立起通信渠道。通过这个渠道，我们就可以及时得到 http server 的运行状态。</p><h4 id="编译、运行" tabindex="-1">编译、运行 <a class="header-anchor" href="#编译、运行" aria-label="Permalink to &quot;编译、运行&quot;">​</a></h4><p>首先执行下面这个命令，让 Go 命令自动分析依赖项和版本，并更新 go.mod。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">go</span><span style="color:#E1E4E8;"> mod tidy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">go</span><span style="color:#E1E4E8;">: finding module </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">github</span><span style="color:#E1E4E8;">.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">gorilla</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mux</span></span>
<span class="line"><span style="color:#F97583;">go</span><span style="color:#E1E4E8;">: downloading github.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">gorilla</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mux v1.</span><span style="color:#79B8FF;">8.0</span></span>
<span class="line"><span style="color:#F97583;">go</span><span style="color:#E1E4E8;">: found github.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">gorilla</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mux in github.com</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">gorilla</span><span style="color:#F97583;">/</span><span style="color:#E1E4E8;">mux v1.</span><span style="color:#79B8FF;">8.0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">go</span><span style="color:#24292E;"> mod tidy</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">go</span><span style="color:#24292E;">: finding module </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">github</span><span style="color:#24292E;">.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">gorilla</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mux</span></span>
<span class="line"><span style="color:#D73A49;">go</span><span style="color:#24292E;">: downloading github.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">gorilla</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mux v1.</span><span style="color:#005CC5;">8.0</span></span>
<span class="line"><span style="color:#D73A49;">go</span><span style="color:#24292E;">: found github.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">gorilla</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mux in github.com</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">gorilla</span><span style="color:#D73A49;">/</span><span style="color:#24292E;">mux v1.</span><span style="color:#005CC5;">8.0</span></span></code></pre></div><p>完成后，我们就可以按照下面的步骤构建并执行 bookstore。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">go build bookstore/cmd/bookstore</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">go build bookstore/cmd/bookstore</span></span></code></pre></div><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">heora@yueluodeMBP bookstore % ./bookstore  </span></span>
<span class="line"><span style="color:#e1e4e8;">2023/01/15 20:51:33 web server start ok</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">heora@yueluodeMBP bookstore % ./bookstore  </span></span>
<span class="line"><span style="color:#24292e;">2023/01/15 20:51:33 web server start ok</span></span></code></pre></div><p>如果你也可以看到上面这个输出日志，说明我们的程序已经启动成功。</p><p>现在我们就可以使用 curl 命令行工具，模拟客户端向 bookstore 服务发送请求。</p><p>创建新书条目</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curl -X POST -H &quot;Content-Type:application/json&quot; -d &#39;{&quot;id&quot;: &quot;978-7-111-55842-2&quot;, &quot;name&quot;: &quot;The Go Programming Language&quot;, &quot;authors&quot;:[&quot;Alan A.A.Donovan&quot;, &quot;Brian W. Kergnighan&quot;],&quot;press&quot;: &quot;Pearson Education&quot;}&#39; localhost:8080/book</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curl -X POST -H &quot;Content-Type:application/json&quot; -d &#39;{&quot;id&quot;: &quot;978-7-111-55842-2&quot;, &quot;name&quot;: &quot;The Go Programming Language&quot;, &quot;authors&quot;:[&quot;Alan A.A.Donovan&quot;, &quot;Brian W. Kergnighan&quot;],&quot;press&quot;: &quot;Pearson Education&quot;}&#39; localhost:8080/book</span></span></code></pre></div><p>此时服务端会输出以下日志，表明我们的 bookstore 服务收到了客户端请求。</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">2023/01/15 20:53:26 recv a POST request from 127.0.0.1:49367</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">2023/01/15 20:53:26 recv a POST request from 127.0.0.1:49367</span></span></code></pre></div><p>接下来，我们再来获取一下这本书的信息：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">curl -X GET -H &quot;Content-Type:application/json&quot; localhost:8080/book/978-7-111-55842-2</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">{&quot;id&quot;:&quot;978-7-111-55842-2&quot;,&quot;name&quot;:&quot;The Go Programming Language&quot;,&quot;authors&quot;:[&quot;Alan A.A.Donovan&quot;,&quot;Brian W. Kergnighan&quot;],&quot;press&quot;:&quot;Pearson Education&quot;}%</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">curl -X GET -H &quot;Content-Type:application/json&quot; localhost:8080/book/978-7-111-55842-2</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">{&quot;id&quot;:&quot;978-7-111-55842-2&quot;,&quot;name&quot;:&quot;The Go Programming Language&quot;,&quot;authors&quot;:[&quot;Alan A.A.Donovan&quot;,&quot;Brian W. Kergnighan&quot;],&quot;press&quot;:&quot;Pearson Education&quot;}%</span></span></code></pre></div><p>可以看到 curl 得到的响应与我们的预期是一致的。</p><p><a href="https://github.com/yzqzy/notes/tree/master/go/base/bookstore" target="_blank" rel="noreferrer">源码地址</a></p><h2 id="_10-变量声明" tabindex="-1">10. 变量声明 <a class="header-anchor" href="#_10-变量声明" aria-label="Permalink to &quot;10. 变量声明&quot;">​</a></h2><p>在编程语言中，为了方便操作内存特定位置的数据，我们使用一个特定的名称与特定位置的内存块绑定在一起，这个名字被称为变量。但这并不代表我们可以通过变量随意引用或修改内存，变量所绑定的内存区域需要有一个明确的边界。</p><p>也就是说，通过这样一个变量，我们究竟可以操作 4 个字节内存还是 8 个字节内存，又或是 256 个字节内存，编程语言的编译器或解释器都需要明确知道。</p><p>那么，编程语言的编译器或解释器时如何知道一个变量所能引用的内存区域边界呢？</p><p>对于这个问题，动态语言和静态语言有不同的处理方式。动态语言（例如 Python、Ruby 等）的解释器可以在运行时通过对变量赋值的分析，自动确定变量的边界。并且在动态语言中，一个变量可以在运行时被赋予大小不同的边界。</p><p>而静态编程语言编译器必须明确知道一个变量的边界才允许使用这个变量，但静态语言编译器自身也没办法提供这个信息，这个边界信息必须由这门语言的使用者提供，于是就又有了 ”变量声明“。通过变量声明，语言使用者可以显式告知编译器一个变量的边界信息。</p><p>作为身处静态编程语言阵营的 Go 语言，它沿袭了静态语言的这一要求：使用变量之前需要先进行变量声明。</p><h3 id="变量声明方法" tabindex="-1">变量声明方法 <a class="header-anchor" href="#变量声明方法" aria-label="Permalink to &quot;变量声明方法&quot;">​</a></h3><p>Go 是静态语言，所有变量在使用前必须先进行声明。声明的意义在于告诉编译器该变量可以操作的内存边界信息，而这种边界通常又是由变量的类型信息提供的。</p><h4 id="通用变量声明" tabindex="-1">通用变量声明 <a class="header-anchor" href="#通用变量声明" aria-label="Permalink to &quot;通用变量声明&quot;">​</a></h4><p>在 Go 语言中，有一个通用的变量声明方法：</p><img src="/notes/assets/declare.9fdeb50e.png"><p>这个变量声明分为四个部分：</p><ul><li>var 是修饰变量声明的关键字；</li><li>a 为变量名；</li><li>int 为该变量的类型；</li><li>10 是变量的初始值。</li></ul><p>Go 语言的变量声明形式与其他主流静态语言有一个显著差异，就是它将变量名放在了类型前面。如果你没有显式为变量赋值，Go 编译器就会为变量赋予这个类型的零值。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// a 的初值为 int 类型的零值：0</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// a 的初值为 int 类型的零值：0</span></span></code></pre></div><p>Go 语言的每种原生类型都有它的默认值，这个默认值就是这个类型的零值。下面是 Go 规范定义的内置原生类型的默认值。</p><table><thead><tr><th>内置原生类型</th><th>默认值</th></tr></thead><tbody><tr><td>所有整型类型</td><td>0</td></tr><tr><td>浮点类型</td><td>0.0</td></tr><tr><td>布尔类型</td><td>false</td></tr><tr><td>字符串类型</td><td>“”</td></tr><tr><td>指针、接口、切片、channel、map 和函数类型</td><td>nil</td></tr></tbody></table><p>另外，像数组、结构体这样的复合类型变量的零值就是它们组成元素都为零值时的结果。</p><p>除了单独声明每个变量外，Go 语言还提供了变量声明块（block）的语法形式，可以用一个 var 关键字将多个变量声明放在一起：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">	a </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">128</span></span>
<span class="line"><span style="color:#E1E4E8;">  b init8 </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">6</span></span>
<span class="line"><span style="color:#E1E4E8;">  s </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;hello&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">  c </span><span style="color:#F97583;">rune</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">A</span><span style="color:#9ECBFF;">&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  t </span><span style="color:#F97583;">bool</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">true</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">	a </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">128</span></span>
<span class="line"><span style="color:#24292E;">  b init8 </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">6</span></span>
<span class="line"><span style="color:#24292E;">  s </span><span style="color:#D73A49;">string</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;hello&quot;</span></span>
<span class="line"><span style="color:#24292E;">  c </span><span style="color:#D73A49;">rune</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">A</span><span style="color:#032F62;">&#39;</span></span>
<span class="line"><span style="color:#24292E;">  t </span><span style="color:#D73A49;">bool</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre></div><p>在这个变量块中，我们通过一个 var 关键字声明了 5 个不同类型的变量。而且，Go 语言支持在一行变量声明中同时声明多个变量：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a, b, c </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">7</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a, b, c </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">7</span></span></code></pre></div><p>这样的多变量声明同样也可以用在变量声明块中，像下面这样：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  a, b, c </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">7</span></span>
<span class="line"><span style="color:#E1E4E8;">  c, d, e </span><span style="color:#F97583;">rune</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">C</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">D</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">E</span><span style="color:#9ECBFF;">&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  a, b, c </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">6</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">7</span></span>
<span class="line"><span style="color:#24292E;">  c, d, e </span><span style="color:#D73A49;">rune</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">C</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">D</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">E</span><span style="color:#032F62;">&#39;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre></div><p>我们上面写的多变量声明都是在声明同一类型的变量，这种方式也适用于不同类型的变量。</p><p>除了上面这种通常的变量声明形式，Go 语言还提供了两种变量声明的 “语法糖”。</p><h4 id="省略类型信息声明" tabindex="-1">省略类型信息声明 <a class="header-anchor" href="#省略类型信息声明" aria-label="Permalink to &quot;省略类型信息声明&quot;">​</a></h4><p>在通用的变量声明的基础上，Go 编译器允许我们省略变量声明中的类型信息，它的标准范式是 “var varName = initExpression”。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">13</span></span></code></pre></div><p>这种写法其实有点类似于动态语言的声明方式，例如 JavaScript。那么 Go 编译器在遇到这样的变量声明后是如何确定变量的类型信息的？</p><p>其实也很简单，Go 编译器会根据右侧变量初值自动推导出变量类型，并给这个变量赋予初值所对应的默认类型。比如，整型值的默认类型 int，浮点值的默认类型为 float64，复数值的默认值为 complex128，布尔值的默认类型为 bool，字符值默认类型为 rune，字符串值的默认类型为 string 等。</p><p>如果我们不接受默认类型，需要显式地为变量指定类型，除了通用的声明形式，我们还可以通过显式类型转型达到我们的目录：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int32</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int32</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">13</span><span style="color:#24292E;">)</span></span></code></pre></div><p>上面这种省略类型信息声明的 “语法糖” 仅适用于变量声明的同时赋予变量初值的情况，如果没有初值的声明形式是不被允许的：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> b</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> b</span></span></code></pre></div><p>结合多变量声明，我们还可以使用这种变量声明 “语法糖” 声明多个不同类型的变量：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a, b, c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">A</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#FDAEB7;font-style:italic;">Hello</span><span style="color:#9ECBFF;">&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a, b, c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">A</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;</span><span style="color:#B31D28;font-style:italic;">Hello</span><span style="color:#032F62;">&#39;</span></span></code></pre></div><p>在这个变量中，我们声明三个变量 a、b、c，但它们分别具有不同的类型，分别为 int、rune 和 string。</p><p>在这种变量声明语法糖中，我们省去变量类型信息，Go 编译器会为我们自动推导出类型信息。除了这种方式，其实还有一种更简化的变量声明方式。</p><h4 id="短变量声明" tabindex="-1">短变量声明 <a class="header-anchor" href="#短变量声明" aria-label="Permalink to &quot;短变量声明&quot;">​</a></h4><p>Go 语言还为我们提供了最简化的变量声明形式：短变量声明。使用短变量声明时，我们还可以省去 var 关键字以及类型信息，它的标准方式是 “varName:=initExpression”。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">a </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">12</span></span>
<span class="line"><span style="color:#E1E4E8;">b </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">A</span><span style="color:#9ECBFF;">&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">c </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;hello&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">a </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">12</span></span>
<span class="line"><span style="color:#24292E;">b </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">A</span><span style="color:#032F62;">&#39;</span></span>
<span class="line"><span style="color:#24292E;">c </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;hello&quot;</span></span></code></pre></div><p>我们可以看到，短变量声明没有使用赋值操作符 “=”，而是使用短变量声明专用的 “:=”。原理和上面的省略类型信息的声明语法糖一样，短变量声明中的变量类型也是由 Go 编译器自动推导出来的。</p><p>而且，短变量声明也支持一次声明多个变量，并且形式更加简洁：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">a, b, c </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">12</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#79B8FF;">A</span><span style="color:#9ECBFF;">&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;</span><span style="color:#FDAEB7;font-style:italic;">hello</span><span style="color:#9ECBFF;">&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">a, b, c </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">12</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;</span><span style="color:#005CC5;">A</span><span style="color:#032F62;">&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;</span><span style="color:#B31D28;font-style:italic;">hello</span><span style="color:#032F62;">&#39;</span></span></code></pre></div><p>不过，短变量声明使用也有有约束的，并不是所有变量都可以使用短变量声明的方式来处理，我们会在后面进行讲解。</p><p>到现在，我们已经学习了三种变量声明方式。这些变量声明方式是否适合所有变量？给出最终结果之前，我们先来学习下 Go 语言的两类变量。</p><p>Go 语言的变量可以分为两类：一类称为包级变量（package varible），即包级别可见的变量。如果是导出变量（大写字母开头），那么这个包级变量也可以被视为全局变量。另一类是局部变量（local varible），即 Go 函数或方法体内声明的变量，仅在函数或方法体内可见。</p><p>下面我们就来分别说明一下这两类变量在声明形式选择上的方法，以及一些最佳实践。</p><h3 id="包级变量声明形式" tabindex="-1">包级变量声明形式 <a class="header-anchor" href="#包级变量声明形式" aria-label="Permalink to &quot;包级变量声明形式&quot;">​</a></h3><p>包级变量只能使用带有 var 关键字的变量声明方式，不能使用短变量声明形式，不过在形式细节上可以存在一定灵活度。</p><h4 id="声明并同时显示初始化" tabindex="-1">声明并同时显示初始化 <a class="header-anchor" href="#声明并同时显示初始化" aria-label="Permalink to &quot;声明并同时显示初始化&quot;">​</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> ErrShortWrite </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> errors.</span><span style="color:#79B8FF;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;short write&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> ErrShortBuffer </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> errors.</span><span style="color:#79B8FF;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;short buffer&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> EOF </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> errors.</span><span style="color:#79B8FF;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;EOF&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> ErrShortWrite </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> errors.</span><span style="color:#005CC5;">New</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;short write&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> ErrShortBuffer </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> errors.</span><span style="color:#005CC5;">New</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;short buffer&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> EOF </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> errors.</span><span style="color:#005CC5;">New</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;EOF&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>我们可以看到，这个代码块中声明的变量都是 io 包的包级变量。在 Go 标准库中，对于变量声明的同时进行显示初始化的这类包级变量，可以使用这种省略类型信息的 “语法糖” 格式：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> varName </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> initExpression</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> varName </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> initExpression</span></span></code></pre></div><p>Go 编译器会自动根据等号右侧 InitExpression 结果值的类型，来确定左侧声明的变量类型，这个类型会是结果值对应类型的默认值。</p><p>当然，如果我们不接受默认类型，而是显式地为包级变量指定类型，下面给出两种包级变量的声明形式对比示例：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// 第一种</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 使用默认类型</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">int32</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 显式指定类型</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> f </span><span style="color:#F97583;">float32</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.14</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 显式指定类型</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 第二种</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 使用默认类型</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int32</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 显示指定类型</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">float32</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3.14</span><span style="color:#E1E4E8;">) </span><span style="color:#6A737D;">// 显示指定类型</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// 第一种</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 使用默认类型</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">int32</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">17</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 显式指定类型</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> f </span><span style="color:#D73A49;">float32</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.14</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 显式指定类型</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// 第二种</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">13</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 使用默认类型</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int32</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">17</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 显示指定类型</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">float32</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">3.14</span><span style="color:#24292E;">) </span><span style="color:#6A737D;">// 显示指定类型</span></span></code></pre></div><p>虽然这两种方式都是可以使用的，但从声明一致性的角度出发，Go 更推荐我们使用后者，这样可以统一接受默认类型和显示指定类型。尤其将这些变量放在一个 var 块中声明时，可以更明显地看到这一点。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">	a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13</span></span>
<span class="line"><span style="color:#E1E4E8;">  b </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int32</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  c </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">float32</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3.14</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">	a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">13</span></span>
<span class="line"><span style="color:#24292E;">  b </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int32</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">17</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  c </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">float32</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">3.14</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre></div><h4 id="声明但延迟初始化" tabindex="-1">声明但延迟初始化 <a class="header-anchor" href="#声明但延迟初始化" aria-label="Permalink to &quot;声明但延迟初始化&quot;">​</a></h4><p>对于声明时并不显示初始化的包级变量，我们可以使用下面这种通用变量声明形式：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">int32</span></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> f </span><span style="color:#F97583;">float64</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">int32</span></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> f </span><span style="color:#D73A49;">float64</span></span></code></pre></div><p>虽然变量没有初始化，但是 Go 也会让这些变量拥有初始 “零值”。如果是自定义类型，建议尽量保证它的零值是可用的。</p><p>还有一个注意事项，就是声明聚类与就近原则。</p><p>Go 语言提供了变量生命块用来把多个变量声明放在一起，并且在语法上也不会限制放置在 var 块中的声明类型，我们可以充分利用 var 变量生命块，让我们的变量声明更规整，更具可读性。</p><p>通常，我们会将用一类的变量声明放在一个 var 变量声明块中，不同类的声明放在不同的 var 声明块中。下面是标准库 net 包中摘取的两段变量声明代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  netGo  </span><span style="color:#F97583;">bool</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">  netCgo </span><span style="color:#F97583;">bool</span><span style="color:#E1E4E8;"> </span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">  aLongTimeAgo </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time.</span><span style="color:#79B8FF;">Unix</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  noDeadline </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> time.Time{}</span></span>
<span class="line"><span style="color:#E1E4E8;">  noCancel   </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">chan</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;">{})(</span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  netGo  </span><span style="color:#D73A49;">bool</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">  netCgo </span><span style="color:#D73A49;">bool</span><span style="color:#24292E;"> </span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">  aLongTimeAgo </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time.</span><span style="color:#005CC5;">Unix</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  noDeadline </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> time.Time{}</span></span>
<span class="line"><span style="color:#24292E;">  noCancel   </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">chan</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;">{})(</span><span style="color:#005CC5;">nil</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">)</span></span></code></pre></div><p>我们可以看到，上面这两个 var 声明块各自声明了一类特定用途的包级变量。</p><p>我们将延迟初始化的变量声明放在一个 var 声明块，然后将声明且显式初始化的变量放在另一个 var 块中，这里可以称之为 “声明聚类”，声明聚类可以提升代码可读性。</p><p>那么我们是否应该将包级变量的声明全部集中放在源文件头部呢？答案其实并不唯一。</p><p>使用过静态语言编程的开发人员都知道，变量声明最佳实践中有一条准则：就近原则。也就是说我们尽可能在靠近第一次使用变量的位置声明这个变量。就近原则实际上也是对变量的作用域最小化的一种实现手段。在 Go 标准库中我们也很容易找到符合就近原则变量声明的例子，例如下面这段标准库 http 包中的代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> ErrNoCookie </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> errors.</span><span style="color:#79B8FF;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;http: named cookie not present&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> (r </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">Request) </span><span style="color:#B392F0;">Cookie</span><span style="color:#E1E4E8;">(name </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">) (</span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">Cookie, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, c </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">range</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">readCookies</span><span style="color:#E1E4E8;">(r.Header, name) {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> c, </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;">, ErrNoCookie</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> ErrNoCookie </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> errors.</span><span style="color:#005CC5;">New</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;http: named cookie not present&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> (r </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">Request) </span><span style="color:#6F42C1;">Cookie</span><span style="color:#24292E;">(name </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">) (</span><span style="color:#D73A49;">*</span><span style="color:#24292E;">Cookie, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, c </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">range</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">readCookies</span><span style="color:#24292E;">(r.Header, name) {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> c, </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;">, ErrNoCookie</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>在这个代码块里，ErrNoCookie 这个变量仅在 Cookie 方法中使用过一次，因此它被声明在紧邻 Cookie 方法定义的地方。当然，如果一个包级变量在包内部被多次使用，那么这个变量还是放在源文件头部比较合适。</p><h3 id="局部变量声明形式" tabindex="-1">局部变量声明形式 <a class="header-anchor" href="#局部变量声明形式" aria-label="Permalink to &quot;局部变量声明形式&quot;">​</a></h3><p>和包级变量相比，局部变量多了一种短变量声明形式，这是局部变量特有的一种变量声明形式，也是局部变量采用最多的一种声明形式。</p><h4 id="延迟初始化变量声明" tabindex="-1">延迟初始化变量声明 <a class="header-anchor" href="#延迟初始化变量声明" aria-label="Permalink to &quot;延迟初始化变量声明&quot;">​</a></h4><p>对于延迟初始化的局部变量声明，我们采用通用的变量声明形式。</p><p>我们之前说过的省略类型信息的声明和短变量声明这两种 “语法糖” 变量声明形式都不支持变量延迟初始化，因此对于这类局部变量，和包级变量一样，我们只能采用通用的变量声明形式：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">error</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">error</span></span></code></pre></div><h4 id="显式初始化变量声明" tabindex="-1">显式初始化变量声明 <a class="header-anchor" href="#显式初始化变量声明" aria-label="Permalink to &quot;显式初始化变量声明&quot;">​</a></h4><p>对于声明且显式初始化的局部变量，建议使用短变量声明形式。</p><p>短变量声明形式是局部变量最常用的声明形式。对于接受默认参数类型的变量，我们使用下面这种形式：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">a </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">17</span></span>
<span class="line"><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3.14</span></span>
<span class="line"><span style="color:#E1E4E8;">s </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;hello, gopher!&quot;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">a </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">17</span></span>
<span class="line"><span style="color:#24292E;">f </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3.14</span></span>
<span class="line"><span style="color:#24292E;">s </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;hello, gopher!&quot;</span></span></code></pre></div><p>对于不接受默认类型的变量，我们依然可以采用短变量声明形式，不过我们需要在 “:=” 右侧进行显式转型，保持声明一致性。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">a </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">int32</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">17</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">f </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">float32</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">3.14</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">s </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> []</span><span style="color:#79B8FF;">byte</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;hello, gopher!&quot;</span><span style="color:#E1E4E8;">)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">a </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">int32</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">17</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">f </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">float32</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">3.14</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">s </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> []</span><span style="color:#005CC5;">byte</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;hello, gopher!&quot;</span><span style="color:#24292E;">)</span></span></code></pre></div><p>除此之外，我们需要注意，尽量在分支控制时使用短变量声明形式。</p><p>分支控制应该是 Go 中短变量声明形式应用最广泛的场景。在编写 Go 代码时，我们很少单独声明用于分支控制语句中的变量，而是将它与 if、for 等控制语句通过短变量声明形式融合在一起，即在控制语句中直接声明用于控制语句代码块中的变量。</p><p>下面是摘自 Go 标准库中的代码，strings 包的 LastIndexAny 方法为我们很好地诠释了如何将短变量声明形式与分支控制语句融合在一起使用：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">LastIndexAny</span><span style="color:#E1E4E8;">(s, chars </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> chars </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;&quot;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// Avoid scanning all of s.</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(s) </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 在if条件控制语句中使用短变量声明形式声明了if代码块中要使用的变量as和isASCII</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> as, isASCII </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">makeASCIISet</span><span style="color:#E1E4E8;">(chars); isASCII {</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(s) </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; i </span><span style="color:#F97583;">&gt;=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; i</span><span style="color:#F97583;">--</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> as.</span><span style="color:#79B8FF;">contains</span><span style="color:#E1E4E8;">(s[i]) {</span></span>
<span class="line"><span style="color:#E1E4E8;">					</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> i</span></span>
<span class="line"><span style="color:#E1E4E8;">				}</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> i </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">len</span><span style="color:#E1E4E8;">(s); i </span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">; {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 在for循环控制语句中使用短变量声明形式声明了for代码块中要使用的变量c</span></span>
<span class="line"><span style="color:#E1E4E8;">		r, size </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> utf8.</span><span style="color:#79B8FF;">DecodeLastRuneInString</span><span style="color:#E1E4E8;">(s[:i])</span></span>
<span class="line"><span style="color:#E1E4E8;">		i </span><span style="color:#F97583;">-=</span><span style="color:#E1E4E8;"> size</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">for</span><span style="color:#E1E4E8;"> _, c </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">range</span><span style="color:#E1E4E8;"> chars {</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> r </span><span style="color:#F97583;">==</span><span style="color:#E1E4E8;"> c {</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> i</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">LastIndexAny</span><span style="color:#24292E;">(s, chars </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> chars </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;&quot;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// Avoid scanning all of s.</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(s) </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 在if条件控制语句中使用短变量声明形式声明了if代码块中要使用的变量as和isASCII</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> as, isASCII </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">makeASCIISet</span><span style="color:#24292E;">(chars); isASCII {</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(s) </span><span style="color:#D73A49;">-</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; i </span><span style="color:#D73A49;">&gt;=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; i</span><span style="color:#D73A49;">--</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> as.</span><span style="color:#005CC5;">contains</span><span style="color:#24292E;">(s[i]) {</span></span>
<span class="line"><span style="color:#24292E;">					</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> i</span></span>
<span class="line"><span style="color:#24292E;">				}</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> i </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">len</span><span style="color:#24292E;">(s); i </span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">; {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 在for循环控制语句中使用短变量声明形式声明了for代码块中要使用的变量c</span></span>
<span class="line"><span style="color:#24292E;">		r, size </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> utf8.</span><span style="color:#005CC5;">DecodeLastRuneInString</span><span style="color:#24292E;">(s[:i])</span></span>
<span class="line"><span style="color:#24292E;">		i </span><span style="color:#D73A49;">-=</span><span style="color:#24292E;"> size</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">for</span><span style="color:#24292E;"> _, c </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">range</span><span style="color:#24292E;"> chars {</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> r </span><span style="color:#D73A49;">==</span><span style="color:#24292E;"> c {</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> i</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这种短变量声明融合的使用方式也体现出 “就近原则”，让变量的作用域最小化。</p><p>另外，虽然理论上良好的函数/方法设计需要考虑 “单一职责”，每个函数/方法规模都不大，很少需要应用 var 块来聚类声明局部变量。但是如果你在声明局部变量时遇到适合聚类的应用场景，我们也可以考虑使用 var 声明块来声明多个局部变量。我们可以参考 Go 标准库 net 包中的 resolveAddrList 方法：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> (r </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">Resolver) </span><span style="color:#B392F0;">resolveAddrList</span><span style="color:#E1E4E8;">(ctx context.Context, op, network, </span></span>
<span class="line"><span style="color:#E1E4E8;">                          addr </span><span style="color:#F97583;">string</span><span style="color:#E1E4E8;">, hint Addr) (addrList, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">      tcp      </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">TCPAddr</span></span>
<span class="line"><span style="color:#E1E4E8;">      udp      </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">UDPAddr</span></span>
<span class="line"><span style="color:#E1E4E8;">      ip       </span><span style="color:#F97583;">*</span><span style="color:#E1E4E8;">IPAddr</span></span>
<span class="line"><span style="color:#E1E4E8;">      wildcard </span><span style="color:#F97583;">bool</span></span>
<span class="line"><span style="color:#E1E4E8;">  )</span></span>
<span class="line"><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">...</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">...</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> (r </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">Resolver) </span><span style="color:#6F42C1;">resolveAddrList</span><span style="color:#24292E;">(ctx context.Context, op, network, </span></span>
<span class="line"><span style="color:#24292E;">                          addr </span><span style="color:#D73A49;">string</span><span style="color:#24292E;">, hint Addr) (addrList, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">...</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">...</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">var</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">      tcp      </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">TCPAddr</span></span>
<span class="line"><span style="color:#24292E;">      udp      </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">UDPAddr</span></span>
<span class="line"><span style="color:#24292E;">      ip       </span><span style="color:#D73A49;">*</span><span style="color:#24292E;">IPAddr</span></span>
<span class="line"><span style="color:#24292E;">      wildcard </span><span style="color:#D73A49;">bool</span></span>
<span class="line"><span style="color:#24292E;">  )</span></span>
<span class="line"><span style="color:#24292E;"> </span><span style="color:#D73A49;">...</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">...</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="总结-8" tabindex="-1">总结 <a class="header-anchor" href="#总结-8" aria-label="Permalink to &quot;总结&quot;">​</a></h3><p>本篇文章中，我们学习了多种 Go 变量声明的方法，还学习了不同类型 Go 变量可以采用的变量声明形式和方法，以及一些变量声明的最佳实践原则。</p><p>具体来说，Go 语言提供了一种通用变量声明形式以及两种变量声明 “语法糖” 形式，我们需要根据具体情况选择不同的变量声明形式。</p><img src="/notes/assets/choose.59242abd.png"><p>良好的变量声明实践需要我们考虑多方面因素，包括明确要声明的变量是包级变量还是局部变量、是否需要延迟初始化、是否接受默认类型、是否是分支控制变量并结合聚类和就近原则等。</p><h3 id="技术拓展-2" tabindex="-1">技术拓展 <a class="header-anchor" href="#技术拓展-2" aria-label="Permalink to &quot;技术拓展&quot;">​</a></h3><p><strong>与主流静态语言不同，在 Go 语言变量声明中，类型是放在变量名后面的，你认为这样有什么好处？</strong></p><p><a href="https://blog.go-zh.org/gos-declaration-syntax" target="_blank" rel="noreferrer">https://blog.go-zh.org/gos-declaration-syntax</a></p><p>其实官方已经给出解释，简单来说就是和 C 相比，在当参数是指针的复杂情况下，这种声明格式会相对好理解一点。</p><h2 id="_11-代码块与作用域" tabindex="-1">11. 代码块与作用域 <a class="header-anchor" href="#_11-代码块与作用域" aria-label="Permalink to &quot;11. 代码块与作用域&quot;">​</a></h2><p>这篇文章中，我们从 Go 变量遮蔽（Variable Shadowing）问题说起。我们先来看下面这段代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">11</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">foo</span><span style="color:#E1E4E8;">(n </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  a </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span></span>
<span class="line"><span style="color:#E1E4E8;">  a </span><span style="color:#F97583;">+=</span><span style="color:#E1E4E8;"> n</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">  fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;a =&quot;</span><span style="color:#E1E4E8;">, a) </span><span style="color:#6A737D;">// 11</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">foo</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;after calling foo, a =&quot;</span><span style="color:#E1E4E8;">, a) </span><span style="color:#6A737D;">// 11</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">11</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">foo</span><span style="color:#24292E;">(n </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  a </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span></span>
<span class="line"><span style="color:#24292E;">  a </span><span style="color:#D73A49;">+=</span><span style="color:#24292E;"> n</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">  fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;a =&quot;</span><span style="color:#24292E;">, a) </span><span style="color:#6A737D;">// 11</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">foo</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">5</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;after calling foo, a =&quot;</span><span style="color:#24292E;">, a) </span><span style="color:#6A737D;">// 11</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>在这段代码中，函数 foo 调用前后，包级变量 a 的值都没有发生变化。这是因为，虽然 foo 函数中也使用到变量 a，但是 foo 函数中的变量 a 遮蔽了外面的包级变量 a，这使得包级变量 a 没有参与到 foo 函数的逻辑中，所以输出结果就不会有变化了。</p><p>变量遮蔽只是一个引子，其实真正想说的是代码块（Block，即词法块）和作用域（Scope）这两个概念，想要彻底保证不出现变量遮蔽问题，我们需要深入了解这两个概念及其背后的规则。</p><h3 id="代码块与作用域" tabindex="-1">代码块与作用域 <a class="header-anchor" href="#代码块与作用域" aria-label="Permalink to &quot;代码块与作用域&quot;">​</a></h3><p>Go 语言中的代码块是包裹在一对大括号内部的声明和语句序列，如果一对大括号内部没有任何声明或其他语句，我们就把它叫做空代码块。Go 代码块支持嵌套，我们可以在一个代码块中嵌入多个层次的代码块。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">foo</span><span style="color:#E1E4E8;">() { </span><span style="color:#6A737D;">//代码块1</span></span>
<span class="line"><span style="color:#E1E4E8;">  { </span><span style="color:#6A737D;">// 代码块2</span></span>
<span class="line"><span style="color:#E1E4E8;">    { </span><span style="color:#6A737D;">// 代码块3</span></span>
<span class="line"><span style="color:#E1E4E8;">       { </span><span style="color:#6A737D;">// 代码块4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">       }</span></span>
<span class="line"><span style="color:#E1E4E8;">    }</span></span>
<span class="line"><span style="color:#E1E4E8;">  }</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">foo</span><span style="color:#24292E;">() { </span><span style="color:#6A737D;">//代码块1</span></span>
<span class="line"><span style="color:#24292E;">  { </span><span style="color:#6A737D;">// 代码块2</span></span>
<span class="line"><span style="color:#24292E;">    { </span><span style="color:#6A737D;">// 代码块3</span></span>
<span class="line"><span style="color:#24292E;">       { </span><span style="color:#6A737D;">// 代码块4</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">       }</span></span>
<span class="line"><span style="color:#24292E;">    }</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>在上面这个示例中，函数 foo 的函数体是最外层的代码块，这里我们将它编号为 “代码块 1”。在它的函数体内部，又嵌套了三层代码块，分别是代码块 2、3 、4。</p><p>像代码块中 1 到 4 这样的代码块，它们都是由两个肉眼可见且配对的大括号包裹起来的，我们称这样的代码块为显式代码块（Explicit Blocks）。既然提到显示代码块，那必然还存在隐式代码块（Implict Block）。顾名思义，隐式代码块没有显式代码块那样的肉眼可见的配对大括号包裹，我们无法通过大括号来识别隐式代码块。</p><p>Go 语言规范对现存的几类隐式代码块做了明确定义，我们先来看下面这张图：</p><img src="/notes/assets/layer.5f0cc5f9.png"><p>首先是位于最外层的宇宙代码块（Universe Block），它的范围最大，所有 Go 源码都在这个隐式代码块中。</p><p>在宇宙代码块内部嵌套了包代码块（Package Block），每个 Go 包都对应一个隐式代码块，每个包代码块包含了该包中的所有 Go 源码，不管这些代码分布在这个包里多少个源文件中。</p><p>在包代码块中内部嵌套若干文件代码块（File Block），每个 Go 源文件都对应一个文件代码块，即一个 Go 包如果有多个源文件，那么就会有多个对应的文件代码块。</p><p>然后就是控制语句中的隐式代码块，包括 if、for 和 switch。我们可以把每个控制语句都视为它在自己的隐式代码块中。需要注意的是，这里的控制语句隐式代码块与控制语句使用大括号包裹的显式代码块并不是一个代码块。switch 控制语句的隐式代码块的位置是在它显示代码外面的。</p><p>最后，位于最内层的隐式代码块位于 switch 或 select 语句的每个 case/default 子句中，虽然没有大括号包裹，但实际上，每个子句都可以视作一个代码块。</p><p>有了代码块的概念后，我们就可以更好的理解作用域的概念。作用域的概念是针对标识符的，不局限于变量。每个标识符都有自己的作用域，一个标识符的作用域就是指这个标识符在被声明后可以被有效使用的源码区域。</p><p>作用域是一个编译器的概念，编译器在编译过程中会对每个标识符的作用域进行检查，对于在标识符作用域外使用该标识符的行为会给出编译错误。</p><p>不过，我们也可以使用代码块的概念来划定每个标识符的作用域。</p><p>声明于外层代码块中的标识符，其作用域包括所有内层代码块，这一原则同样适用于显式代码块和隐式代码块。</p><p>下面，我们对照上面的示意图，再举一些例子，对作用域进一步的理解。</p><p>首先，我们来看看位于最外层的宇宙隐式代码块的标识符。我们先来看第一个问题，如何声明这一区域的标识符。</p><p>其实我们并不能声明这一块的标识符，这一区域是 Go 语言预定义标识符的自留地。下面是 Go 语言当前版本定义里的所有预定义标识符。</p><img src="/notes/assets/identifier.f41adce7.png"><p>由于这些预定义标识符位于包代码块的外层，它们的作用域也是范围最大的。值得注意的是，这些预定义标识符不是关键字，我们同样可以再内层代码块中声明同名的标识符。</p><p>宇宙代码块里存在预定义标识符，在宇宙代码块的下一层是包代码块。包顶层声明中的常量、类型、变量或函数对应的标识符的作用域就是包代码块。</p><p>对于作用域为包代码块的标识符，我们还需要知道一个特殊情况。那就是当一个包 A 导入另外一个包 B 后，包 A 仅可以使用被导入包包 B 中的导出标识符（Exported Identifier）。</p><p>按照 Go 语言定义，一个标识符要成为导出标识符需要同时具备两个条件：一是这个标识符在包代码块中，或者它是一个字段名或方法名；二是它名字第一个字符是一个大写的 Unicode 字符。这两个条件缺一不可。</p><p>大部分在包顶层声明的标识符都具有包代码块范围的作用域，导入的包名也具有包代码块范围的作用域。如果一个包 A 有两个源文件要实现，而且这两个源文件中的代码都依赖包 B 中的代码，那么这两个源文件都需要导入 B。</p><p>在源文件层面，去掉拥有包代码块作用域的标识符后，剩余的就是一个个函数/方法的实现。在这些函数/方法体中，标识符作用域划分原则更加简单，我们可以凭借肉眼可见的、配对的大括号来明确界定一个标识符的作用域范围。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> (t T) </span><span style="color:#B392F0;">M1</span><span style="color:#E1E4E8;">(x </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;">) (err </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// 代码块1</span></span>
<span class="line"><span style="color:#E1E4E8;">	m </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">13</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// 代码块1是包含m、t、x和err三个标识符的最内部代码块</span></span>
<span class="line"><span style="color:#E1E4E8;">	{ </span><span style="color:#6A737D;">// 代码块2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// &quot;代码块2&quot;是包含类型bar标识符的最内部的那个包含代码块</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">bar</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">struct</span><span style="color:#E1E4E8;">{} </span><span style="color:#6A737D;">// 类型标识符bar的作用域始于此</span></span>
<span class="line"><span style="color:#E1E4E8;">		{                 </span><span style="color:#6A737D;">// 代码块3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;">// &quot;代码块3&quot;是包含变量a标识符的最内部的那个包含代码块</span></span>
<span class="line"><span style="color:#E1E4E8;">			a </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">5</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// a作用域开始于此</span></span>
<span class="line"><span style="color:#E1E4E8;">			{      </span><span style="color:#6A737D;">// 代码块4</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#6A737D;">//... ...</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">			</span><span style="color:#6A737D;">// a作用域终止于此</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 类型标识符bar的作用域终止于此</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#6A737D;">// m、t、x和err的作用域终止于此</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> (t T) </span><span style="color:#6F42C1;">M1</span><span style="color:#24292E;">(x </span><span style="color:#D73A49;">int</span><span style="color:#24292E;">) (err </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// 代码块1</span></span>
<span class="line"><span style="color:#24292E;">	m </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">13</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// 代码块1是包含m、t、x和err三个标识符的最内部代码块</span></span>
<span class="line"><span style="color:#24292E;">	{ </span><span style="color:#6A737D;">// 代码块2</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// &quot;代码块2&quot;是包含类型bar标识符的最内部的那个包含代码块</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">bar</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">struct</span><span style="color:#24292E;">{} </span><span style="color:#6A737D;">// 类型标识符bar的作用域始于此</span></span>
<span class="line"><span style="color:#24292E;">		{                 </span><span style="color:#6A737D;">// 代码块3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;">// &quot;代码块3&quot;是包含变量a标识符的最内部的那个包含代码块</span></span>
<span class="line"><span style="color:#24292E;">			a </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">5</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// a作用域开始于此</span></span>
<span class="line"><span style="color:#24292E;">			{      </span><span style="color:#6A737D;">// 代码块4</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6A737D;">//... ...</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">			</span><span style="color:#6A737D;">// a作用域终止于此</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 类型标识符bar的作用域终止于此</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#6A737D;">// m、t、x和err的作用域终止于此</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们可以看到，上面示例中定义了类型 T 的一个方法 M1，方法接收器（receiver）变量 t、函数参数 x，以及返回值变量 err 对应的标识符的作用域范围 M1 函数体对应的显式代码块 1。虽然 t、x 和 err 并没有被函数体的大括号显式包裹，但它们也属于函数定义的一部分，作用域仍然是代码块 1。</p><p>说完函数体外部的函数参数、返回值等元素的作用域后，下面我们来分析函数体内部的那些语法元素。</p><p>函数内部声明的常量或变量对应的标识符的作用域范围开始于常量或变量声明语句的末尾，并终止于其最内部的那个包含块的末尾。在上述例子中，变量 m、自定义类型 bar 以及在代码块 3 中声明的变量 a 均符合这个划分规则。</p><p>下面，我们再来看看位于控制语句隐式代码块中的标识符的作用域划分。我们以 if 条件分支语句为例来分析一下：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">bar</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">; </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">; </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> c </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">; </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#79B8FF;">println</span><span style="color:#E1E4E8;">(a, b, c)</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">bar</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">; </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">; </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> c </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">; </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#005CC5;">println</span><span style="color:#24292E;">(a, b, c)</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>这是一个 “if - else - if -else&quot; 条件分支语句，根据我们前面讲过的隐式代码块规则，我们将上面示例中隐式代码块转换为显式代码块，可以得到下面这段等价代码。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">bar</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	{ </span><span style="color:#6A737D;">// 等价于第一个if的隐式代码块</span></span>
<span class="line"><span style="color:#E1E4E8;">		a </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 变量a作用域始于此</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">		} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">			{ </span><span style="color:#6A737D;">// 等价于第一个else if的隐式代码块</span></span>
<span class="line"><span style="color:#E1E4E8;">				b </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 变量b的作用域始于此</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">				} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">					{ </span><span style="color:#6A737D;">// 等价于第二个else if的隐式代码块</span></span>
<span class="line"><span style="color:#E1E4E8;">						c </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;"> </span><span style="color:#6A737D;">// 变量c作用域始于此</span></span>
<span class="line"><span style="color:#E1E4E8;">						</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">false</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">						} </span><span style="color:#F97583;">else</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">							</span><span style="color:#79B8FF;">println</span><span style="color:#E1E4E8;">(a, b, c)</span></span>
<span class="line"><span style="color:#E1E4E8;">						}</span></span>
<span class="line"><span style="color:#E1E4E8;">						</span><span style="color:#6A737D;">// 变量c的作用域终止于此</span></span>
<span class="line"><span style="color:#E1E4E8;">					}</span></span>
<span class="line"><span style="color:#E1E4E8;">				}</span></span>
<span class="line"><span style="color:#E1E4E8;">				</span><span style="color:#6A737D;">// 变量b的作用域终止于此</span></span>
<span class="line"><span style="color:#E1E4E8;">			}</span></span>
<span class="line"><span style="color:#E1E4E8;">		}</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#6A737D;">// 变量a作用域终止于此</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">bar</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	{ </span><span style="color:#6A737D;">// 等价于第一个if的隐式代码块</span></span>
<span class="line"><span style="color:#24292E;">		a </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 变量a作用域始于此</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">		} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">			{ </span><span style="color:#6A737D;">// 等价于第一个else if的隐式代码块</span></span>
<span class="line"><span style="color:#24292E;">				b </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 变量b的作用域始于此</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">				} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">					{ </span><span style="color:#6A737D;">// 等价于第二个else if的隐式代码块</span></span>
<span class="line"><span style="color:#24292E;">						c </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">3</span><span style="color:#24292E;"> </span><span style="color:#6A737D;">// 变量c作用域始于此</span></span>
<span class="line"><span style="color:#24292E;">						</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">false</span><span style="color:#24292E;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">						} </span><span style="color:#D73A49;">else</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">							</span><span style="color:#005CC5;">println</span><span style="color:#24292E;">(a, b, c)</span></span>
<span class="line"><span style="color:#24292E;">						}</span></span>
<span class="line"><span style="color:#24292E;">						</span><span style="color:#6A737D;">// 变量c的作用域终止于此</span></span>
<span class="line"><span style="color:#24292E;">					}</span></span>
<span class="line"><span style="color:#24292E;">				}</span></span>
<span class="line"><span style="color:#24292E;">				</span><span style="color:#6A737D;">// 变量b的作用域终止于此</span></span>
<span class="line"><span style="color:#24292E;">			}</span></span>
<span class="line"><span style="color:#24292E;">		}</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#6A737D;">// 变量a作用域终止于此</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们可以看到，经过转换，各个声明在 if 表达式中的变量的作用域就变得一目了然了。声明于不同层次的隐式代码块中的变量 a、b 和 c 的实际作用域都位于最内层的 else 显式代码块之外，所以在 println 的显示代码块中，变量 a、b、c 都是合法的，并且还保持初始值。</p><p>到这里我们已经了解代码块与作用域的概念和规则，那么我们应该如何利用这些知识避免在实际编码中的变量遮蔽问题呢？</p><h3 id="避免变量遮蔽的原则" tabindex="-1">避免变量遮蔽的原则 <a class="header-anchor" href="#避免变量遮蔽的原则" aria-label="Permalink to &quot;避免变量遮蔽的原则&quot;">​</a></h3><p>变量是标识符的一种，我们前面说的标识符的作用域规则同样适用于变量。</p><p>变量遮蔽问题的根本原因，就是内层代码块中声明了一个与外层代码块同名且同类型的变量。这样，内层代码块中的同名变量就会替代那个外层变量，参与此层代码块内的计算，也就是内层变量遮蔽了外层同名变量。</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">package</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> (</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">errors</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#9ECBFF;">&quot;</span><span style="color:#B392F0;">fmt</span><span style="color:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> a </span><span style="color:#F97583;">int</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2020</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">checkYear</span><span style="color:#E1E4E8;">() </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">	err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> errors.</span><span style="color:#79B8FF;">New</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;wrong year&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">switch</span><span style="color:#E1E4E8;"> a, err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">getYear</span><span style="color:#E1E4E8;">(); a {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2020</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">		fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;it is&quot;</span><span style="color:#E1E4E8;">, a, err)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">case</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2021</span><span style="color:#E1E4E8;">:</span></span>
<span class="line"><span style="color:#E1E4E8;">		fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;it is&quot;</span><span style="color:#E1E4E8;">, a)</span></span>
<span class="line"><span style="color:#E1E4E8;">		err </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;after check, it is&quot;</span><span style="color:#E1E4E8;">, a)</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> err</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">new</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">int</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">getYear</span><span style="color:#E1E4E8;">() (new, </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">var</span><span style="color:#E1E4E8;"> b </span><span style="color:#F97583;">int16</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">2021</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">new</span><span style="color:#E1E4E8;">(b), </span><span style="color:#79B8FF;">nil</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">func</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">main</span><span style="color:#E1E4E8;">() {</span></span>
<span class="line"><span style="color:#E1E4E8;">	err </span><span style="color:#F97583;">:=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">checkYear</span><span style="color:#E1E4E8;">()</span></span>
<span class="line"><span style="color:#E1E4E8;">	</span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> err </span><span style="color:#F97583;">!=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nil</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">		fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;call checkYear error:&quot;</span><span style="color:#E1E4E8;">, err)</span></span>
<span class="line"><span style="color:#E1E4E8;">		</span><span style="color:#F97583;">return</span></span>
<span class="line"><span style="color:#E1E4E8;">	}</span></span>
<span class="line"><span style="color:#E1E4E8;">	fmt.</span><span style="color:#79B8FF;">Println</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&quot;call checkYear ok&quot;</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">package</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> (</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">errors</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#032F62;">&quot;</span><span style="color:#6F42C1;">fmt</span><span style="color:#032F62;">&quot;</span></span>
<span class="line"><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">var</span><span style="color:#24292E;"> a </span><span style="color:#D73A49;">int</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2020</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">checkYear</span><span style="color:#24292E;">() </span><span style="color:#D73A49;">error</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">	err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> errors.</span><span style="color:#005CC5;">New</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;wrong year&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">switch</span><span style="color:#24292E;"> a, err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">getYear</span><span style="color:#24292E;">(); a {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2020</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">		fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;it is&quot;</span><span style="color:#24292E;">, a, err)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">case</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2021</span><span style="color:#24292E;">:</span></span>
<span class="line"><span style="color:#24292E;">		fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;it is&quot;</span><span style="color:#24292E;">, a)</span></span>
<span class="line"><span style="color:#24292E;">		err </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;after check, it is&quot;</span><span style="color:#24292E;">, a)</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> err</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">new</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">int</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">getYear</span><span style="color:#24292E;">() (new, </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">var</span><span style="color:#24292E;"> b </span><span style="color:#D73A49;">int16</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">2021</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">new</span><span style="color:#24292E;">(b), </span><span style="color:#005CC5;">nil</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">func</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">main</span><span style="color:#24292E;">() {</span></span>
<span class="line"><span style="color:#24292E;">	err </span><span style="color:#D73A49;">:=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">checkYear</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">	</span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> err </span><span style="color:#D73A49;">!=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nil</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">		fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;call checkYear error:&quot;</span><span style="color:#24292E;">, err)</span></span>
<span class="line"><span style="color:#24292E;">		</span><span style="color:#D73A49;">return</span></span>
<span class="line"><span style="color:#24292E;">	}</span></span>
<span class="line"><span style="color:#24292E;">	fmt.</span><span style="color:#005CC5;">Println</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&quot;call checkYear ok&quot;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>我们可以运行下这个例子：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">$</span><span style="color:#F97583;">go</span><span style="color:#E1E4E8;"> run complex.</span><span style="color:#F97583;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">it is </span><span style="color:#79B8FF;">2021</span></span>
<span class="line"><span style="color:#E1E4E8;">after check, it is </span><span style="color:#79B8FF;">2020</span></span>
<span class="line"><span style="color:#E1E4E8;">call checkYear </span><span style="color:#F97583;">error</span><span style="color:#E1E4E8;">: wrong year</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">$</span><span style="color:#D73A49;">go</span><span style="color:#24292E;"> run complex.</span><span style="color:#D73A49;">go</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">it is </span><span style="color:#005CC5;">2021</span></span>
<span class="line"><span style="color:#24292E;">after check, it is </span><span style="color:#005CC5;">2020</span></span>
<span class="line"><span style="color:#24292E;">call checkYear </span><span style="color:#D73A49;">error</span><span style="color:#24292E;">: wrong year</span></span></code></pre></div><p>我们可以看到，第 26 行定义的 getYear 函数返回了正确的月份，但是 checkYear 在结尾输出 ”after check, it is 2020“，并且返回的 err 并不是 nil。</p><h4 id="遮蔽预定义标识符" tabindex="-1">遮蔽预定义标识符 <a class="header-anchor" href="#遮蔽预定义标识符" aria-label="Permalink to &quot;遮蔽预定义标识符&quot;">​</a></h4><p>位于第 18 行的 new，是 Go 语言里的一个预定义标识符。但是在上面的示例代码中，我们使用 new 这个名字定义了一个新类型，于是 new 这个标识符就被遮蔽了。如果这时我们在 main 函数下方放上下面代码：</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-6b87e69f data-v-ef5dee53><!--[--><!--]--><!----><nav class="prev-next" data-v-ef5dee53><div class="pager" data-v-ef5dee53><a class="pager-link prev" href="/notes/git/index.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Previous page</span><span class="title" data-v-ef5dee53>git</span></a></div><div class="pager" data-v-ef5dee53><a class="pager-link next" href="/notes/go/plus/index.html" data-v-ef5dee53><span class="desc" data-v-ef5dee53>Next page</span><span class="title" data-v-ef5dee53>plus</span></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><footer class="VPFooter has-sidebar" data-v-5a346dfe data-v-e03eb2e1><div class="container" data-v-e03eb2e1><!----><p class="copyright" data-v-e03eb2e1>Copyright © 2023-月落 版权所有</p></div></footer><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"arch_node_index.md\":\"2b435a53\",\"arch_pattern_index.md\":\"ee7ebab4\",\"books_nodejs_index.md\":\"ed2eb457\",\"alg_review_index.md\":\"a144b19c\",\"ecma_script_loss_of_precision_index.md\":\"672b0c7c\",\"amo_index.md\":\"08a8955c\",\"arch_design_index.md\":\"67c0b663\",\"ecma_script_es_module_index.md\":\"d6d9c88e\",\"ecma_script_closure_index.md\":\"ccf22442\",\"arch_domain_index.md\":\"5b830dc4\",\"crawler_tuling_index.md\":\"165473b9\",\"fragment_case_index.md\":\"788309fc\",\"ecma_script_optimize_index.md\":\"c3deb558\",\"micro_frontends_base_index.md\":\"3944e26c\",\"jest_index.md\":\"a1401619\",\"node_koa_index.md\":\"786b1c56\",\"vue_vue_source_design_index.md\":\"5c21951f\",\"html5_interview_index.md\":\"952f3c0c\",\"jenkins_practice_index.md\":\"26c00638\",\"network_plus_index.md\":\"908ddbcd\",\"html5_canvas_index.md\":\"62e268dc\",\"doc_index.md\":\"e2e05264\",\"ecma_script_front_end_optimize_index.md\":\"a30c7f62\",\"node_plus_index.md\":\"7342ba20\",\"webpack_webpack_index.md\":\"b8b58c35\",\"jenkins_jenkins2.x_index.md\":\"ce700668\",\"npm_base_index.md\":\"ef89fc75\",\"npm_repos_index.md\":\"0f2f0bf7\",\"vue_vue_router_plus_index.md\":\"dd90a709\",\"openai_langchain_index.md\":\"a53557d9\",\"node_tars_index.md\":\"496c9724\",\"test_index.md\":\"8219626b\",\"mysql_plus_index.md\":\"935a87ce\",\"vue_vue_cli_index.md\":\"03bcb498\",\"vue_vue_vite_index.md\":\"1cda5f4b\",\"webpack_webpack_write_index.md\":\"a588b543\",\"fragment_index.md\":\"39ab828e\",\"interview_index.md\":\"6d2819ea\",\"css3_index.md\":\"deea6ef4\",\"electron_combat_index.md\":\"b33b615a\",\"go_base_index.md\":\"a38ba4ed\",\"eslint_index.md\":\"2d326034\",\"ecma_script_promise_index.md\":\"b2b48d27\",\"vue_vue3_source_design_index.md\":\"9803281a\",\"node_native-module_index.md\":\"6056c507\",\"hand_writing_vue_source_index.md\":\"94be7517\",\"typescript_challenges_index.md\":\"d21e9068\",\"git_index.md\":\"9824e072\",\"webpack_webpack_5_index.md\":\"389e7a30\",\"vue_vue3_index.md\":\"07d59b5a\",\"typescript_examples_index.md\":\"e673153a\",\"arch_docker_index.md\":\"9a24fe19\",\"node_base_index.md\":\"6182d2f6\",\"micro_frontends_source_index.md\":\"08e29a45\",\"vue_vue_ssr_index.md\":\"893bd76f\",\"react_form_optimize_index.md\":\"b2e2cf79\",\"react_react_source_index.md\":\"af49c5c2\",\"openai_proxy_index.md\":\"e11f7078\",\"react_css_in_js_index.md\":\"53e4a3be\",\"typescript_declaration_index.md\":\"bec01d85\",\"books_浏览器工作原理与实践_index.md\":\"cf8009c4\",\"react_react_hooks_index.md\":\"13e5f36d\",\"superset_index.md\":\"e6ef234c\",\"react_chakra_ui_index.md\":\"7fcd656f\",\"micro_frontends_module_federation_index.md\":\"d471d169\",\"typescript_base_index.md\":\"a536d6eb\",\"alg_leetcode75_index.md\":\"cd18b558\",\"reg_learn_index.md\":\"527ae163\",\"react_formik_index.md\":\"881d9640\",\"vue_vue3_diff_index.md\":\"4445d414\",\"nginx_index.md\":\"955ccd54\",\"vue_vue_router_index.md\":\"c8804350\",\"vscode_index.md\":\"d78ac8d5\",\"html5_base_index.md\":\"3468ecd0\",\"node_expand_index.md\":\"ddacf01a\",\"network_base_index.md\":\"a1f952ef\",\"books_mdn_array_index.md\":\"987e714f\",\"alg_javascript_index.md\":\"d35cdb17\",\"ecma_script_built_in_objects_index.md\":\"d0fbd179\",\"index.md\":\"bfefab98\",\"vite_vite_source_index.md\":\"6ccff9ce\",\"books_图解http_index.md\":\"287412fe\",\"react_optimize_index.md\":\"58e3e02f\",\"micro_frontends_module_federation_example_index.md\":\"9aebb424\",\"react_mobx_index.md\":\"301e0314\",\"bom_index.md\":\"23043b7c\",\"go_plus_index.md\":\"a938f496\",\"vue_vue3_renderer_index.md\":\"1429eeaa\",\"crawler_night_team_index.md\":\"4baae605\",\"electron_base_index.md\":\"4bfa873a\",\"react_virtual_dom_index.md\":\"9012fb7b\",\"ecma_script_optimize_design_patterns_index.md\":\"a70fed2e\",\"solid_learn_index.md\":\"45ada44b\",\"react_fiber_index.md\":\"9cefa739\",\"dom_index.md\":\"3f1cc62f\",\"hand_writing_index.md\":\"c471827f\",\"vue_vuex_index.md\":\"1e30a674\",\"mysql_base_index.md\":\"7a54fc34\",\"engineering_index.md\":\"4e6bb711\",\"arch_typescript_index.md\":\"747caabf\",\"react_react_hooks_plus_index.md\":\"8edc9bf9\",\"alg_algorithm_index.md\":\"2ffc6580\",\"ecma_script_functional_index.md\":\"830bd101\",\"typescript_review_index.md\":\"e589df5d\",\"node_core_module_index.md\":\"ab3fcf85\",\"react_redux_index.md\":\"1c47886d\",\"solid_source_analysis_index.md\":\"4fd38508\",\"vue_vue_base_index.md\":\"219d6a6a\",\"vite_index.md\":\"73b69059\",\"vue_vue_source_index.md\":\"22d6db40\",\"alg_algorithm_google_index.md\":\"94410a36\",\"react_react_base_index.md\":\"34e11db5\",\"webpack_webpack_tencent_index.md\":\"e9979304\",\"ecma_script_base_index.md\":\"10c35832\",\"vue_vue_inteview_index.md\":\"73b1a3ad\",\"typescript_plus_index.md\":\"0a36e66a\",\"alg_training_index.md\":\"738c0e63\",\"ecma_script_es6_index.md\":\"710eeefb\",\"vue_vue_source_plus_index.md\":\"b44372c4\",\"webpack_webpack_write_plus_index.md\":\"38dcc3d9\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Personal Notes\",\"titleTemplate\":\"月落 - Personal Notes\",\"description\":\"Web Developer & JS Fancier\",\"base\":\"/notes/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"sidebar\":[{\"text\":\"alg\",\"items\":[{\"text\":\"algorithm\",\"items\":[],\"link\":\"/alg/algorithm/index.md\"},{\"text\":\"algorithm_google\",\"items\":[],\"link\":\"/alg/algorithm_google/index.md\"},{\"text\":\"javascript\",\"items\":[],\"link\":\"/alg/javascript/index.md\"},{\"text\":\"leetcode75\",\"items\":[],\"link\":\"/alg/leetcode75/index.md\"},{\"text\":\"review\",\"items\":[],\"link\":\"/alg/review/index.md\"},{\"text\":\"training\",\"items\":[],\"link\":\"/alg/training/index.md\"}]},{\"text\":\"amo\",\"items\":[{\"text\":\"amo\",\"link\":\"/amo/index.md\"}],\"link\":\"/amo/index.md\"},{\"text\":\"arch\",\"items\":[{\"text\":\"design\",\"items\":[],\"link\":\"/arch/design/index.md\"},{\"text\":\"docker\",\"items\":[],\"link\":\"/arch/docker/index.md\"},{\"text\":\"domain\",\"items\":[],\"link\":\"/arch/domain/index.md\"},{\"text\":\"node\",\"items\":[],\"link\":\"/arch/node/index.md\"},{\"text\":\"pattern\",\"items\":[],\"link\":\"/arch/pattern/index.md\"},{\"text\":\"typescript\",\"items\":[],\"link\":\"/arch/typescript/index.md\"}]},{\"text\":\"bom\",\"items\":[{\"text\":\"bom\",\"link\":\"/bom/index.md\"}],\"link\":\"/bom/index.md\"},{\"text\":\"books\",\"items\":[{\"text\":\"MDN\",\"items\":[{\"text\":\"Array\",\"items\":[],\"link\":\"/books/MDN/Array/index.md\"}]},{\"text\":\"Nodejs\",\"items\":[],\"link\":\"/books/Nodejs/index.md\"},{\"text\":\"图解HTTP\",\"items\":[],\"link\":\"/books/图解HTTP/index.md\"},{\"text\":\"浏览器工作原理与实践\",\"items\":[],\"link\":\"/books/浏览器工作原理与实践/index.md\"}]},{\"text\":\"crawler\",\"items\":[{\"text\":\"night_team\",\"items\":[],\"link\":\"/crawler/night_team/index.md\"},{\"text\":\"tuling\",\"items\":[],\"link\":\"/crawler/tuling/index.md\"}]},{\"text\":\"css3\",\"items\":[{\"text\":\"css3\",\"link\":\"/css3/index.md\"}],\"link\":\"/css3/index.md\"},{\"text\":\"doc\",\"items\":[{\"text\":\"doc\",\"link\":\"/doc/index.md\"}],\"link\":\"/doc/index.md\"},{\"text\":\"dom\",\"items\":[{\"text\":\"dom\",\"link\":\"/dom/index.md\"}],\"link\":\"/dom/index.md\"},{\"text\":\"ecma_script\",\"items\":[{\"text\":\"Built_in_objects\",\"items\":[],\"link\":\"/ecma_script/Built_in_objects/index.md\"},{\"text\":\"base\",\"items\":[],\"link\":\"/ecma_script/base/index.md\"},{\"text\":\"closure\",\"items\":[],\"link\":\"/ecma_script/closure/index.md\"},{\"text\":\"es6\",\"items\":[],\"link\":\"/ecma_script/es6/index.md\"},{\"text\":\"es_module\",\"items\":[],\"link\":\"/ecma_script/es_module/index.md\"},{\"text\":\"front_end_optimize\",\"items\":[],\"link\":\"/ecma_script/front_end_optimize/index.md\"},{\"text\":\"functional\",\"items\":[],\"link\":\"/ecma_script/functional/index.md\"},{\"text\":\"loss_of_precision\",\"items\":[],\"link\":\"/ecma_script/loss_of_precision/index.md\"},{\"text\":\"optimize\",\"items\":[],\"link\":\"/ecma_script/optimize/index.md\"},{\"text\":\"optimize_design_patterns\",\"items\":[],\"link\":\"/ecma_script/optimize_design_patterns/index.md\"},{\"text\":\"promise\",\"items\":[],\"link\":\"/ecma_script/promise/index.md\"}]},{\"text\":\"electron\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/electron/base/index.md\"},{\"text\":\"combat\",\"items\":[],\"link\":\"/electron/combat/index.md\"}]},{\"text\":\"engineering\",\"items\":[{\"text\":\"engineering\",\"link\":\"/engineering/index.md\"},{\"text\":\"gulp\"},{\"text\":\"yeoman\"}],\"link\":\"/engineering/index.md\"},{\"text\":\"eslint\",\"items\":[{\"text\":\"eslint\",\"link\":\"/eslint/index.md\"}],\"link\":\"/eslint/index.md\"},{\"text\":\"fragment\",\"items\":[{\"text\":\"fragment\",\"link\":\"/fragment/index.md\"},{\"text\":\"case\",\"items\":[],\"link\":\"/fragment/case/index.md\"}],\"link\":\"/fragment/index.md\"},{\"text\":\"git\",\"items\":[{\"text\":\"git\",\"link\":\"/git/index.md\"}],\"link\":\"/git/index.md\"},{\"text\":\"go\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/go/base/index.md\"},{\"text\":\"plus\",\"items\":[],\"link\":\"/go/plus/index.md\"}]},{\"text\":\"hand_writing\",\"items\":[{\"text\":\"hand_writing\",\"link\":\"/hand_writing/index.md\"},{\"text\":\"vue_source\",\"items\":[],\"link\":\"/hand_writing/vue_source/index.md\"}],\"link\":\"/hand_writing/index.md\"},{\"text\":\"html5\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/html5/base/index.md\"},{\"text\":\"canvas\",\"items\":[],\"link\":\"/html5/canvas/index.md\"},{\"text\":\"interview\",\"items\":[],\"link\":\"/html5/interview/index.md\"}]},{\"text\":\"interview\",\"items\":[{\"text\":\"interview\",\"link\":\"/interview/index.md\"}],\"link\":\"/interview/index.md\"},{\"text\":\"jenkins\",\"items\":[{\"text\":\"jenkins2.x\",\"items\":[],\"link\":\"/jenkins/jenkins2.x/index.md\"},{\"text\":\"practice\",\"items\":[],\"link\":\"/jenkins/practice/index.md\"}]},{\"text\":\"jest\",\"items\":[{\"text\":\"jest\",\"link\":\"/jest/index.md\"}],\"link\":\"/jest/index.md\"},{\"text\":\"micro_frontends\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/micro_frontends/base/index.md\"},{\"text\":\"module_federation\",\"items\":[],\"link\":\"/micro_frontends/module_federation/index.md\"},{\"text\":\"module_federation_example\",\"items\":[],\"link\":\"/micro_frontends/module_federation_example/index.md\"},{\"text\":\"source\",\"items\":[],\"link\":\"/micro_frontends/source/index.md\"}]},{\"text\":\"mysql\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/mysql/base/index.md\"},{\"text\":\"plus\",\"items\":[],\"link\":\"/mysql/plus/index.md\"}]},{\"text\":\"network\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/network/base/index.md\"},{\"text\":\"plus\",\"items\":[],\"link\":\"/network/plus/index.md\"}]},{\"text\":\"nginx\",\"items\":[{\"text\":\"nginx\",\"link\":\"/nginx/index.md\"}],\"link\":\"/nginx/index.md\"},{\"text\":\"node\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/node/base/index.md\"},{\"text\":\"core_module\",\"items\":[],\"link\":\"/node/core_module/index.md\"},{\"text\":\"expand\",\"items\":[],\"link\":\"/node/expand/index.md\"},{\"text\":\"koa\",\"items\":[],\"link\":\"/node/koa/index.md\"},{\"text\":\"native-module\",\"items\":[],\"link\":\"/node/native-module/index.md\"},{\"text\":\"plus\",\"items\":[],\"link\":\"/node/plus/index.md\"},{\"text\":\"tars\",\"items\":[],\"link\":\"/node/tars/index.md\"}]},{\"text\":\"npm\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/npm/base/index.md\"},{\"text\":\"repos\",\"items\":[],\"link\":\"/npm/repos/index.md\"}]},{\"text\":\"openai\",\"items\":[{\"text\":\"langchain\",\"items\":[],\"link\":\"/openai/langchain/index.md\"},{\"text\":\"proxy\",\"items\":[],\"link\":\"/openai/proxy/index.md\"}]},{\"text\":\"react\",\"items\":[{\"text\":\"Fiber\",\"items\":[],\"link\":\"/react/Fiber/index.md\"},{\"text\":\"chakra_ui\",\"items\":[],\"link\":\"/react/chakra_ui/index.md\"},{\"text\":\"css_in_js\",\"items\":[],\"link\":\"/react/css_in_js/index.md\"},{\"text\":\"form_optimize\",\"items\":[],\"link\":\"/react/form_optimize/index.md\"},{\"text\":\"formik\",\"items\":[],\"link\":\"/react/formik/index.md\"},{\"text\":\"mobx\",\"items\":[],\"link\":\"/react/mobx/index.md\"},{\"text\":\"optimize\",\"items\":[],\"link\":\"/react/optimize/index.md\"},{\"text\":\"react_base\",\"items\":[],\"link\":\"/react/react_base/index.md\"},{\"text\":\"react_hooks\",\"items\":[],\"link\":\"/react/react_hooks/index.md\"},{\"text\":\"react_hooks_plus\",\"items\":[],\"link\":\"/react/react_hooks_plus/index.md\"},{\"text\":\"react_source\",\"items\":[],\"link\":\"/react/react_source/index.md\"},{\"text\":\"redux\",\"items\":[],\"link\":\"/react/redux/index.md\"},{\"text\":\"virtual_dom\",\"items\":[],\"link\":\"/react/virtual_dom/index.md\"}]},{\"text\":\"reg\",\"items\":[{\"text\":\"learn\",\"items\":[],\"link\":\"/reg/learn/index.md\"}]},{\"text\":\"solid\",\"items\":[{\"text\":\"learn\",\"items\":[],\"link\":\"/solid/learn/index.md\"},{\"text\":\"source_analysis\",\"items\":[],\"link\":\"/solid/source_analysis/index.md\"}]},{\"text\":\"superset\",\"items\":[{\"text\":\"superset\",\"link\":\"/superset/index.md\"}],\"link\":\"/superset/index.md\"},{\"text\":\"test\",\"items\":[{\"text\":\"test\",\"link\":\"/test/index.md\"}],\"link\":\"/test/index.md\"},{\"text\":\"typescript\",\"items\":[{\"text\":\"base\",\"items\":[],\"link\":\"/typescript/base/index.md\"},{\"text\":\"challenges\",\"items\":[],\"link\":\"/typescript/challenges/index.md\"},{\"text\":\"declaration\",\"items\":[],\"link\":\"/typescript/declaration/index.md\"},{\"text\":\"examples\",\"items\":[],\"link\":\"/typescript/examples/index.md\"},{\"text\":\"plus\",\"items\":[],\"link\":\"/typescript/plus/index.md\"},{\"text\":\"review\",\"items\":[],\"link\":\"/typescript/review/index.md\"}]},{\"text\":\"vite\",\"items\":[{\"text\":\"vite\",\"link\":\"/vite/index.md\"},{\"text\":\"vite_source\",\"items\":[],\"link\":\"/vite/vite_source/index.md\"}],\"link\":\"/vite/index.md\"},{\"text\":\"vscode\",\"items\":[{\"text\":\"vscode\",\"link\":\"/vscode/index.md\"}],\"link\":\"/vscode/index.md\"},{\"text\":\"vue\",\"items\":[{\"text\":\"vue3\",\"items\":[],\"link\":\"/vue/vue3/index.md\"},{\"text\":\"vue3_diff\",\"items\":[],\"link\":\"/vue/vue3_diff/index.md\"},{\"text\":\"vue3_renderer\",\"items\":[],\"link\":\"/vue/vue3_renderer/index.md\"},{\"text\":\"vue3_source_design\",\"items\":[],\"link\":\"/vue/vue3_source_design/index.md\"},{\"text\":\"vue_base\",\"items\":[],\"link\":\"/vue/vue_base/index.md\"},{\"text\":\"vue_cli\",\"items\":[],\"link\":\"/vue/vue_cli/index.md\"},{\"text\":\"vue_inteview\",\"items\":[],\"link\":\"/vue/vue_inteview/index.md\"},{\"text\":\"vue_router\",\"items\":[],\"link\":\"/vue/vue_router/index.md\"},{\"text\":\"vue_router_plus\",\"items\":[],\"link\":\"/vue/vue_router_plus/index.md\"},{\"text\":\"vue_source\",\"items\":[],\"link\":\"/vue/vue_source/index.md\"},{\"text\":\"vue_source_design\",\"items\":[],\"link\":\"/vue/vue_source_design/index.md\"},{\"text\":\"vue_source_plus\",\"items\":[],\"link\":\"/vue/vue_source_plus/index.md\"},{\"text\":\"vue_ssr\",\"items\":[],\"link\":\"/vue/vue_ssr/index.md\"},{\"text\":\"vue_vite\",\"items\":[],\"link\":\"/vue/vue_vite/index.md\"},{\"text\":\"vuex\",\"items\":[],\"link\":\"/vue/vuex/index.md\"}]},{\"text\":\"webpack\",\"items\":[{\"text\":\"webpack\",\"items\":[],\"link\":\"/webpack/webpack/index.md\"},{\"text\":\"webpack_5\",\"items\":[],\"link\":\"/webpack/webpack_5/index.md\"},{\"text\":\"webpack_npm_source\"},{\"text\":\"webpack_tencent\",\"items\":[],\"link\":\"/webpack/webpack_tencent/index.md\"},{\"text\":\"webpack_write\",\"items\":[],\"link\":\"/webpack/webpack_write/index.md\"},{\"text\":\"webpack_write_plus\",\"items\":[],\"link\":\"/webpack/webpack_write_plus/index.md\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/yzqzy\"}],\"footer\":{\"copyright\":\"Copyright © 2023-月落 版权所有\"},\"outline\":\"deep\"},\"locales\":{},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>